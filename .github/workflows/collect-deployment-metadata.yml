name: "Collect Deployment Metadata"

on:
  workflow_run:
    workflows:
      - "Deploy Live App to GitHub Pages"
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: "Workflow run ID to ingest (from deploy-to-pages-live)"
        required: false
        type: string

concurrency:
  group: "collect-deployments-${{ github.run_id }}"
  cancel-in-progress: false

permissions:
  contents: write
  actions: read

jobs:
  collect:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "Resolve source run"
        id: resolve-run
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.inputs.run_id }}" ]; then
            echo "run_id=${{ github.event.inputs.run_id }}" >> $GITHUB_OUTPUT
          else
            echo "No run_id provided for manual ingestion" >&2
            exit 1
          fi

      - name: "Download deployment metadata artifact"
        uses: actions/download-artifact@v4
        with:
          name: app-deployment
          path: app-deployment
          run-id: ${{ steps.resolve-run.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Install Python dependencies"
        run: pip install --disable-pip-version-check pyyaml

      - name: "Merge deployment metadata"
        id: merge
        run: |
          set -euo pipefail
          python <<'PY'
import json
import yaml
from pathlib import Path
from datetime import datetime

artifact_path = Path("app-deployment/deployment-metadata.json")
if not artifact_path.exists():
    raise SystemExit("deployment-metadata.json not found in artifact")

with artifact_path.open() as f:
    new_entry = json.load(f)

# Normalize timestamp
if "last_updated" not in new_entry or not new_entry["last_updated"]:
    new_entry["last_updated"] = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")

# Load existing deployments
output_path = Path("docs/_data/app-deployments.yml")
output_path.parent.mkdir(parents=True, exist_ok=True)

if output_path.exists():
    with output_path.open() as f:
        existing = yaml.safe_load(f) or []
else:
    existing = []

# Replace or append entry by repository + strategy
key_fields = (new_entry.get("repository"), new_entry.get("deployment_strategy"))
updated = False
for idx, entry in enumerate(existing):
    if (entry.get("repository"), entry.get("deployment_strategy")) == key_fields:
        if entry != new_entry:
            existing[idx] = new_entry
            updated = True
        break
else:
    existing.append(new_entry)
    updated = True

# Sort for stability
existing.sort(key=lambda e: (e.get("repository", ""), e.get("deployment_strategy", "")))

with output_path.open("w") as f:
    yaml.safe_dump(existing, f, sort_keys=False, default_flow_style=False)

print(f"updated={updated}")

PY

      - name: "Check for changes"
        id: changes
        run: |
          git add docs/_data/app-deployments.yml
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: "Commit and push"
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update deployment metadata"
          git push

      - name: "Summary"
        if: always()
        run: |
          echo "## Deployment Metadata Collection" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "✅ Metadata updated and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
