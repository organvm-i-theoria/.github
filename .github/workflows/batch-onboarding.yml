name: Batch Repository Onboarding

on:
  workflow_dispatch:
    inputs:
      config_file:
        description: Configuration file path (relative to repo root)
        required: true
        default: src/automation/config/batch-onboard-config.yml
      dry_run:
        description: Run in dry-run mode (no changes)
        required: false
        type: boolean
        default: true
      max_concurrent:
        description: Maximum concurrent onboardings
        required: false
        default: '5'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      config-valid: ${{ steps.validate.outputs.valid }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies
      run: |
        pip install PyGithub aiohttp pyyaml

    - name: Validate configuration
      id: validate
      run: |
        CONFIG_FILE="${{ github.event.inputs.config_file }}"
        if [ -f "$CONFIG_FILE" ]; then
          echo "Configuration file found: $CONFIG_FILE"
          python -c "
        import yaml
        import sys
        try:
            with open('$CONFIG_FILE', 'r') as f:
                config = yaml.safe_load(f)
            if config is None:
                print('Error: Configuration file is empty')
                sys.exit(1)
            if 'repositories' not in config:
                print('Error: Missing required field: repositories')
                sys.exit(1)
            if not isinstance(config['repositories'], list) or len(config['repositories']) == 0:
                print('Error: No repositories specified')
                sys.exit(1)
            print(f'Configuration is valid. Found {len(config[\"repositories\"])} repositories.')
        except yaml.YAMLError as e:
            print(f'Error: Invalid YAML syntax: {e}')
            sys.exit(1)
        except Exception as e:
            print(f'Error: {e}')
            sys.exit(1)
        "
          if [ $? -eq 0 ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "⚠️ Configuration file not found: $CONFIG_FILE"
          echo "Please create the config file or specify a valid path."
          echo "Expected format:"
          echo "  repositories:"
          echo "    - name: org/repo-name"
          echo "      features: [issues, projects]"
          echo "valid=false" >> $GITHUB_OUTPUT
          exit 1
        fi

  onboard:
    name: Batch Onboard Repositories
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: validate
    if: needs.validate.outputs.config-valid == 'true'

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies
      run: |
        pip install PyGithub aiohttp pyyaml

    - name: Run batch onboarding
      id: onboard
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        DRY_RUN_FLAG=""
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          DRY_RUN_FLAG="--dry-run"
        fi

        python src/automation/scripts/batch_onboard_repositories.py \
          --config "${{ github.event.inputs.config_file }}" \
          --max-concurrent "${{ github.event.inputs.max_concurrent }}" \
          --output onboarding_results.json \
          $DRY_RUN_FLAG

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: onboarding-results
        path: onboarding_results.json
        retention-days: 30

    - name: Generate summary
      if: always()
      env:
        RUN_MODE: ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Live' }}
      run: |
        python -c "
        import json
        import os
        import sys

        with open('onboarding_results.json', 'r') as f:
            results = json.load(f)

        total = len(results)
        successful = sum(1 for r in results if r['success'])
        failed = total - successful

        run_mode = os.environ.get('RUN_MODE', 'Unknown')
        print(f'## Batch Onboarding Summary')
        print(f'')
        print(f'- **Total repositories:** {total}')
        print(f'- **Successful:** {successful}')
        print(f'- **Failed:** {failed}')
        print(f'- **Mode:** {run_mode}')
        print(f'')

        if failed > 0:
            print(f'### Failed Repositories')
            print(f'')
            for result in results:
                if not result['success']:
                    print(f'- **{result[\"repository\"]}:** {result[\"error\"]}')
                    print(f'  - Steps completed: {len(result[\"steps_completed\"])}')
                    print(f'  - Duration: {result[\"duration_seconds\"]:.2f}s')

        if successful > 0:
            print(f'')
            print(f'### Successful Repositories')
            print(f'')
            for result in results:
                if result['success']:
                    print(f'- ✅ **{result[\"repository\"]}** ({result[\"duration_seconds\"]:.2f}s)')

        sys.exit(1 if failed > 0 else 0)
        " >> $GITHUB_STEP_SUMMARY

    - name: Check for failures
      if: always()
      run: |
        python -c "
        import json
        import sys

        with open('onboarding_results.json', 'r') as f:
            results = json.load(f)

        failed = sum(1 for r in results if not r['success'])
        sys.exit(1 if failed > 0 else 0)
        "

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: onboard
    if: always()

    steps:
    - name: Download results
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # ratchet:actions/download-artifact@v4
      with:
        name: onboarding-results

    - name: Send notification
      if: ${{ github.event.inputs.dry_run != 'true' }}
      run: |
        # Add notification logic here (Slack, email, etc.)
        echo "Batch onboarding completed. Check workflow summary for details."
