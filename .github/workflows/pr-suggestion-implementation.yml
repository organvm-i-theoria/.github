name: PR Suggestion Implementation

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to implement suggestions for'
        required: true
        type: number

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-trigger:
    name: Check if Implementation Should Run
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
      pr-number: ${{ steps.check.outputs.pr-number }}
    
    steps:
      - name: Check Trigger
        id: check
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            let shouldRun = false;
            let prNumber = null;
            
            if (context.eventName === 'workflow_dispatch') {
              shouldRun = true;
              prNumber = ${{ github.event.inputs.pr_number || 'null' }};
            } else if (context.eventName === 'issue_comment') {
              // Check if comment is on a PR and contains trigger phrase
              if (context.payload.issue.pull_request) {
                const comment = context.payload.comment.body;
                
                // Trigger phrases
                const triggerPhrases = [
                  '/implement-suggestions',
                  '/implement-all',
                  '/auto-implement'
                ];
                
                shouldRun = triggerPhrases.some(phrase => 
                  comment.toLowerCase().includes(phrase.toLowerCase())
                );
                
                if (shouldRun) {
                  prNumber = context.payload.issue.number;
                }
              }
            } else if (context.eventName === 'pull_request_review_comment') {
              // Auto-implement if comment has specific marker
              const comment = context.payload.comment.body;
              
              if (comment.includes('[auto-implement]') || comment.includes('[implement-this]')) {
                shouldRun = true;
                prNumber = context.payload.pull_request.number;
              }
            }
            
            console.log(`Should run: ${shouldRun}, PR: ${prNumber}`);
            
            core.setOutput('should-run', shouldRun.toString());
            core.setOutput('pr-number', prNumber ? prNumber.toString() : '');
            
            return { shouldRun, prNumber };

  implement-suggestions:
    name: Implement PR Suggestions
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should-run == 'true'
    timeout-minutes: 30
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch PR Branch
        run: |
          PR_NUM=${{ needs.check-trigger.outputs.pr-number }}
          
          echo "Fetching PR #$PR_NUM details..."
          
          # Get PR branch
          PR_BRANCH=$(gh pr view $PR_NUM --json headRefName --jq '.headRefName')
          
          echo "PR Branch: $PR_BRANCH"
          echo "PR_BRANCH=$PR_BRANCH" >> $GITHUB_ENV
          
          # Checkout PR branch
          git fetch origin $PR_BRANCH
          git checkout $PR_BRANCH
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract All Suggestions
        id: extract
        run: |
          PR_NUM=${{ needs.check-trigger.outputs.pr-number }}
          
          echo "ðŸ“ Extracting suggestions from PR #$PR_NUM..."
          
          # Get all comments and review comments
          gh api repos/${{ github.repository }}/issues/$PR_NUM/comments --paginate > issue_comments.json
          gh api repos/${{ github.repository }}/pulls/$PR_NUM/comments --paginate > review_comments.json
          
          # Extract suggestions
          echo "## Suggestions to Implement" > suggestions.md
          echo "" >> suggestions.md
          
          # Keywords that indicate actionable suggestions
          SUGGESTION_KEYWORDS="suggest|should|could|consider|recommend|might want to|please|fix|change|update|add|remove|improve"
          TODO_KEYWORDS="TODO|FIXME|BLOCKER|must fix|required|action item"
          
          # Process issue comments
          echo "### From General Comments" >> suggestions.md
          jq -r '.[] | "\(.user.login)|\(.id)|\(.body)"' issue_comments.json | while IFS='|' read -r user comment_id body; do
            # Look for suggestion patterns
            SUGGESTIONS=$(echo "$body" | grep -iE "($SUGGESTION_KEYWORDS|$TODO_KEYWORDS)" || true)
            
            if [ -n "$SUGGESTIONS" ]; then
              echo "" >> suggestions.md
              echo "#### Suggestion by @$user (comment #$comment_id)" >> suggestions.md
              echo '```' >> suggestions.md
              echo "$SUGGESTIONS" >> suggestions.md
              echo '```' >> suggestions.md
            fi
          done
          
          # Process review comments (these have file context)
          echo "" >> suggestions.md
          echo "### From Code Review Comments" >> suggestions.md
          jq -r '.[] | "\(.user.login)|\(.id)|\(.body)|\(.path)|\(.line // "N/A")"' review_comments.json | while IFS='|' read -r user comment_id body path line; do
            SUGGESTIONS=$(echo "$body" | grep -iE "($SUGGESTION_KEYWORDS|$TODO_KEYWORDS)" || true)
            
            if [ -n "$SUGGESTIONS" ]; then
              echo "" >> suggestions.md
              echo "#### Suggestion by @$user at \`$path:$line\` (comment #$comment_id)" >> suggestions.md
              echo '```' >> suggestions.md
              echo "$SUGGESTIONS" >> suggestions.md
              echo '```' >> suggestions.md
            fi
          done
          
          # Count suggestions
          SUGGESTION_COUNT=$(grep -c "^#### Suggestion by" suggestions.md || echo "0")
          
          echo "" >> suggestions.md
          echo "---" >> suggestions.md
          echo "**Total suggestions found:** $SUGGESTION_COUNT" >> suggestions.md
          
          echo "Found $SUGGESTION_COUNT suggestions"
          cat suggestions.md
          
          echo "suggestion_count=$SUGGESTION_COUNT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Implementation TODO
        if: steps.extract.outputs.suggestion_count > 0
        run: |
          PR_NUM=${{ needs.check-trigger.outputs.pr-number }}
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          
          # Create a TODO.md file in the repo
          {
            echo "# TODO: PR #$PR_NUM Implementation Tasks"
            echo ""
            echo "Generated: $TIMESTAMP"
            echo "PR: #$PR_NUM"
            echo "Status: Pending Implementation"
            echo ""
            echo "## Extracted Suggestions"
            echo ""
            cat suggestions.md
            echo ""
            echo "## Implementation Checklist"
            echo ""
            echo "- [ ] Review all suggestions"
            echo "- [ ] Prioritize implementation order"
            echo "- [ ] Implement high-priority items"
            echo "- [ ] Test changes"
            echo "- [ ] Update documentation if needed"
            echo "- [ ] Mark completed items"
            echo ""
            echo "## Notes"
            echo ""
            echo "This file was automatically generated by the PR Suggestion Implementation workflow."
            echo "Each suggestion should be reviewed and implemented as appropriate."
            echo ""
            echo "Some suggestions may be:"
            echo "- Quick fixes that can be done immediately"
            echo "- Larger refactoring that needs more planning"
            echo "- Nice-to-have improvements for future work"
            echo "- Already addressed in other commits"
            echo ""
            echo "Update this checklist as you work through the suggestions."
            echo ""
            echo "---"
            echo "_Generated by [pr-suggestion-implementation.yml](../.github/workflows/pr-suggestion-implementation.yml)_"
          } > TODO_PR_$PR_NUM.md
          
          echo "âœ… Created TODO_PR_$PR_NUM.md"
          cat TODO_PR_$PR_NUM.md

      - name: Analyze Suggestions for Auto-Implementation
        id: analyze
        if: steps.extract.outputs.suggestion_count > 0
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const suggestions = fs.readFileSync('suggestions.md', 'utf8');
            
            // Parse suggestions to identify auto-implementable ones
            // Simple heuristics for now:
            // - Typo fixes: "typo", "spelling"
            // - Simple renames: "rename X to Y"
            // - Documentation updates: "update docs", "add comment"
            
            const autoImplementable = [];
            const needsReview = [];
            
            const lines = suggestions.split('\n');
            let currentSuggestion = null;
            
            for (const line of lines) {
              if (line.startsWith('#### Suggestion by')) {
                if (currentSuggestion) {
                  // Categorize previous suggestion
                  const text = currentSuggestion.text.toLowerCase();
                  
                  if (
                    text.includes('typo') ||
                    text.includes('spelling') ||
                    text.includes('fix comment') ||
                    (text.includes('rename') && text.split(' ').length < 15)
                  ) {
                    autoImplementable.push(currentSuggestion);
                  } else {
                    needsReview.push(currentSuggestion);
                  }
                }
                
                currentSuggestion = { header: line, text: '' };
              } else if (currentSuggestion && line.trim() && !line.startsWith('```')) {
                currentSuggestion.text += line + '\n';
              }
            }
            
            // Categorize last suggestion
            if (currentSuggestion) {
              const text = currentSuggestion.text.toLowerCase();
              if (
                text.includes('typo') ||
                text.includes('spelling') ||
                text.includes('fix comment')
              ) {
                autoImplementable.push(currentSuggestion);
              } else {
                needsReview.push(currentSuggestion);
              }
            }
            
            console.log(`Auto-implementable: ${autoImplementable.length}`);
            console.log(`Needs review: ${needsReview.length}`);
            
            core.setOutput('auto-count', autoImplementable.length);
            core.setOutput('review-count', needsReview.length);
            
            return { autoImplementable, needsReview };

      - name: Commit TODO File
        if: steps.extract.outputs.suggestion_count > 0
        run: |
          PR_NUM=${{ needs.check-trigger.outputs.pr-number }}
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add TODO_PR_$PR_NUM.md
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: add TODO for PR #$PR_NUM suggestions" \
                       -m "Extracted ${{ steps.extract.outputs.suggestion_count }} suggestions from PR comments." \
                       -m "Auto-implementable: ${{ steps.analyze.outputs.auto-count }}" \
                       -m "Needs review: ${{ steps.analyze.outputs.review-count }}" \
                       -m "This TODO file tracks implementation progress for PR feedback."
            
            git push origin ${{ env.PR_BRANCH }}
            echo "âœ… Committed and pushed TODO file"
          fi

      - name: Comment on PR
        if: steps.extract.outputs.suggestion_count > 0
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = ${{ needs.check-trigger.outputs.pr-number }};
            const totalSuggestions = ${{ steps.extract.outputs.suggestion_count }};
            const autoCount = ${{ steps.analyze.outputs.auto-count || 0 }};
            const reviewCount = ${{ steps.analyze.outputs.review-count || 0 }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸ“‹ Suggestions Extracted and Tracked\n\nI've analyzed all comments and reviews on this PR and extracted ${totalSuggestions} suggestions for implementation.\n\nSummary:\n- ðŸ¤– Auto-implementable: ${autoCount} (simple fixes, typos, renames)\n- ðŸ‘€ Needs review: ${reviewCount} (complex changes requiring judgment)\n\nTODO File Created: \`TODO_PR_${prNumber}.md\`\n\nThis file contains:\n- All extracted suggestions with context\n- Implementation checklist\n- Notes and guidance\n\nNext Steps:\n1. Review the TODO file in this branch\n2. Implement suggestions as appropriate\n3. Check off completed items\n4. Simple fixes can be implemented automatically\n5. Complex changes should be reviewed before implementation\n\nTo implement a specific suggestion:\n- Comment with the suggestion text and \`[implement-this]\`\n- Or manually implement and check off in the TODO file\n\nTo implement all auto-implementable suggestions:\n- Comment: \`/implement-all\`\n\n---\n_Automated by [pr-suggestion-implementation.yml](../.github/workflows/pr-suggestion-implementation.yml)_`
            });

      - name: Add Label
        if: steps.extract.outputs.suggestion_count > 0
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = ${{ needs.check-trigger.outputs.pr-number }};
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['has-todo', 'suggestions-extracted']
            });

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“‹ Suggestion Implementation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** #${{ needs.check-trigger.outputs.pr-number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.extract.outputs.suggestion_count }}" -gt 0 ]; then
            echo "**Suggestions Found:** ${{ steps.extract.outputs.suggestion_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- Auto-implementable: ${{ steps.analyze.outputs.auto-count }}" >> $GITHUB_STEP_SUMMARY
            echo "- Needs review: ${{ steps.analyze.outputs.review-count }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… TODO file created: \`TODO_PR_${{ needs.check-trigger.outputs.pr-number }}.md\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No suggestions found in PR comments" >> $GITHUB_STEP_SUMMARY
          fi
