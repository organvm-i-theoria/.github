name: Token Health Check

on:
  schedule:
    # Run daily at 8:00 UTC
  - cron: 0 8 * * *
  workflow_dispatch:
  push:
    branches:
    - main
    paths:
    - src/automation/scripts/utils/validate-tokens.py
    - src/automation/scripts/secret_manager.py
    - .github/workflows/token-health-check.yml

jobs:
  validate-tokens:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write # For creating alerts if needed

    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c  # ratchet:actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install requests

    - name: Set up 1Password CLI
      uses: 1password/install-cli-action@9b82e19ce89f957763220d632ec1de246084f78a  # ratchet:1password/install-cli-action@v1
      if: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN != '' }}

    - name: Validate tokens
      id: validate
      env:
        OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
      run: |
        set +e  # Don't exit on error
        python3 src/automation/scripts/utils/validate-tokens.py --ignore-planned --verbose
        EXIT_CODE=$?
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        exit 0  # Don't fail workflow yet
      continue-on-error: true

    - name: Create issue on failure
      if: steps.validate.outputs.exit_code != '0' && github.event_name == 'schedule'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # ratchet:actions/github-script@v7
      with:
        script: |
          const title = '⚠️ Token Health Check Failed';
          const body = `## Token Validation Failure

          The automated token health check has detected issues with organization tokens.

          **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
          **Time:** ${new Date().toISOString()}

          ### Immediate Actions Required

          1. **Review the workflow logs** for detailed error information
          2. **Check token expiration dates** in docs/TOKEN_REGISTRY.md
          3. **Verify 1Password CLI access** is working correctly
          4. **Rotate failed tokens** if necessary

          ### Related Documentation

          - [Token Registry](docs/TOKEN_REGISTRY.md)
          - [Token Rotation Guide](docs/MASTER_ORG_TOKEN_CONTEXTUAL_AWARENESS_ANALYSIS.md#rotation-process)
          - [Emergency Procedures](docs/TOKEN_REGISTRY.md#emergency-procedures)

          ### Troubleshooting

          Run manually to debug:
          \`\`\`bash
          python3 src/automation/scripts/utils/validate-tokens.py --verbose
          \`\`\`

          ---

          **Auto-generated by Token Health Check workflow**
          `;

          // Check if an issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,automated',
            per_page: 100
          });

          const existingIssue = issues.data.find(issue =>
            issue.title === title
          );

          if (existingIssue) {
            // Add a comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `Token validation failed again at ${new Date().toISOString()}\n\nWorkflow: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
            console.log(`Added comment to existing issue #${existingIssue.number}`);
          } else {
            // Create new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated', 'token-management']
            });
            console.log(`Created issue #${issue.data.number}`);
          }

    - name: Summary
      if: always()
      run: |
        echo "## Token Health Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.validate.outputs.exit_code }}" = "0" ]; then
          echo "✅ **All tokens validated successfully**" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Token validation failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See workflow logs for details" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Documentation" >> $GITHUB_STEP_SUMMARY
        echo "- [Token Registry](docs/TOKEN_REGISTRY.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Token Analysis](docs/MASTER_ORG_TOKEN_CONTEXTUAL_AWARENESS_ANALYSIS.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Quick Action Guide](docs/MASTER_ORG_TOKEN_QUICK_ACTION.md)" >> $GITHUB_STEP_SUMMARY
