name: Build and Deploy GitHub Pages Site

on:
  # Trigger when walkthroughs are generated (via workflow_dispatch or repository_dispatch)
  repository_dispatch:
    types:
    - walkthrough-generated
    - walkthrough-updated
  # Trigger on schedule (every 6 hours)
  schedule:
  - cron: 0 */6 * * *
  # Manual trigger
  workflow_dispatch:
  # Reusable workflow support
  workflow_call:
  # Trigger on changes to Jekyll configuration or layout files
  push:
    branches:
    - main
    paths:
    - site/_config.yml
    - site/_layouts/**
    - docs/_layouts/**
    - docs/_includes/**
    - .github/workflows/build-pages-site.yml

concurrency:
  group: pages-build-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  check-site:
    runs-on: ubuntu-latest
    outputs:
      has_site: ${{ steps.check.outputs.has_site }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Check for site directory
      id: check
      run: |
        if [ -d "site" ] && [ -f "site/Gemfile" -o -f "site/_config.yml" ]; then
          echo "has_site=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Site directory found with Jekyll configuration"
        else
          echo "has_site=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No site directory or Jekyll configuration found. Skipping build."
        fi

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: check-site
    if: needs.check-site.outputs.has_site == 'true'

    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Ruby
      uses: ruby/setup-ruby@d5f787ce339eb0767271bc01d922e85644c2c8ab  # ratchet:ruby/setup-ruby@v1.280.0
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Setup Node.js
      uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # ratchet:actions/setup-node@v4
      with:
        node-version: '18'
        cache: npm
        cache-dependency-path: '**/package-lock.json'

    - name: Install dependencies
      working-directory: site
      run: |
        # Create Gemfile if it doesn't exist
        if [ ! -f "Gemfile" ]; then
          cat > Gemfile <<EOF
        source "https://rubygems.org"

        gem "jekyll", "~> 4.3"
        gem "minima", "~> 2.5"
        gem "jekyll-feed", "~> 0.17"
        gem "jekyll-seo-tag", "~> 2.8"
        gem "jekyll-sitemap", "~> 1.4"
        gem "jekyll-relative-links", "~> 0.6"
        gem "webrick", "~> 1.8"
        EOF
        fi

        bundle install

    - name: Aggregate walkthrough metadata
      id: aggregate
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üîç Aggregating walkthrough metadata from organization repositories..."

        # Create data directory if it doesn't exist
        mkdir -p docs/_data

        # Initialize walkthroughs data file
        cat > docs/_data/walkthroughs.yml <<EOF
        # Walkthrough Gallery Data
        # Auto-generated by build-pages-site workflow
        # Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EOF

        # Fetch organization repositories
        ORG_NAME="${{ github.repository_owner }}"

        # Use GitHub CLI to fetch repositories
        gh api "orgs/$ORG_NAME/repos" --paginate --jq '.[] | select(.archived == false)' > /tmp/repos.json

        # Counter for walkthroughs found
        WALKTHROUGH_COUNT=0

        # Process each repository (use process substitution to maintain variable scope)
        while IFS= read -r repo; do
          REPO_NAME=$(echo "$repo" | jq -r '.name')
          REPO_FULL_NAME=$(echo "$repo" | jq -r '.full_name')
          REPO_DESCRIPTION=$(echo "$repo" | jq -r '.description // "No description"')
          REPO_URL=$(echo "$repo" | jq -r '.html_url')
          UPDATED_AT=$(echo "$repo" | jq -r '.updated_at')

          echo "  ‚Üí Checking $REPO_FULL_NAME..."

          # Check if repository has walkthroughs (look for specific files or paths)
          # This is a placeholder - adjust based on actual walkthrough structure
          HAS_WALKTHROUGH=$(gh api "repos/$REPO_FULL_NAME/contents/walkthroughs" 2>/dev/null && echo "true" || echo "false")

          if [ "$HAS_WALKTHROUGH" = "true" ]; then
            echo "    ‚úì Found walkthroughs"

            # Fetch walkthrough metadata
            gh api "repos/$REPO_FULL_NAME/contents/walkthroughs" --jq '.[] | select(.name | endswith(".mp4"))' | while read -r video; do
              VIDEO_NAME=$(echo "$video" | jq -r '.name')
              VIDEO_URL=$(echo "$video" | jq -r '.download_url')

              # Add to walkthroughs data
              cat >> docs/_data/walkthroughs.yml <<EOF

        - title: "$REPO_NAME Walkthrough"
          repository: "$REPO_FULL_NAME"
          description: "$REPO_DESCRIPTION"
          video_url: "$VIDEO_URL"
          thumbnail_url: ""
          updated_at: "$UPDATED_AT"
          repository_url: "$REPO_URL"
          tags:
            - "walkthrough"
            - "demo"
        EOF

              WALKTHROUGH_COUNT=$((WALKTHROUGH_COUNT + 1))
            done
          fi
        done < <(jq -c '.' /tmp/repos.json 2>/dev/null || echo '[]')

        echo "walkthrough_count=$WALKTHROUGH_COUNT" >> $GITHUB_OUTPUT
        echo "‚úÖ Found $WALKTHROUGH_COUNT walkthrough(s)"

        # If no walkthroughs found, create empty array
        if [ $WALKTHROUGH_COUNT -eq 0 ]; then
          echo "[]" > docs/_data/walkthroughs.yml
        fi

    - name: Create index page
      run: |
        # Create index page if it doesn't exist
        if [ ! -f "docs/index.md" ]; then
          cat > docs/index.md <<'EOF'
        ---
        layout: default
        title: Walkthrough Gallery
        description: Browse all application walkthroughs and live demos
        ---

        {% include walkthrough_gallery.html %}
        EOF
        fi

        echo "‚úÖ Index page ready"

    - name: Setup GitHub Pages
      id: pages
      uses: actions/configure-pages@1f0c5cde4bc74cd7e1254d0cb4de8d49e9068c7d  # ratchet:actions/configure-pages@v4
    - name: Build Jekyll site
      working-directory: site
      env:
        JEKYLL_ENV: production
      run: |
        echo "üèóÔ∏è Building Jekyll site..."

        # Build site
        bundle exec jekyll build \
          --source . \
          --destination ./_site \
          --config _config.yml \
          --verbose

        echo "‚úÖ Jekyll site built successfully"

        # List generated files
        echo "Generated files:"
        find ./_site -type f | head -20

    - name: Optimize assets
      working-directory: site
      run: |
        echo "‚ö° Optimizing site assets..."

        # Minify HTML (if html-proofer or similar is available)
        # This is optional and can be added later

        # Create .nojekyll file to prevent GitHub Pages from processing again
        touch ./_site/.nojekyll

        echo "‚úÖ Assets optimized"

    - name: Upload artifact
      uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa  # ratchet:actions/upload-pages-artifact@v3
      with:
        path: site/_site

    - name: Build summary
      run: |
        echo "## GitHub Pages Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Status:** Build Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Walkthroughs Found:** ${{ steps.aggregate.outputs.walkthrough_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "- **Jekyll Version:** $(cd site && bundle exec jekyll --version)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üì¶ Site artifact uploaded and ready for deployment." >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e  # ratchet:actions/deploy-pages@v4
    - name: Deployment summary
      run: |
        echo "## GitHub Pages Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Status:** Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üåê **Site URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Visit the site to view the walkthrough gallery!" >> $GITHUB_STEP_SUMMARY

  cleanup:
    needs: [check-site, deploy]
    runs-on: ubuntu-latest
    if: always() && needs.check-site.outputs.has_site == 'true' && needs.deploy.result == 'success'
    permissions:
      contents: write

    steps:
    - name: Check if gh-pages branch exists
      id: check_branch
      run: |
        if git ls-remote --exit-code --heads ${{ github.server_url }}/${{ github.repository }} gh-pages >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚úì gh-pages branch exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è gh-pages branch does not exist, skipping cleanup"
        fi

    - name: Checkout repository
      if: steps.check_branch.outputs.exists == 'true'
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout gh-pages branch
      if: steps.check_branch.outputs.exists == 'true'
      run: |
        git checkout gh-pages

    - name: Cleanup old builds
      if: steps.check_branch.outputs.exists == 'true'
      run: |
        echo "üßπ Cleaning up old builds (90-day retention)..."

        # Find and remove files older than 90 days
        RETENTION_DAYS=90
        find . -type f -mtime +$RETENTION_DAYS -delete

        # Count remaining files
        FILE_COUNT=$(find . -type f | wc -l)

        echo "‚úÖ Cleanup complete. $FILE_COUNT files remaining."

        # Commit cleanup if changes were made
        if [ -n "$(git status --porcelain)" ]; then
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: cleanup builds older than $RETENTION_DAYS days"
          git push
          echo "üìù Cleanup changes committed"
        else
          echo "‚ÑπÔ∏è No cleanup needed"
        fi
