name: Advanced CI Pipeline

on:
  push:
    branches: [main, master, develop]
    paths:
    - src/**
    - tests/**
    - '**.py'
    - '**.js'
    - '**.ts'
    - requirements*.txt
    - package*.json
    - Dockerfile
  pull_request:
    branches: [main, master, develop]
    paths:
    - src/**
    - tests/**
    - '**.py'
    - '**.js'
    - '**.ts'
    - requirements*.txt
    - package*.json
    - Dockerfile
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Detect what languages/frameworks are in the repo
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has-python: ${{ steps.detect.outputs.has-python }}
      has-node: ${{ steps.detect.outputs.has-node }}
      has-docker: ${{ steps.detect.outputs.has-docker }}
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4.2.2

    - name: Detect Languages
      id: detect
      run: |
        echo "has-python=$(test -f requirements.txt -o -f setup.py -o -f pyproject.toml && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "has-node=$(test -f package.json && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "has-docker=$(test -f Dockerfile && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  # Python CI
  python-ci:
    name: Python CI
    needs: detect-changes
    if: needs.detect-changes.outputs.has-python == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4.2.2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5.3.0
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || true
        pip install pytest pytest-cov flake8 black isort mypy bandit==1.7.8 safety==3.0.1

    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Format check with black
      run: black --check .

    - name: Import sorting check
      run: isort --check-only .

    - name: Type check with mypy
      run: mypy . --ignore-missing-imports || true

    - name: Security check with bandit
      run: bandit -r . -f json -o bandit-report.json || true

    - name: Run tests with pytest
      run: pytest --cov=. --cov-report=xml --cov-report=html

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238  # ratchet:codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: python-${{ matrix.python-version }}
        name: python-${{ matrix.python-version }}-${{ matrix.os }}

  # Node.js CI
  node-ci:
    name: Node.js CI
    needs: detect-changes
    if: needs.detect-changes.outputs.has-node == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x, 21.x]
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # ratchet:actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: npm

    - name: Install dependencies
      run: npm ci

    - name: Lint
      run: npm run lint || true

    - name: Type check
      run: npm run type-check || npx tsc --noEmit || true

    - name: Run tests
      run: npm test -- --coverage

    - name: Build
      run: npm run build || true

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238  # ratchet:codecov/codecov-action@v4
      with:
        files: ./coverage/coverage-final.json
        flags: node-${{ matrix.node-version }}
        name: node-${{ matrix.node-version }}-${{ matrix.os }}

  # Docker build and scan
  docker-ci:
    name: Docker CI
    needs: detect-changes
    if: needs.detect-changes.outputs.has-docker == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349  # ratchet:docker/setup-buildx-action@v3
    - name: Build Docker image
      uses: docker/build-push-action@1ca370b3a9802c92e886402e0dd88098a2533b12  # ratchet:docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: test-image:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.58.1

    - name: Run Trivy vulnerability scanner
      run: |
        trivy image --format sarif --output trivy-results.sarif test-image:latest

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action@c37a8b7cd97e31de3fcbd9d84c401870edeb8d34  # ratchet:github/codeql-action@v3
      with:
        sarif_file: trivy-results.sarif

  # Summary job
  ci-summary:
    name: CI Summary
    needs: [python-ci, node-ci, docker-ci]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Check job status
      run: |
        echo "Python CI: ${{ needs.python-ci.result }}"
        echo "Node CI: ${{ needs.node-ci.result }}"
        echo "Docker CI: ${{ needs.docker-ci.result }}"
