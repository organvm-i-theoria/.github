name: Scan for Secrets in Videos and Code

on:
  push:
    branches:
    - main
    - master
    paths:
    - '**/*.mp4'
    - '**/*.mkv'
    - '**/*.mov'
    - src/**
    - '**/*.js'
    - '**/*.ts'
    - '**/*.py'
    - '**/*.go'
    - '**/*.java'
    - .github/workflows/scan-for-secrets.yml
  pull_request:
    paths:
    - '**/*.mp4'
    - '**/*.mkv'
    - '**/*.mov'
    - src/**
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
  - cron: 0 2 * * *

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  scan-code:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    name: 'Pre-record: Scan Code for Secrets'

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install scanning tools
      run: |
        # Install TruffleHog (pinned version for reproducibility)
        pip install truffleHog==2.2.1

        # Install Gitleaks (pinned version)
        curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz | tar -xz
        sudo mv gitleaks /usr/local/bin/

        # Install detect-secrets (pinned version)
        pip install detect-secrets==1.5.0

    - name: Run TruffleHog scan
      id: trufflehog
      continue-on-error: true
      run: |
        echo "ðŸ” Running TruffleHog scan..."
        trufflehog git file://. --only-verified --json --fail > trufflehog-results.ndjson 2>trufflehog.log || true

        if [ -s trufflehog-results.ndjson ]; then
          jq -s '.' trufflehog-results.ndjson > trufflehog-results.json
        else
          echo "[]" > trufflehog-results.json
        fi

        FINDING_COUNT=$(jq 'length' trufflehog-results.json 2>/dev/null || echo "0")
        if [ "$FINDING_COUNT" -gt 0 ]; then
          echo "found_secrets=true" >> $GITHUB_OUTPUT
          echo "finding_count=$FINDING_COUNT" >> $GITHUB_OUTPUT
          echo "âš ï¸ TruffleHog found $FINDING_COUNT potential secrets"
        else
          echo "found_secrets=false" >> $GITHUB_OUTPUT
          echo "finding_count=0" >> $GITHUB_OUTPUT
          echo "âœ… TruffleHog scan clean"
        fi

    - name: Run Gitleaks scan
      id: gitleaks
      continue-on-error: true
      run: |
        echo "ðŸ” Running Gitleaks scan..."
        # Use .gitleaks.toml config if it exists
        if [ -f ".gitleaks.toml" ]; then
          echo "Using .gitleaks.toml configuration"
          gitleaks detect --source . --config .gitleaks.toml --report-format json --report-path gitleaks-results.json --verbose || true
        else
          gitleaks detect --source . --report-format json --report-path gitleaks-results.json --verbose || true
        fi

        if [ -f "gitleaks-results.json" ] && [ -s "gitleaks-results.json" ]; then
          LEAK_COUNT=$(jq length gitleaks-results.json)
          if [ "$LEAK_COUNT" -gt 0 ]; then
            echo "found_secrets=true" >> $GITHUB_OUTPUT
            echo "leak_count=$LEAK_COUNT" >> $GITHUB_OUTPUT
            echo "âš ï¸ Gitleaks found $LEAK_COUNT potential secrets"
          else
            echo "found_secrets=false" >> $GITHUB_OUTPUT
            echo "leak_count=0" >> $GITHUB_OUTPUT
            echo "âœ… Gitleaks scan clean"
          fi
        else
          echo "found_secrets=false" >> $GITHUB_OUTPUT
          echo "leak_count=0" >> $GITHUB_OUTPUT
          echo "âœ… Gitleaks scan clean"
        fi

    - name: Run detect-secrets scan
      id: detect-secrets
      continue-on-error: true
      run: |
        echo "ðŸ” Running detect-secrets scan..."
        # Use baseline if it exists
        if [ -f ".secrets.baseline" ]; then
          echo "Using .secrets.baseline for comparison"
          detect-secrets scan --all-files --force-use-all-plugins --baseline .secrets.baseline > detect-secrets-results.json || true
        else
          detect-secrets scan --all-files --force-use-all-plugins > detect-secrets-results.json || true
        fi

        if [ -f "detect-secrets-results.json" ]; then
          SECRET_COUNT=$(jq '.results | to_entries | length' detect-secrets-results.json 2>/dev/null || echo "0")
          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "found_secrets=true" >> $GITHUB_OUTPUT
            echo "secret_count=$SECRET_COUNT" >> $GITHUB_OUTPUT
            echo "âš ï¸ detect-secrets found secrets in $SECRET_COUNT files"
          else
            echo "found_secrets=false" >> $GITHUB_OUTPUT
            echo "secret_count=0" >> $GITHUB_OUTPUT
            echo "âœ… detect-secrets scan clean"
          fi
        else
          echo "found_secrets=false" >> $GITHUB_OUTPUT
          echo "secret_count=0" >> $GITHUB_OUTPUT
          echo "âœ… detect-secrets scan clean"
        fi

    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: secret-scan-results
        path: |
          trufflehog-results.json
          trufflehog-results.ndjson
          trufflehog.log
          gitleaks-results.json
          detect-secrets-results.json
        retention-days: 30

    - name: Create issue if secrets found
      if: steps.trufflehog.outputs.found_secrets == 'true' || steps.gitleaks.outputs.found_secrets == 'true' || steps.detect-secrets.outputs.found_secrets == 'true'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # ratchet:actions/github-script@v7
      env:
        TRUFFLEHOG_FOUND: ${{ steps.trufflehog.outputs.found_secrets }}
        TRUFFLEHOG_COUNT: ${{ steps.trufflehog.outputs.finding_count }}
        GITLEAKS_FOUND: ${{ steps.gitleaks.outputs.found_secrets }}
        GITLEAKS_COUNT: ${{ steps.gitleaks.outputs.leak_count }}
        DETECT_FOUND: ${{ steps.detect-secrets.outputs.found_secrets }}
        DETECT_COUNT: ${{ steps.detect-secrets.outputs.secret_count }}
      with:
        script: |
          const title = 'ðŸš¨ Security Alert: Potential Secrets Detected in Code';

          const formatStatus = (found, count, suffix = 'potential secrets') => {
            if (found === 'true') {
              return `âš ï¸ Found ${count || 0} ${suffix}`;
            }
            return 'âœ… Clean';
          };

          const trufflehogStatus = formatStatus(process.env.TRUFFLEHOG_FOUND, process.env.TRUFFLEHOG_COUNT);
          const gitleaksStatus = formatStatus(process.env.GITLEAKS_FOUND, process.env.GITLEAKS_COUNT, 'potential leaks');
          const detectStatus = formatStatus(process.env.DETECT_FOUND, process.env.DETECT_COUNT, 'files with secrets');

          const body = `## Secret Scanning Alert

          Our automated secret scanning has detected potential secrets or credentials in the codebase.

          ### Scan Results

          - **TruffleHog**: ${trufflehogStatus}
          - **Gitleaks**: ${gitleaksStatus}
          - **detect-secrets**: ${detectStatus}

          ### Action Required

          1. **Review the scan results** attached to this workflow run
          2. **Identify false positives** and update .gitleaks.toml or .secrets.baseline if needed
          3. **Rotate any real secrets** that were detected
          4. **Remove secrets from git history** using tools like BFG Repo-Cleaner or git-filter-repo
          5. **Update affected videos** if secrets appear in walkthrough recordings

          ### Resources

          - [GitHub Secret Scanning Documentation](https://docs.github.com/en/code-security/secret-scanning)
          - [Removing Sensitive Data from a Repository](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository)
          - [BFG Repo-Cleaner](https://rtyley.github.io/bfg-repo-cleaner/)

          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          `;

          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,secrets'
          });

          const existingIssue = issues.data.find(issue => issue.title === title);

          if (existingIssue) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `### New Scan Results - ${new Date().toISOString()}\n\n${body}`
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['security', 'secrets', 'high-priority']
            });
          }

    - name: Close security alert if scan clean
      if: steps.trufflehog.outputs.found_secrets != 'true' && steps.gitleaks.outputs.found_secrets != 'true' && steps.detect-secrets.outputs.found_secrets != 'true'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # ratchet:actions/github-script@v7
      with:
        script: |
          const title = 'ðŸš¨ Security Alert: Potential Secrets Detected in Code';
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,secrets'
          });

          const existingIssue = issues.data.find(issue => issue.title === title);
          if (!existingIssue) {
            return;
          }

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: existingIssue.number,
            body: `âœ… Latest scan at ${new Date().toISOString()} found no secrets. Closing alert.`
          });

          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: existingIssue.number,
            state: 'closed'
          });

  scan-videos:
    runs-on: ubuntu-latest
    name: 'Post-record: Analyze Videos for Secrets'

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install FFmpeg and OCR tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg tesseract-ocr libtesseract-dev
        pip install pytesseract opencv-python-headless Pillow numpy

    - name: Find video files
      id: find-videos
      run: |
        VIDEO_COUNT=$(find . -type f \( -name "*.mp4" -o -name "*.mkv" -o -name "*.mov" \) | wc -l)
        echo "video_count=$VIDEO_COUNT" >> $GITHUB_OUTPUT

        if [ "$VIDEO_COUNT" -eq 0 ]; then
          echo "No video files found"
          echo "has_videos=false" >> $GITHUB_OUTPUT
        else
          echo "Found $VIDEO_COUNT video files"
          echo "has_videos=true" >> $GITHUB_OUTPUT
        fi

    - name: Extract frames from videos
      if: steps.find-videos.outputs.has_videos == 'true'
      run: |
        mkdir -p video-frames

        find . -type f \( -name "*.mp4" -o -name "*.mkv" -o -name "*.mov" \) | while read video; do
          video_name=$(basename "$video" | sed 's/\.[^.]*$//')
          echo "Processing: $video"

          # Extract 1 frame per second
          ffmpeg -i "$video" -vf "fps=1" "video-frames/${video_name}_%04d.png" -hide_banner -loglevel error || true
        done

        FRAME_COUNT=$(find video-frames -name "*.png" | wc -l)
        echo "Extracted $FRAME_COUNT frames"

    - name: Run OCR on frames
      if: steps.find-videos.outputs.has_videos == 'true'
      id: ocr-scan
      run: |
        cat > scan_frames.py << 'EOF'
        import os
        import re
        import pytesseract
        from PIL import Image
        import json

        # Common secret patterns
        patterns = {
            'api_key': r'(?i)(api[_-]?key|apikey)["\s:=]+([a-zA-Z0-9_\-]{20,})',
            'password': r'(?i)(password|passwd|pwd)["\s:=]+([^\s"]{8,})',
            'token': r'(?i)(token|access[_-]?token)["\s:=]+([a-zA-Z0-9_\-\.]{20,})',
            'secret': r'(?i)(secret|client[_-]?secret)["\s:=]+([a-zA-Z0-9_\-]{20,})',
            'aws_key': r'AKIA[0-9A-Z]{16}',
            'github_token': r'ghp_[a-zA-Z0-9]{36}',
            'slack_token': r'xox[baprs]-[0-9]{10,12}-[0-9]{10,12}-[a-zA-Z0-9]{24,}',
        }

        findings = []
        frame_dir = 'video-frames'

        for filename in os.listdir(frame_dir):
            if filename.endswith('.png'):
                img_path = os.path.join(frame_dir, filename)
                try:
                    img = Image.open(img_path)
                    text = pytesseract.image_to_string(img)

                    for pattern_name, pattern in patterns.items():
                        matches = re.finditer(pattern, text)
                        for match in matches:
                            findings.append({
                                'frame': filename,
                                'pattern': pattern_name,
                                'match': match.group(0)[:50] + '...' if len(match.group(0)) > 50 else match.group(0)
                            })
                except Exception as e:
                    print(f"Error processing {filename}: {e}")

        with open('video-ocr-results.json', 'w') as f:
            json.dump(findings, f, indent=2)

        print(f"Found {len(findings)} potential secrets in video frames")
        EOF

        python scan_frames.py

        if [ -f "video-ocr-results.json" ]; then
          FINDING_COUNT=$(jq 'length' video-ocr-results.json)
          if [ "$FINDING_COUNT" -gt 0 ]; then
            echo "found_secrets=true" >> $GITHUB_OUTPUT
            echo "finding_count=$FINDING_COUNT" >> $GITHUB_OUTPUT
            echo "âš ï¸ Found $FINDING_COUNT potential secrets in videos"
          else
            echo "found_secrets=false" >> $GITHUB_OUTPUT
            echo "âœ… No secrets found in videos"
          fi
        else
          echo "found_secrets=false" >> $GITHUB_OUTPUT
          echo "âœ… No secrets found in videos"
        fi

    - name: Upload OCR results
      if: steps.find-videos.outputs.has_videos == 'true'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: video-ocr-results
        path: |
          video-ocr-results.json
          video-frames/*.png
        retention-days: 30

    - name: Quarantine videos if secrets found
      if: steps.ocr-scan.outputs.found_secrets == 'true'
      run: |
        mkdir -p quarantine
        find . -type f \( -name "*.mp4" -o -name "*.mkv" -o -name "*.mov" \) -exec mv {} quarantine/ \;
        echo "âš ï¸ Videos moved to quarantine directory"

        cat > quarantine/README.md << 'EOF'
        # Quarantined Videos

        These videos have been quarantined because potential secrets or credentials were detected during OCR analysis.

        ## Action Required

        1. Review the video-ocr-results.json file to see what was detected
        2. Verify if the detections are true positives
        3. If secrets are present, re-record the videos without exposing secrets
        4. If false positives, update the scan patterns and move videos back

        **DO NOT** publish these videos to GitHub Pages or any public location until reviewed.
        EOF

    - name: Create alert issue if secrets found in videos
      if: steps.ocr-scan.outputs.found_secrets == 'true'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # ratchet:actions/github-script@v7
      with:
        script: |
          const title = 'ðŸŽ¬ Security Alert: Secrets Detected in Video Recordings';
          const body = `## Video Secret Detection Alert

          Our automated OCR analysis has detected potential secrets or credentials visible in video walkthrough recordings.

          ### Scan Results

          - **Videos Scanned**: ${{ steps.find-videos.outputs.video_count }}
          - **Potential Secrets Found**: ${{ steps.ocr-scan.outputs.finding_count }}
          - **Status**: âš ï¸ Videos quarantined

          ### Action Required

          1. **Download and review** the OCR results artifact from this workflow run
          2. **Verify the detections** - determine if they are true secrets or false positives
          3. **If real secrets**:
             - Do NOT publish these videos
             - Re-record the walkthroughs without exposing credentials
             - Use dummy/example credentials or blur sensitive areas
          4. **If false positives**:
             - Update the scan patterns to exclude these
             - Move videos out of quarantine
          5. **Update documentation** with guidelines for recording secure walkthroughs

          ### Best Practices

          - Use environment variables for secrets (don't show .env files)
          - Use dummy credentials for demonstrations
          - Blur or pixelate sensitive information in post-processing
          - Review videos before publishing

          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Quarantine Directory**: \`quarantine/\`
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'video', 'secrets', 'critical']
          });

    - name: Summary
      if: always()
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## ðŸ”’ Secret Scanning Summary

        ### Code Scanning
        - TruffleHog: ${{ steps.trufflehog.outputs.found_secrets == 'true' && 'âš ï¸ Secrets Found' || 'âœ… Clean' }}
        - Gitleaks: ${{ steps.gitleaks.outputs.found_secrets == 'true' && 'âš ï¸ Secrets Found' || 'âœ… Clean' }}
        - detect-secrets: ${{ steps.detect-secrets.outputs.found_secrets == 'true' && 'âš ï¸ Secrets Found' || 'âœ… Clean' }}

        ### Video Scanning
        - Videos Scanned: ${{ steps.find-videos.outputs.video_count || '0' }}
        - OCR Analysis: ${{ steps.ocr-scan.outputs.found_secrets == 'true' && 'âš ï¸ Secrets Found' || 'âœ… Clean' }}

        ${{ (steps.trufflehog.outputs.found_secrets == 'true' || steps.gitleaks.outputs.found_secrets == 'true' || steps.detect-secrets.outputs.found_secrets == 'true' || steps.ocr-scan.outputs.found_secrets == 'true') && 'âš ï¸ **Action Required**: Review the findings and take appropriate action' || 'âœ… **All Clear**: No secrets detected' }}
        EOF
