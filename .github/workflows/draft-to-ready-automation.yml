name: Draft to Ready PR Automation

on:
  pull_request:
    types: [opened, synchronize, converted_to_draft]
  check_suite:
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to convert from draft to ready'
        required: true
        type: number
      force:
        description: 'Force conversion even if checks are not passing'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  convert-draft-to-ready:
    name: Convert Draft PR to Ready
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2

      - name: Get PR Details
        id: pr-details
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # ratchet:actions/github-script@v7.0.1
        with:
          script: |
            let prNumber;
            
            if (context.eventName === 'workflow_dispatch') {
              prNumber = ${{ github.event.inputs.pr_number || 'null' }};
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.check_suite) {
              // Get PR from check suite
              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.payload.check_suite.head_sha
              });
              
              if (prs.length > 0) {
                prNumber = prs[0].number;
              }
            }
            
            if (!prNumber) {
              console.log('No PR found to process');
              return null;
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            console.log(`Processing PR #${prNumber}: ${pr.title}`);
            console.log(`Draft: ${pr.draft}`);
            console.log(`Author: ${pr.user.login}`);
            
            core.setOutput('number', prNumber);
            core.setOutput('draft', pr.draft);
            core.setOutput('author', pr.user.login);
            core.setOutput('title', pr.title);
            core.setOutput('head_sha', pr.head.sha);
            
            return pr;

      - name: Check if PR should be converted
        id: should-convert
        if: steps.pr-details.outputs.number && steps.pr-details.outputs.draft == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # ratchet:actions/github-script@v7.0.1
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};
            const author = '${{ steps.pr-details.outputs.author }}';
            const force = '${{ github.event.inputs.force }}' === 'true';
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Check if PR is from trusted AI agents or has auto-ready label
            const trustedAgents = ['Jules', 'dependabot[bot]', 'github-actions[bot]'];
            const isTrustedAgent = trustedAgents.some(agent => author.includes(agent));
            
            const hasAutoReadyLabel = pr.labels.some(label => 
              label.name === 'auto-ready' || 
              label.name === 'ready-when-green'
            );
            
            const titleIndicatesAutoReady = /\[auto-ready\]/i.test(pr.title);
            
            // Check for skip label
            const hasSkipLabel = pr.labels.some(label => 
              label.name === 'keep-draft' || 
              label.name === 'skip-auto-ready'
            );
            
            if (hasSkipLabel) {
              console.log('PR has skip label, not converting');
              return { shouldConvert: false, reason: 'Skip label present' };
            }
            
            const shouldConvert = isTrustedAgent || hasAutoReadyLabel || titleIndicatesAutoReady;
            
            if (!shouldConvert) {
              console.log('PR does not meet criteria for auto-conversion');
              return { shouldConvert: false, reason: 'Does not meet criteria' };
            }
            
            core.setOutput('should-convert', 'true');
            core.setOutput('is-trusted-agent', isTrustedAgent.toString());
            
            return { shouldConvert: true, reason: 'Meets criteria', isTrustedAgent };

      - name: Check Status Checks
        id: check-status
        if: steps.should-convert.outputs.should-convert == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # ratchet:actions/github-script@v7.0.1
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};
            const headSha = '${{ steps.pr-details.outputs.head_sha }}';
            const force = '${{ github.event.inputs.force }}' === 'true';
            
            // Get combined status
            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha
            });
            
            console.log(`Combined status: ${status.state}`);
            
            // Get check runs
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha
            });
            
            // Count checks
            const totalChecks = checkRuns.check_runs.length;
            const completedChecks = checkRuns.check_runs.filter(check => 
              check.status === 'completed'
            ).length;
            
            const successfulChecks = checkRuns.check_runs.filter(check => 
              check.conclusion === 'success' || check.conclusion === 'skipped' || check.conclusion === 'neutral'
            ).length;
            
            const failedChecks = checkRuns.check_runs.filter(check =>
              check.conclusion === 'failure' || check.conclusion === 'cancelled'
            );
            
            console.log(`Checks: ${completedChecks}/${totalChecks} completed, ${successfulChecks} successful`);
            
            // Determine if we should convert
            const allChecksPassed = status.state === 'success' && failedChecks.length === 0;
            const noChecksYet = totalChecks === 0;
            
            // Allow conversion if:
            // 1. All checks passed, OR
            // 2. No checks have run yet (let them run after conversion), OR
            // 3. Force flag is set
            const shouldProceed = allChecksPassed || noChecksYet || force;
            
            core.setOutput('checks-passed', allChecksPassed.toString());
            core.setOutput('no-checks', noChecksYet.toString());
            core.setOutput('should-proceed', shouldProceed.toString());
            
            return {
              passed: allChecksPassed,
              noChecks: noChecksYet,
              shouldProceed,
              failedChecks: failedChecks.map(c => c.name)
            };

      - name: Convert Draft to Ready
        id: convert
        if: |
          steps.should-convert.outputs.should-convert == 'true' &&
          steps.check-status.outputs.should-proceed == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # ratchet:actions/github-script@v7.0.1
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};
            
            console.log(`Converting PR #${prNumber} from draft to ready...`);
            
            try {
              // Mark PR as ready for review
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                draft: false
              });
              
              console.log(`‚úÖ Successfully converted PR #${prNumber} to ready`);
              
              core.setOutput('converted', 'true');
              
              return { success: true };
            } catch (error) {
              console.error(`Failed to convert PR: ${error.message}`);
              core.setOutput('converted', 'false');
              
              return { success: false, error: error.message };
            }

      - name: Post Conversion Comment
        if: steps.convert.outputs.converted == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # ratchet:actions/github-script@v7.0.1
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};
            const isTrustedAgent = '${{ steps.should-convert.outputs.is-trusted-agent }}' === 'true';
            const checksPassed = '${{ steps.check-status.outputs.checks-passed }}' === 'true';
            
            let reason = '';
            if (isTrustedAgent) {
              reason = '‚úÖ Trusted AI agent/bot PR';
            } else {
              reason = '‚úÖ Marked for auto-ready';
            }
            
            let statusInfo = '';
            if (checksPassed) {
              statusInfo = '\n\n‚úÖ **All checks passed** - PR is ready for review and merge';
            } else {
              statusInfo = '\n\n‚è≥ **Checks running** - PR will be ready for merge once checks pass';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `üöÄ Draft PR Auto-Converted to Ready\n\n${reason}\n\nThis PR has been automatically converted from draft to ready for review.${statusInfo}\n\nNext Steps:\n1. Review changes and ensure everything looks good\n2. Wait for CI checks to complete (if not already done)\n3. The auto-merge workflow will handle merging when ready\n\nTo prevent auto-conversion:\n- Add the keep-draft label to PRs you want to keep as draft\n- Add the skip-auto-ready label\n\n_Automated by [draft-to-ready-automation.yml](../.github/workflows/draft-to-ready-automation.yml)_`
            });

      - name: Add Auto-Merge Label
        if: steps.convert.outputs.converted == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # ratchet:actions/github-script@v7.0.1
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};
            
            // Add auto-merge label to trigger auto-merge workflow
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['auto-merge', 'auto-converted']
            });
            
            console.log('Added auto-merge and auto-converted labels');

      - name: Wait for Checks (if needed)
        if: |
          steps.convert.outputs.converted == 'true' &&
          steps.check-status.outputs.checks-passed != 'true'
        run: |
          echo "‚è≥ PR converted to ready. Checks will run and auto-merge will proceed when they pass."
          echo "The auto-merge workflow will handle the rest of the process."

      - name: Summary
        if: always() && steps.pr-details.outputs.number
        run: |
          echo "### üöÄ Draft to Ready Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** #${{ steps.pr-details.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ steps.pr-details.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ steps.pr-details.outputs.author }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.pr-details.outputs.draft }}" != "true" ]; then
            echo "‚ÑπÔ∏è PR is already ready (not a draft)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.should-convert.outputs.should-convert }}" != "true" ]; then
            echo "‚è≠Ô∏è PR does not meet criteria for auto-conversion" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To enable auto-conversion:**" >> $GITHUB_STEP_SUMMARY
            echo "- Add the \`auto-ready\` label" >> $GITHUB_STEP_SUMMARY
            echo "- Include \`[auto-ready]\` in PR title" >> $GITHUB_STEP_SUMMARY
            echo "- Have PR created by trusted AI agent" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-status.outputs.should-proceed }}" != "true" ]; then
            echo "‚è≥ Waiting for checks to pass before conversion" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.convert.outputs.converted }}" == "true" ]; then
            echo "‚úÖ **Successfully converted from draft to ready!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:**" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.check-status.outputs.checks-passed }}" == "true" ]; then
              echo "- ‚úÖ All checks passed" >> $GITHUB_STEP_SUMMARY
              echo "- üéØ Ready for auto-merge" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚è≥ Checks running" >> $GITHUB_STEP_SUMMARY
              echo "- üîÑ Auto-merge will proceed when checks pass" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ùå Failed to convert PR" >> $GITHUB_STEP_SUMMARY
          fi

  scan-all-draft-prs:
    name: Scan All Draft PRs
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number == ''
    
    steps:
      - name: Find and Process Draft PRs
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # ratchet:actions/github-script@v7.0.1
        with:
          script: |
            console.log('üîç Scanning for draft PRs that should be converted...');
            
            // Get all open draft PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            const draftPRs = prs.filter(pr => pr.draft);
            
            console.log(`Found ${draftPRs.length} draft PRs`);
            
            const trustedAgents = ['Jules', 'dependabot[bot]', 'github-actions[bot]'];
            
            let eligible = [];
            
            for (const pr of draftPRs) {
              const isTrustedAgent = trustedAgents.some(agent => 
                pr.user.login.includes(agent)
              );
              
              const hasAutoReadyLabel = pr.labels.some(label => 
                label.name === 'auto-ready' || label.name === 'ready-when-green'
              );
              
              const hasSkipLabel = pr.labels.some(label => 
                label.name === 'keep-draft' || label.name === 'skip-auto-ready'
              );
              
              if (!hasSkipLabel && (isTrustedAgent || hasAutoReadyLabel)) {
                eligible.push({
                  number: pr.number,
                  title: pr.title,
                  author: pr.user.login,
                  reason: isTrustedAgent ? 'Trusted agent' : 'Auto-ready label'
                });
              }
            }
            
            console.log(`Found ${eligible.length} eligible PRs for auto-conversion:`);
            eligible.forEach(pr => {
              console.log(`- PR #${pr.number}: ${pr.title} (${pr.reason})`);
            });
            
            // Trigger conversion for each eligible PR
            for (const pr of eligible) {
              console.log(`\nTriggering conversion for PR #${pr.number}...`);
              
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'draft-to-ready-automation.yml',
                  ref: 'main',
                  inputs: {
                    pr_number: pr.number.toString(),
                    force: 'false'
                  }
                });
                
                console.log(`‚úÖ Triggered conversion for PR #${pr.number}`);
              } catch (error) {
                console.error(`‚ùå Failed to trigger conversion for PR #${pr.number}: ${error.message}`);
              }
            }
            
            return {
              total: draftPRs.length,
              eligible: eligible.length,
              prs: eligible
            };
