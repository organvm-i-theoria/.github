name: PR Task Catcher

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to scan
        required: true
        type: number

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  scan-pr-comments:
    name: Scan PR Comments for Tasks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request && github.event.pull_request.state == 'open') ||
      (github.event.issue.pull_request)

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2

      - name: Get PR Number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch All PR Data
        id: fetch
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}

          echo "ðŸ“¡ Fetching PR data for #$PR_NUM..."

          # Get PR details
          gh pr view $PR_NUM --json title,body,author,reviews,comments > pr_data.json

          TITLE=$(jq -r '.title' pr_data.json)
          BODY=$(jq -r '.body // ""' pr_data.json)
          AUTHOR=$(jq -r '.author.login' pr_data.json)

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

          # Save body to file for processing
          echo "$BODY" > pr_body.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Tasks from PR Body
        id: body_tasks
        run: |
          echo "ðŸ” Scanning PR body for tasks..."

          # Extract unchecked tasks
          UNCHECKED_TASKS=$(grep -E '^\s*[-*]\s*\[ \]' pr_body.txt || echo "")
          UNCHECKED_COUNT=$(echo "$UNCHECKED_TASKS" | grep -c '^\s*[-*]\s*\[ \]' || echo "0")

          # Extract checked tasks (for comparison)
          CHECKED_TASKS=$(grep -E '^\s*[-*]\s*\[x\]' pr_body.txt || echo "")
          CHECKED_COUNT=$(echo "$CHECKED_TASKS" | grep -c '^\s*[-*]\s*\[x\]' || echo "0")

          echo "Found $UNCHECKED_COUNT unchecked tasks, $CHECKED_COUNT checked tasks in PR body"

          echo "unchecked_count=$UNCHECKED_COUNT" >> $GITHUB_OUTPUT
          echo "checked_count=$CHECKED_COUNT" >> $GITHUB_OUTPUT

          # Save unchecked tasks
          echo "unchecked_tasks<<EOF" >> $GITHUB_OUTPUT
          echo "$UNCHECKED_TASKS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract Tasks from Comments
        id: comment_tasks
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}

          echo "ðŸ’¬ Scanning all comments for tasks and suggestions..."

          # Get all comments (issue comments + review comments)
          gh api repos/${{ github.repository }}/issues/$PR_NUM/comments --paginate > issue_comments.json
          gh api repos/${{ github.repository }}/pulls/$PR_NUM/comments --paginate > review_comments.json

          # Keywords that indicate actionable items
          BLOCKER_KEYWORDS="blocker|must fix|required|critical|blocking|action item|FIXME|TODO"
          SUGGESTION_KEYWORDS="suggest|should|could|consider|recommend|might want to"
          QUESTION_KEYWORDS="\?"

          # Process issue comments
          echo "## Issue Comments" > comment_tasks.md
          jq -r '.[] | "\(.user.login)|\(.created_at)|\(.body)"' issue_comments.json | while IFS='|' read -r user created body; do
            # Check for unchecked tasks
            TASKS=$(echo "$body" | grep -E '^\s*[-*]\s*\[ \]' || echo "")
            if [ -n "$TASKS" ]; then
              echo "### @$user ($(date -d "$created" +'%Y-%m-%d %H:%M' 2>/dev/null || echo "$created"))" >> comment_tasks.md
              echo "$TASKS" >> comment_tasks.md
              echo "" >> comment_tasks.md
            fi

            # Check for blocker keywords
            BLOCKERS=$(echo "$body" | grep -iE "$BLOCKER_KEYWORDS" || echo "")
            if [ -n "$BLOCKERS" ]; then
              echo "### ðŸš¨ @$user - BLOCKER" >> comment_tasks.md
              echo "$BLOCKERS" | head -3 >> comment_tasks.md
              echo "" >> comment_tasks.md
            fi

            # Check for suggestions
            SUGGESTIONS=$(echo "$body" | grep -iE "$SUGGESTION_KEYWORDS" || echo "")
            if [ -n "$SUGGESTIONS" ]; then
              echo "### ðŸ’¡ @$user - Suggestion" >> comment_tasks.md
              echo "$SUGGESTIONS" | head -2 >> comment_tasks.md
              echo "" >> comment_tasks.md
            fi
          done

          # Process review comments
          echo "## Review Comments" >> comment_tasks.md
          jq -r '.[] | "\(.user.login)|\(.created_at)|\(.body)|\(.path):\(.line)"' review_comments.json | while IFS='|' read -r user created body location; do
            # Check for unchecked tasks
            TASKS=$(echo "$body" | grep -E '^\s*[-*]\s*\[ \]' || echo "")
            if [ -n "$TASKS" ]; then
              echo "### @$user at $location" >> comment_tasks.md
              echo "$TASKS" >> comment_tasks.md
              echo "" >> comment_tasks.md
            fi

            # Check for blocker keywords
            BLOCKERS=$(echo "$body" | grep -iE "$BLOCKER_KEYWORDS" || echo "")
            if [ -n "$BLOCKERS" ]; then
              echo "### ðŸš¨ @$user - BLOCKER at $location" >> comment_tasks.md
              echo "$BLOCKERS" | head -3 >> comment_tasks.md
              echo "" >> comment_tasks.md
            fi
          done

          # Count findings
          TASK_COUNT=$(grep -c '^\s*[-*]\s*\[ \]' comment_tasks.md || echo "0")
          BLOCKER_COUNT=$(grep -c 'ðŸš¨' comment_tasks.md || echo "0")
          SUGGESTION_COUNT=$(grep -c 'ðŸ’¡' comment_tasks.md || echo "0")

          echo "Found: $TASK_COUNT tasks, $BLOCKER_COUNT blockers, $SUGGESTION_COUNT suggestions"

          echo "task_count=$TASK_COUNT" >> $GITHUB_OUTPUT
          echo "blocker_count=$BLOCKER_COUNT" >> $GITHUB_OUTPUT
          echo "suggestion_count=$SUGGESTION_COUNT" >> $GITHUB_OUTPUT

          # Save to output
          echo "tasks_summary<<EOF" >> $GITHUB_OUTPUT
          cat comment_tasks.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for Unresolved Review Threads
        id: review_threads
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}

          echo "ðŸ§µ Checking for unresolved review threads..."

          # Get review threads via GraphQL (more reliable for thread status)
          UNRESOLVED_COUNT=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                      comments(first: 1) {
                        nodes {
                          body
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -F owner=${{ github.repository_owner }} \
            -F repo=$(echo ${{ github.repository }} | cut -d'/' -f2) \
            -F pr=$PR_NUM \
            --jq '.data.repository.pullRequest.reviewThreads.nodes | map(select(.isResolved == false)) | length')

          echo "Found $UNRESOLVED_COUNT unresolved review threads"
          echo "unresolved_count=$UNRESOLVED_COUNT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Task Summary Comment
        id: summary
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}

          UNCHECKED_BODY=${{ steps.body_tasks.outputs.unchecked_count }}
          CHECKED_BODY=${{ steps.body_tasks.outputs.checked_count }}
          COMMENT_TASKS=${{ steps.comment_tasks.outputs.task_count }}
          BLOCKERS=${{ steps.comment_tasks.outputs.blocker_count }}
          SUGGESTIONS=${{ steps.comment_tasks.outputs.suggestion_count }}
          UNRESOLVED_THREADS=${{ steps.review_threads.outputs.unresolved_count }}

          TOTAL_TASKS=$((UNCHECKED_BODY + COMMENT_TASKS))

          echo "ðŸ“Š Generating task summary..."

          # Determine status
          if [ "$BLOCKERS" -gt 0 ]; then
            STATUS="ðŸš¨ **BLOCKERS FOUND** - Address before merging"
            STATUS_EMOJI="ðŸš¨"
          elif [ "$TOTAL_TASKS" -gt 0 ]; then
            STATUS="âš ï¸ **Tasks pending** - Review before merging"
            STATUS_EMOJI="âš ï¸"
          elif [ "$UNRESOLVED_THREADS" -gt 0 ]; then
            STATUS="ðŸ’¬ **Unresolved discussions** - Resolve review threads"
            STATUS_EMOJI="ðŸ’¬"
          else
            STATUS="âœ… **All clear** - No pending tasks"
            STATUS_EMOJI="âœ…"
          fi

          # Build summary comment
          cat > /tmp/task_summary.md <<- 'EOF_SUMMARY'
          <!-- task-catcher-summary -->
          # $STATUS_EMOJI Task Catcher Summary

          $STATUS

          ## ðŸ“‹ Task Overview

          | Category | Count |
          |----------|-------|
          | PR Body Unchecked Tasks | $UNCHECKED_BODY |
          | PR Body Checked Tasks | $CHECKED_BODY âœ… |
          | Comment Tasks | $COMMENT_TASKS |
          | Blocker Items | $BLOCKERS ðŸš¨ |
          | Suggestions | $SUGGESTIONS ðŸ’¡ |
          | Unresolved Review Threads | $UNRESOLVED_THREADS |

          ---
          EOF_SUMMARY
          SUMMARY=$(cat /tmp/task_summary.md)

          # Add PR body tasks if any
          if [ "$UNCHECKED_BODY" -gt 0 ]; then
            cat >> /tmp/task_summary.md <<- 'EOF_BODY'

            ## âœ… PR Body Tasks ($UNCHECKED_BODY unchecked)

            ${{ steps.body_tasks.outputs.unchecked_tasks }}

            ---
            EOF_BODY
          fi

          # Add comment tasks if any
          if [ "$COMMENT_TASKS" -gt 0 ] || [ "$BLOCKERS" -gt 0 ]; then
            cat >> /tmp/task_summary.md <<- 'EOF_COMMENTS'

            ## ðŸ’¬ Comment Tasks & Blockers

            ${{ steps.comment_tasks.outputs.tasks_summary }}

            ---
            EOF_COMMENTS
          fi

          # Add guidance
          cat >> /tmp/task_summary.md <<- 'EOF_GUIDANCE'

          ## ðŸŽ¯ Next Steps

          EOF_GUIDANCE

          if [ "$BLOCKERS" -gt 0 ]; then
            printf "- ðŸš¨ **Address all blocker items** before merging\n" >> /tmp/task_summary.md
          fi

          if [ "$UNCHECKED_BODY" -gt 0 ]; then
            printf "- âœ… Check off completed tasks in PR description\n" >> /tmp/task_summary.md
          fi

          if [ "$UNRESOLVED_THREADS" -gt 0 ]; then
            printf "- ðŸ’¬ Resolve review discussion threads\n" >> /tmp/task_summary.md
          fi

          if [ "$COMMENT_TASKS" -gt 0 ]; then
            printf "- ðŸ“ Complete or assign out tasks from comments\n" >> /tmp/task_summary.md
          fi

          if [ "$TOTAL_TASKS" -eq 0 ] && [ "$BLOCKERS" -eq 0 ] && [ "$UNRESOLVED_THREADS" -eq 0 ]; then
            printf "- ðŸš€ All tasks complete! Ready to merge when CI passes.\n" >> /tmp/task_summary.md
          fi

          cat >> /tmp/task_summary.md <<- 'EOF_FOOTER'

          ---

          **Options:**
          - âœ… Check off tasks as you complete them
          - ðŸ“‹ Create issues for tasks to handle later: Add `create-issues-for-tasks` label
          - ðŸš« Ignore tasks for merge: Add `ignore-task-checks` label

          *Last scanned: $(date -u +'%Y-%m-%d %H:%M UTC')*
          *Triggered by: ${{ github.event_name }}*
          EOF_FOOTER

          # Read the complete summary
          SUMMARY=$(cat /tmp/task_summary.md)

          # Save summary to file
          echo "$SUMMARY" > task_summary.md

          echo "has_blockers=$( [ "$BLOCKERS" -gt 0 ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "has_tasks=$( [ "$TOTAL_TASKS" -gt 0 ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "total_tasks=$TOTAL_TASKS" >> $GITHUB_OUTPUT

      - name: Post or Update Task Summary
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}

          echo "ðŸ’¬ Posting task summary to PR..."

          # Check if task-catcher summary comment already exists
          EXISTING_COMMENT=$(gh api repos/${{ github.repository }}/issues/$PR_NUM/comments \
            --jq '.[] | select(.body | contains("<!-- task-catcher-summary -->")) | .id' | head -1)

          SUMMARY=$(cat task_summary.md)

          if [ -n "$EXISTING_COMMENT" ]; then
            echo "Updating existing comment #$EXISTING_COMMENT"
            gh api repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT \
              -X PATCH \
              -f body="$SUMMARY"
          else
            echo "Creating new task summary comment"
            gh pr comment $PR_NUM --body "$SUMMARY"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Labels Based on Findings
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}
          HAS_BLOCKERS=${{ steps.summary.outputs.has_blockers }}
          HAS_TASKS=${{ steps.summary.outputs.has_tasks }}

          echo "ðŸ·ï¸ Updating PR labels..."

          # Get current labels
          CURRENT_LABELS=$(gh pr view $PR_NUM --json labels --jq '.labels | map(.name) | join(",")')

          if [ "$HAS_BLOCKERS" == "true" ]; then
            if [[ ! "$CURRENT_LABELS" =~ "has-blockers" ]]; then
              gh pr edit $PR_NUM --add-label "has-blockers"
              echo "Added 'has-blockers' label"
            fi
          else
            if [[ "$CURRENT_LABELS" =~ "has-blockers" ]]; then
              gh pr edit $PR_NUM --remove-label "has-blockers"
              echo "Removed 'has-blockers' label"
            fi
          fi

          if [ "$HAS_TASKS" == "true" ]; then
            if [[ ! "$CURRENT_LABELS" =~ "has-pending-tasks" ]]; then
              gh pr edit $PR_NUM --add-label "has-pending-tasks"
              echo "Added 'has-pending-tasks' label"
            fi
          else
            if [[ "$CURRENT_LABELS" =~ "has-pending-tasks" ]]; then
              gh pr edit $PR_NUM --remove-label "has-pending-tasks"
              echo "Removed 'has-pending-tasks' label"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Merge Blocking
        id: block_check
        run: |
          PR_NUM=${{ steps.pr.outputs.number }}
          HAS_BLOCKERS=${{ steps.summary.outputs.has_blockers }}

          # Get labels
          LABELS=$(gh pr view $PR_NUM --json labels --jq '.labels | map(.name) | join(",")')

          # Check if PR has ignore label
          if [[ "$LABELS" =~ "ignore-task-checks" ]]; then
            echo "â­ï¸ Ignoring task checks (ignore-task-checks label present)"
            echo "should_block=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Block merge if blockers exist
          if [ "$HAS_BLOCKERS" == "true" ]; then
            echo "ðŸš¨ Blocking merge due to unresolved blockers"
            echo "should_block=true" >> $GITHUB_OUTPUT

            cat > /tmp/blocker_message.md <<- 'EOF_BLOCKER'
            ðŸš« **Merge Blocked**

            This PR has unresolved blocker items that must be addressed before merging.

            Review the task summary above and:
            1. Address all items marked with ðŸš¨ BLOCKER
            2. Check off completed tasks
            3. Or add `ignore-task-checks` label to bypass (not recommended)

            The `has-blockers` label will be automatically removed when blockers are resolved.
            EOF_BLOCKER
            gh pr comment $PR_NUM --body-file /tmp/blocker_message.md
          else
            echo "âœ… No blockers found, merge allowed"
            echo "should_block=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-issues-from-tasks:
    name: Create Issues from PR Tasks
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'create-issues-for-tasks')

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2

      - name: Extract and Create Issues
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"

          echo "ðŸ“‹ Extracting incomplete tasks from merged PR #$PR_NUM..."

          # Get PR body
          BODY=$(gh pr view $PR_NUM --json body --jq '.body // ""')

          # Extract unchecked tasks
          TASKS=$(echo "$BODY" | grep -E '^\s*[-*]\s*\[ \]' || echo "")

          if [ -z "$TASKS" ]; then
            echo "No unchecked tasks found"
            exit 0
          fi

          TASK_COUNT=$(echo "$TASKS" | grep -c '^\s*[-*]\s*\[ \]')
          echo "Found $TASK_COUNT unchecked tasks"

          # Create issues for each task
          echo "$TASKS" | while read -r task; do
            # Clean up task text
            TASK_TEXT=$(echo "$task" | sed 's/^\s*[-*]\s*\[ \]\s*//')

            if [ -n "$TASK_TEXT" ]; then
              echo "Creating issue for: $TASK_TEXT"

              cat > /tmp/task_issue.md <<- 'EOF_TASK'
              # Task from PR #$PR_NUM

              **Original PR:** #$PR_NUM - $PR_TITLE
              **Author:** @$AUTHOR

              ## Task

              $TASK_TEXT

              ## Context

              This task was left incomplete in PR #$PR_NUM. See the original PR for full context.

              ---
              _Auto-created by [pr-task-catcher.yml](../.github/workflows/pr-task-catcher.yml)_
              EOF_TASK

              gh issue create \
                --title "Task from PR #$PR_NUM: $TASK_TEXT" \
                --body-file /tmp/task_issue.md \
                --label "task-from-pr,needs-triage" \
                --assignee "$AUTHOR"
            fi
          done

          echo "âœ… Created $TASK_COUNT issues from PR tasks"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
