name: Manual Reset

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  reset:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5.3.0
      with:
        python-version: '3.12'
        cache: pip

    - name: Make scripts executable
      run: chmod +x src/automation/scripts/*.sh

        # Removed manage_lock.sh usage to prevent deadlock and reliance on deprecated locking mechanism
        # quota_manager.py handles locking internally using fcntl

    - name: Reset quotas
      run: python src/automation/scripts/quota_manager.py reset_quotas

    - name: Commit state changes
      run: |
        ./src/automation/scripts/commit_changes.sh "chore: manually reset quotas"
