name: Workflow Health Check

on:
  schedule:
  - cron: 0 */6 * * *     # Every 6 hours
  workflow_dispatch:
  push:
    branches:
    - main
    paths:
    - .github/workflows/**

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 100   # Last 100 commits for analysis

    - name: Setup Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        pip install pyyaml requests

    - name: Analyze workflow health
      id: health
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: python3 src/automation/scripts/generate_workflow_health_report.py

    - name: Create health report
      run: |
        cat > metrics/health/README.md << 'EOF'
        # Workflow Health Report

        Automated health checks for all GitHub Actions workflows.

        ## Current Status

        - **Overall Health**: See `latest.json`
        - **Last Check**: Auto-updated every 6 hours
        - **Healthy Workflows**: Tracked in report

        ## Health Criteria

        ### Security (Weight: 30%)
        - âœ… All actions pinned to commit SHAs
        - âœ… Explicit minimal permissions
        - âœ… No secrets in logs
        - âœ… SARIF uploads for security scans

        ### Performance (Weight: 25%)
        - âœ… Caching enabled where applicable
        - âœ… Optimal runner selection
        - âœ… Path filters for selective runs
        - âœ… Concurrency controls

        ### Reliability (Weight: 25%)
        - âœ… Timeout configurations
        - âœ… Retry logic for flaky operations
        - âœ… Error handling
        - âœ… Notification on failures

        ### Maintainability (Weight: 20%)
        - âœ… Reusable workflows
        - âœ… Clear naming conventions
        - âœ… Comprehensive documentation
        - âœ… DRY principle

        ## Health Grades

        - **Excellent**: 95-100% healthy workflows
        - **Good**: 85-94% healthy workflows
        - **Fair**: 70-84% healthy workflows
        - **Needs Attention**: <70% healthy workflows

        ## Automated Actions

        When health degrades:
        1. Issue automatically created
        2. Notification sent to team
        3. Dashboard updated with status
        4. Recommendations provided

        ## Manual Review

        Trigger health check manually:
        ```bash
        gh workflow run health-check.yml
        ```
        EOF

    - name: Commit health report
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add metrics/health/
        git diff --staged --quiet || git commit -m "chore: update workflow health check report"

    - name: Create issue if health is poor
      if: steps.health.outputs.errors != '0'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # ratchet:actions/github-script@v7
      with:
        script: |
          const errors = ${{ steps.health.outputs.errors }};
          const warnings = ${{ steps.health.outputs.warnings }};

          if (errors > 0) {
            // Check for existing health issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-health'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”´ Workflow Health Check: Critical Issues Detected',
                body: `## Workflow Health Alert\n\n**Errors**: ${errors}\n**Warnings**: ${warnings}\n\nPlease review the health report at \`metrics/health/latest.json\` for details.\n\n### Recommended Actions\n1. Review error messages\n2. Fix critical issues\n3. Re-run health check\n4. Close this issue when resolved`,
                labels: ['workflow-health', 'priority:high']
              });
            }
          }

    - name: Generate summary
      run: |
        echo "## ðŸ¥ Workflow Health Check Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Overall Health**: ${{ steps.health.outputs.health }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Errors**: ${{ steps.health.outputs.errors }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Warnings**: ${{ steps.health.outputs.warnings }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full report: \`metrics/health/latest.json\`" >> $GITHUB_STEP_SUMMARY
