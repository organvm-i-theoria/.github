name: PR Consolidation - Merge All Open PRs

on:
  workflow_dispatch:
    inputs:
      consolidation_branch:
        description: 'Name for consolidation branch (default: pr-consolidation-YYYYMMDD)'
        required: false
        type: string
      exclude_prs:
        description: 'Comma-separated PR numbers to exclude (e.g., 101,102)'
        required: false
        type: string
      dry_run:
        description: 'Dry run - only analyze without making changes'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  analyze-prs:
    name: Analyze Open PRs
    runs-on: ubuntu-latest
    outputs:
      pr-list: ${{ steps.get-prs.outputs.pr-list }}
      pr-count: ${{ steps.get-prs.outputs.pr-count }}
      consolidation-branch: ${{ steps.setup.outputs.consolidation-branch }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Consolidation Branch Name
        id: setup
        run: |
          if [ -n "${{ github.event.inputs.consolidation_branch }}" ]; then
            BRANCH_NAME="${{ github.event.inputs.consolidation_branch }}"
          else
            BRANCH_NAME="pr-consolidation-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "consolidation-branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Consolidation branch: $BRANCH_NAME"

      - name: Get All Open PRs
        id: get-prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXCLUDE_PRS="${{ github.event.inputs.exclude_prs }}"
          
          echo "ðŸ” Fetching all open PRs..."
          
          # Get all open PRs except this workflow's PR
          gh pr list --state open --json number,title,headRefName,author,body,labels,createdAt,updatedAt \
            --limit 100 > all_prs.json
          
          # Filter out excluded PRs
          if [ -n "$EXCLUDE_PRS" ]; then
            echo "Excluding PRs: $EXCLUDE_PRS"
            EXCLUDE_ARRAY=$(echo "$EXCLUDE_PRS" | jq -R 'split(",") | map(tonumber)')
            jq --argjson exclude "$EXCLUDE_ARRAY" \
              'map(select(.number as $n | ($exclude | index($n)) == null))' \
              all_prs.json > filtered_prs.json
          else
            cp all_prs.json filtered_prs.json
          fi
          
          PR_COUNT=$(jq 'length' filtered_prs.json)
          
          echo "Found $PR_COUNT open PRs to consolidate"
          
          if [ "$PR_COUNT" -eq 0 ]; then
            echo "âŒ No PRs found to consolidate"
            exit 1
          fi
          
          # Display PR summary
          echo "ðŸ“‹ PRs to consolidate:"
          jq -r '.[] | "  - PR #\(.number): \(.title) by @\(.author.login)"' filtered_prs.json
          
          echo "pr-count=$PR_COUNT" >> $GITHUB_OUTPUT
          echo "pr-list<<EOF" >> $GITHUB_OUTPUT
          cat filtered_prs.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload PR Data
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # ratchet:actions/upload-artifact@v4
        with:
          name: pr-data
          path: filtered_prs.json

  consolidate-prs:
    name: Consolidate PRs
    runs-on: ubuntu-latest
    needs: analyze-prs
    if: needs.analyze-prs.outputs.pr-count != '0'
    outputs:
      merge-report: ${{ steps.merge.outputs.report }}
      conflicts-summary: ${{ steps.merge.outputs.conflicts }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download PR Data
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # ratchet:actions/download-artifact@v4
        with:
          name: pr-data

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Consolidation Branch
        id: create-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ needs.analyze-prs.outputs.consolidation-branch }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          echo "ðŸ“¦ Creating consolidation branch: $BRANCH_NAME"
          
          # Ensure we're on main and up to date
          git checkout main
          git pull origin main
          
          if [ "$DRY_RUN" != "true" ]; then
            # Create new consolidation branch
            git checkout -b "$BRANCH_NAME"
            git push -u origin "$BRANCH_NAME"
            echo "âœ… Created branch: $BRANCH_NAME"
          else
            echo "[DRY RUN] Would create branch: $BRANCH_NAME"
          fi

      - name: Merge All PRs
        id: merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          BRANCH_NAME="${{ needs.analyze-prs.outputs.consolidation-branch }}"
          
          echo "ðŸ”€ Starting PR consolidation process..."
          
          # Initialize tracking files
          echo "0" > /tmp/merged_count.txt
          echo "0" > /tmp/conflict_count.txt
          echo "" > /tmp/merged_prs.txt
          echo "" > /tmp/conflict_prs.txt
          echo "" > /tmp/merge_details.txt
          
          # Process each PR
          jq -c '.[]' filtered_prs.json | while IFS= read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            PR_TITLE=$(echo "$pr" | jq -r '.title')
            PR_BRANCH=$(echo "$pr" | jq -r '.headRefName')
            PR_AUTHOR=$(echo "$pr" | jq -r '.author.login')
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Processing PR #$PR_NUMBER: $PR_TITLE"
            echo "Branch: $PR_BRANCH | Author: @$PR_AUTHOR"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "[DRY RUN] Would merge PR #$PR_NUMBER"
              MERGED_COUNT=$(cat /tmp/merged_count.txt)
              echo "$((MERGED_COUNT + 1))" > /tmp/merged_count.txt
              echo "$PR_NUMBER " >> /tmp/merged_prs.txt
              continue
            fi
            
            # Fetch the PR branch
            echo "ðŸ“¥ Fetching branch: $PR_BRANCH"
            git fetch origin "$PR_BRANCH:$PR_BRANCH" || {
              echo "âš ï¸ Could not fetch branch $PR_BRANCH"
              continue
            }
            
            # Attempt merge
            echo "ðŸ”€ Attempting to merge..."
            if git merge --no-ff --no-edit "$PR_BRANCH" -m "Merge PR #$PR_NUMBER: $PR_TITLE"; then
              echo "âœ… Successfully merged PR #$PR_NUMBER"
              MERGED_COUNT=$(cat /tmp/merged_count.txt)
              echo "$((MERGED_COUNT + 1))" > /tmp/merged_count.txt
              echo "$PR_NUMBER " >> /tmp/merged_prs.txt
              
              # Record merge details
              {
                echo ""
                echo "### âœ… PR #$PR_NUMBER - Merged Successfully"
                echo "**Title:** $PR_TITLE"
                echo "**Author:** @$PR_AUTHOR"
                echo "**Branch:** \`$PR_BRANCH\`"
                echo "**Status:** Clean merge, no conflicts"
                echo ""
              } >> /tmp/merge_details.txt
            else
              echo "âŒ Merge conflict detected for PR #$PR_NUMBER"
              CONFLICT_COUNT=$(cat /tmp/conflict_count.txt)
              echo "$((CONFLICT_COUNT + 1))" > /tmp/conflict_count.txt
              echo "$PR_NUMBER " >> /tmp/conflict_prs.txt
              
              # Get conflict details
              CONFLICTED_FILES=$(git diff --name-only --diff-filter=U | tr '\n' ', ')
              
              # Record conflict details
              {
                echo ""
                echo "### âš ï¸ PR #$PR_NUMBER - Merge Conflict"
                echo "**Title:** $PR_TITLE"
                echo "**Author:** @$PR_AUTHOR"
                echo "**Branch:** \`$PR_BRANCH\`"
                echo "**Status:** Merge conflict"
                echo "**Conflicted Files:** $CONFLICTED_FILES"
                echo ""
                echo "**Conflict Details:**"
                echo "\`\`\`"
                git diff --diff-filter=U | head -100
                echo "\`\`\`"
                echo ""
              } >> /tmp/merge_details.txt
              
              # Abort the merge
              git merge --abort
              
              # Try to resolve automatically (prefer incoming changes with warning)
              echo "ðŸ”§ Attempting automatic conflict resolution..."
              echo "âš ï¸  Note: Using -X theirs strategy (accepting incoming changes)"
              git merge --no-ff --no-edit "$PR_BRANCH" -X theirs || {
                echo "âŒ Automatic resolution failed"
                git merge --abort
                echo "**Resolution:** Requires manual intervention" >> /tmp/merge_details.txt
                echo "" >> /tmp/merge_details.txt
                continue
              }
              
              echo "âœ… Conflicts auto-resolved (accepted incoming changes)"
              echo "**Resolution:** Auto-resolved (accepted incoming changes - review recommended)" >> /tmp/merge_details.txt
              echo "" >> /tmp/merge_details.txt
              MERGED_COUNT=$(cat /tmp/merged_count.txt)
              echo "$((MERGED_COUNT + 1))" > /tmp/merged_count.txt
              echo "$PR_NUMBER " >> /tmp/merged_prs.txt
            fi
          done
          
          # Read final counts from files
          MERGED_COUNT=$(cat /tmp/merged_count.txt)
          CONFLICT_COUNT=$(cat /tmp/conflict_count.txt)
          
          # Save merge report
          {
            echo "# PR Consolidation Merge Report"
            echo ""
            echo "**Total PRs Processed:** ${{ needs.analyze-prs.outputs.pr-count }}"
            echo "**Successfully Merged:** $MERGED_COUNT"
            echo "**Conflicts Encountered:** $CONFLICT_COUNT"
            echo ""
            echo "## Merge Details"
            cat /tmp/merge_details.txt
          } > merge_report.md
          
          cat merge_report.md
          
          # Push consolidation branch
          if [ "$DRY_RUN" != "true" ]; then
            git push origin "$BRANCH_NAME"
          fi
          
          # Save outputs
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat merge_report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "conflicts=$CONFLICT_COUNT" >> $GITHUB_OUTPUT
          echo "merged=$MERGED_COUNT" >> $GITHUB_OUTPUT

      - name: Upload Merge Report
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # ratchet:actions/upload-artifact@v4
        with:
          name: merge-report
          path: merge_report.md

  extract-tasks:
    name: Extract Tasks and Suggestions
    runs-on: ubuntu-latest
    needs: [analyze-prs, consolidate-prs]
    outputs:
      tasks-summary: ${{ steps.extract.outputs.summary }}
      
    steps:
      - name: Download PR Data
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # ratchet:actions/download-artifact@v4
        with:
          name: pr-data

      - name: Extract Action Items
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“ Extracting tasks and suggestions from PRs..."
          
          {
            echo "# Extracted Tasks and Suggestions"
            echo ""
            echo "## Overview"
            echo ""
            echo "This section contains all suggestions, tasks, and action items extracted from the consolidated PRs."
            echo ""
          } > tasks_summary.md
          
          # Process each PR
          jq -c '.[]' filtered_prs.json | while IFS= read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            PR_TITLE=$(echo "$pr" | jq -r '.title')
            PR_BODY=$(echo "$pr" | jq -r '.body // ""')
            PR_AUTHOR=$(echo "$pr" | jq -r '.author.login')
            
            {
              echo "## PR #$PR_NUMBER: $PR_TITLE"
              echo ""
              echo "**Author:** @$PR_AUTHOR"
              echo ""
              echo "### Description"
              echo ""
              echo "$PR_BODY"
              echo ""
              
              # Get PR comments
              echo "### Comments and Discussions"
              echo ""
            } >> tasks_summary.md
            
            gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | "**@\(.author.login)** (comment):\n\n\(.body)\n"' 2>/dev/null >> tasks_summary.md || echo "No comments found" >> tasks_summary.md
            
            echo "" >> tasks_summary.md
            echo "---" >> tasks_summary.md
            echo "" >> tasks_summary.md
          done
          
          # Check for common patterns and extract TODO/FIXME/NOTE
          {
            echo "## Extracted Action Items"
            echo ""
            echo "### Code Comments (TODO, FIXME, NOTE)"
            echo ""
          } >> tasks_summary.md
          
          # Search for TODO/FIXME/NOTE in PR descriptions and comments
          {
            jq -r '.[] | "PR #\(.number): \(.body // "")"' filtered_prs.json | \
              grep -iE "(TODO|FIXME|NOTE|ACTION ITEM|TASK):" || echo "- No explicit action items found in PR descriptions"
          } >> tasks_summary.md
          
          cat tasks_summary.md
          
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat tasks_summary.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload Tasks Summary
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # ratchet:actions/upload-artifact@v4
        with:
          name: tasks-summary
          path: tasks_summary.md

  create-consolidation-pr:
    name: Create Consolidation PR
    runs-on: ubuntu-latest
    needs: [analyze-prs, consolidate-prs, extract-tasks]
    if: github.event.inputs.dry_run != 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2

      - name: Download All Reports
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # ratchet:actions/download-artifact@v4
      - name: Create Consolidation PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ needs.analyze-prs.outputs.consolidation-branch }}"
          
          # Create PR body
          {
            echo "# ðŸ”„ PR Consolidation - $(date +'%Y-%m-%d')"
            echo ""
            echo "This PR consolidates **${{ needs.analyze-prs.outputs.pr-count }}** open pull requests into a single unified PR."
            echo ""
            echo "## ðŸ“Š Summary"
            echo ""
            echo "- **Total PRs Consolidated:** ${{ needs.analyze-prs.outputs.pr-count }}"
            echo "- **Successfully Merged:** ${{ needs.consolidate-prs.outputs.merged }}"
            echo "- **Conflicts Resolved:** ${{ needs.consolidate-prs.outputs.conflicts }}"
            echo "- **Consolidation Branch:** \`$BRANCH_NAME\`"
            echo ""
            echo "## ðŸ“‹ Consolidated PRs"
            echo ""
            
            jq -r '.[] | "- [ ] #\(.number): \(.title) by @\(.author.login)"' pr-data/filtered_prs.json
            
            echo ""
            echo "## ðŸ”€ Merge Report"
            echo ""
            cat merge-report/merge_report.md || echo "No merge report available"
            
            echo ""
            echo "## ðŸ“ Extracted Tasks and Suggestions"
            echo ""
            cat tasks-summary/tasks_summary.md || echo "No tasks extracted"
            
            echo ""
            echo "## âš ï¸ Issues Requiring Decision"
            echo ""
            echo "### Merge Conflicts"
            echo ""
            if [ "${{ needs.consolidate-prs.outputs.conflicts }}" -gt 0 ]; then
              echo "âš ï¸ ${{ needs.consolidate-prs.outputs.conflicts }} PR(s) had merge conflicts that were auto-resolved."
              echo "Please review the merge report above for details."
            else
              echo "âœ… No merge conflicts encountered"
            fi
            
            echo ""
            echo "### Functionality Preservation"
            echo ""
            echo "- [ ] All functionality from original PRs preserved"
            echo "- [ ] No regressions introduced"
            echo "- [ ] All tests passing"
            echo ""
            echo "### Next Steps"
            echo ""
            echo "1. Review the consolidated changes"
            echo "2. Verify all functionality is preserved"
            echo "3. Address any flagged issues above"
            echo "4. Run tests and validation"
            echo "5. Merge this PR to main"
            echo "6. Close all consolidated PRs"
            echo ""
            echo "---"
            echo ""
            echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ""
            echo "_Automated by [pr-consolidation.yml](../.github/workflows/pr-consolidation.yml)_"
          } > pr_body.md
          
          # Create the PR
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "ðŸ”„ Consolidate ${{ needs.analyze-prs.outputs.pr-count }} open PRs - $(date +'%Y-%m-%d')" \
            --body-file pr_body.md \
            --label "consolidation,automation,review-required"

  close-original-prs:
    name: Close Original PRs
    runs-on: ubuntu-latest
    needs: [analyze-prs, consolidate-prs, create-consolidation-pr]
    if: github.event.inputs.dry_run != 'true' && needs.consolidate-prs.outputs.merged > 0
    
    steps:
      - name: Download PR Data
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # ratchet:actions/download-artifact@v4
        with:
          name: pr-data

      - name: Comment and Close PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ needs.analyze-prs.outputs.consolidation-branch }}"
          
          echo "ðŸ”’ Closing consolidated PRs..."
          
          jq -c '.[]' filtered_prs.json | while IFS= read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            
            # Add comment explaining consolidation
            gh pr comment "$PR_NUMBER" --body "**Consolidated**

This PR has been consolidated into a unified PR on branch \\\`${BRANCH_NAME}\\\`.

All changes from this PR have been included in the consolidation. The consolidated PR will be merged to \\\`main\\\` after review.

**Consolidation Details:**
- Consolidated PRs: ${{ needs.analyze-prs.outputs.pr-count }}
- Workflow Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

This PR will now be closed as its changes are preserved in the consolidation.

_Automated by [pr-consolidation.yml](../.github/workflows/pr-consolidation.yml)_"
            
            # Close the PR
            gh pr close "$PR_NUMBER"
            
            echo "âœ… Closed PR #$PR_NUMBER"
          done
          
          echo ""
          echo "ðŸŽ‰ Consolidation complete!"
          echo "All original PRs have been closed."
          echo "The consolidation PR is ready for review."

  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [analyze-prs, consolidate-prs, extract-tasks, create-consolidation-pr, close-original-prs]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ”„ PR Consolidation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total PRs:** ${{ needs.analyze-prs.outputs.pr-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Merged:** ${{ needs.consolidate-prs.outputs.merged }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Conflicts:** ${{ needs.consolidate-prs.outputs.conflicts }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ needs.analyze-prs.outputs.consolidation-branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "This was a dry run. No actual changes were made." >> $GITHUB_STEP_SUMMARY
          else
            echo "1. Review the consolidation PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify all functionality" >> $GITHUB_STEP_SUMMARY
            echo "3. Merge the consolidation PR" >> $GITHUB_STEP_SUMMARY
            echo "4. Verify all original PRs are closed" >> $GITHUB_STEP_SUMMARY
          fi
