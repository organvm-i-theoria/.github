name: Branch Cleanup Notification

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read

jobs:
  detect-stale-branches:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2

      - name: Install GitHub CLI
        run: |
          type gh >/dev/null 2>&1 || {
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          }

      - name: Detect stale branches
        id: stale
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Make script executable if not already
          chmod +x ./.github/scripts/detect-stale-branches.sh
          
          # Detect branches older than 14 days
          STALE_BRANCHES=$(./.github/scripts/detect-stale-branches.sh "${{ github.repository }}" 14 2>&1 || echo "")
          
          # Check if we have actual branch data (more than just headers)
          BRANCH_COUNT=$(echo "$STALE_BRANCHES" | grep -v "^BRANCH NAME" | grep -v "^=" | grep -v "^Note:" | grep -v "^Run with:" | grep -v "^Detecting" | grep -v "^$" | wc -l)
          
          if [ "$BRANCH_COUNT" -gt 0 ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "$STALE_BRANCHES" > stale-branches.txt
            echo "Found $BRANCH_COUNT stale branches"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No stale branches found"
          fi

      - name: Create issue for stale branches
        if: steps.stale.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCHES=$(cat stale-branches.txt || echo "No branches listed")
          ISSUE_TITLE="Branch Cleanup: $(date +%Y-%m-%d)"
          
          # Check if an open issue with similar title already exists
          EXISTING_ISSUE=$(gh issue list --label "branch-cleanup" --state open --search "$ISSUE_TITLE" --json number --jq '.[0].number' || echo "")
          
          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Issue already exists: #$EXISTING_ISSUE"
            CURRENT_DATE=$(date -u +'%Y-%m-%d %H:%M UTC')
            cat > issue-comment.md << 'COMMENT_EOF'
          **Updated stale branch list:**
          
          ```
          COMMENT_EOF
            echo "$BRANCHES" >> issue-comment.md
            cat >> issue-comment.md << COMMENT_EOF
          \`\`\`
          
          Updated: ${CURRENT_DATE}
          COMMENT_EOF
            gh issue comment "$EXISTING_ISSUE" --body-file issue-comment.md
          else
            cat > issue-body.md << 'BODY_EOF'
          ## Stale Branches Detected
          
          The following branches have not been updated in 14+ days:
          
          ```
          BODY_EOF
            echo "$BRANCHES" >> issue-body.md
            cat >> issue-body.md << 'BODY_EOF'
          ```
          
          **Action Required**: Branch owners, please take action on your stale branches:
          
          1. **Merge** if work is complete (create a PR to `main`)
          2. **Update** if work is ongoing (push a commit to show activity)
          3. **Archive** if work is abandoned but valuable (reply to this issue with branch name)
          4. **Delete** if no longer needed (reply to this issue with branch name)
          
          **Policy Reference**: See [Logical Branch Policy](.github/logical-branch-policy.md)
          
          **Deadline**: Branches not addressed within 7 days will be automatically archived or deleted per policy.
          
          ---
          *This issue was automatically generated by the Branch Cleanup workflow. See `.github/workflows/branch-cleanup-notify.yml`*
          BODY_EOF
            gh issue create \
              --title "$ISSUE_TITLE" \
              --label "chore,branch-cleanup" \
              --body-file issue-body.md
          fi
