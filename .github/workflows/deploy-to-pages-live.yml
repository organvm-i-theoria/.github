name: Deploy Live App to GitHub Pages

on:
  push:
    branches:
    - main
    - master
    paths:
    - src/**
    - public/**
    - package*.json
    - requirements.txt
    - Dockerfile
    - .github/workflows/deploy-to-pages-live.yml
  workflow_dispatch:
    inputs:
      deployment_strategy:
        description: Deployment strategy to use
        required: false
        type: choice
        options:
        - auto
        - pages-direct
        - docker
        - codespaces
        - documentation-only
        default: auto
      force_deploy:
        description: Force deployment even if no changes detected
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      deployment_strategy:
        description: Deployment strategy to use
        required: false
        type: string
        default: auto
      force_deploy:
        description: Force deployment even if no changes detected
        required: false
        type: boolean
        default: false

concurrency:
  group: pages-live-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

jobs:
  detect-app-type:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      app_type: ${{ steps.detect.outputs.app_type }}
      deployment_strategy: ${{ steps.detect.outputs.deployment_strategy }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
      has_backend: ${{ steps.detect.outputs.has_backend }}
      startup_command: ${{ steps.detect.outputs.startup_command }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Load deployment configuration
      id: load-config
      run: |
        CONFIG_FILE=".github/app-deployment-config.yml"

        if [ -f "$CONFIG_FILE" ]; then
          echo "enabled=$(yq eval '.deployment.enabled // true' "$CONFIG_FILE")" >> $GITHUB_OUTPUT
          echo "strategy=$(yq eval '.deployment.strategy // "auto"' "$CONFIG_FILE")" >> $GITHUB_OUTPUT
          echo "startup_command=$(yq eval '.deployment.startup_command // ""' "$CONFIG_FILE")" >> $GITHUB_OUTPUT
        else
          echo "enabled=true" >> $GITHUB_OUTPUT
          echo "strategy=auto" >> $GITHUB_OUTPUT
          echo "startup_command=" >> $GITHUB_OUTPUT
        fi

    - name: Detect application type
      id: detect
      env:
        INPUT_DEPLOYMENT_STRATEGY: ${{ inputs.deployment_strategy }}
        EVENT_DEPLOYMENT_STRATEGY: ${{ github.event.inputs.deployment_strategy }}
        INPUT_FORCE_DEPLOY: ${{ inputs.force_deploy }}
        EVENT_FORCE_DEPLOY: ${{ github.event.inputs.force_deploy }}
      run: |
        echo "ðŸ” Detecting application type..."

        # Resolve strategy input (workflow_call or workflow_dispatch)
        STRATEGY="$INPUT_DEPLOYMENT_STRATEGY"
        if [ -z "$STRATEGY" ]; then
          STRATEGY="$EVENT_DEPLOYMENT_STRATEGY"
        fi
        if [ -z "$STRATEGY" ]; then
          STRATEGY="auto"
        fi

        if [ -n "$STRATEGY" ] && [ "$STRATEGY" != "auto" ]; then
          echo "deployment_strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "app_type=manual" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Use config file strategy if specified
        CONFIG_STRATEGY="${{ steps.load-config.outputs.strategy }}"
        if [ -n "$CONFIG_STRATEGY" ] && [ "$CONFIG_STRATEGY" != "auto" ]; then
          echo "deployment_strategy=$CONFIG_STRATEGY" >> $GITHUB_OUTPUT
          echo "app_type=configured" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Auto-detect based on project files
        HAS_FRONTEND=false
        HAS_BACKEND=false
        APP_TYPE="unknown"
        DEPLOYMENT_STRATEGY="documentation-only"

        # Check for frontend frameworks
        if [ -f "package.json" ]; then
          if grep -q '"react"' package.json || grep -q '"next"' package.json || grep -q '"vue"' package.json || grep -q '"angular"' package.json; then
            HAS_FRONTEND=true
            APP_TYPE="frontend"
            DEPLOYMENT_STRATEGY="pages-direct"
          fi
        fi

        # Check for backend frameworks
        if [ -f "package.json" ]; then
          if grep -q '"express"' package.json || grep -q '"fastify"' package.json || grep -q '"koa"' package.json; then
            HAS_BACKEND=true
            APP_TYPE="backend"
            DEPLOYMENT_STRATEGY="docker"
          fi
        fi

        if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
          if grep -qE "(flask|django|fastapi)" requirements.txt 2>/dev/null || grep -qE "(flask|django|fastapi)" pyproject.toml 2>/dev/null; then
            HAS_BACKEND=true
            APP_TYPE="backend"
            DEPLOYMENT_STRATEGY="docker"
          fi
        fi

        # Check for static sites
        if [ -f "index.html" ] || [ -d "public" ] || [ -d "dist" ] || [ -d "build" ]; then
          if [ "$HAS_FRONTEND" = "false" ]; then
            HAS_FRONTEND=true
            APP_TYPE="static"
            DEPLOYMENT_STRATEGY="pages-direct"
          fi
        fi

        # Full-stack apps
        if [ "$HAS_FRONTEND" = "true" ] && [ "$HAS_BACKEND" = "true" ]; then
          APP_TYPE="fullstack"
          DEPLOYMENT_STRATEGY="docker"
        fi

        # CLI/Library projects
        if [ -f "setup.py" ] || [ -f "Cargo.toml" ] || grep -q '"bin"' package.json 2>/dev/null; then
          if [ "$HAS_FRONTEND" = "false" ] && [ "$HAS_BACKEND" = "false" ]; then
            APP_TYPE="cli-library"
            DEPLOYMENT_STRATEGY="documentation-only"
          fi
        fi

        echo "app_type=$APP_TYPE" >> $GITHUB_OUTPUT
        echo "deployment_strategy=$DEPLOYMENT_STRATEGY" >> $GITHUB_OUTPUT
        echo "has_frontend=$HAS_FRONTEND" >> $GITHUB_OUTPUT
        echo "has_backend=$HAS_BACKEND" >> $GITHUB_OUTPUT
        echo "startup_command=${{ steps.load-config.outputs.startup_command }}" >> $GITHUB_OUTPUT

        echo "âœ… Detected: $APP_TYPE - Strategy: $DEPLOYMENT_STRATEGY"

  deploy-pages-direct:
    needs: detect-app-type
    if: needs.detect-app-type.outputs.deployment_strategy == 'pages-direct'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # ratchet:actions/setup-node@v4
      with:
        node-version: '18'
        cache: npm

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: |
        if [ -f "package.json" ] && grep -q '"build"' package.json; then
          npm run build
        else
          echo "No build script found, skipping build step"
        fi

    - name: Setup Pages
      uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b  # ratchet:actions/configure-pages@v5.0.0

    - name: Upload artifact
      uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa  # ratchet:actions/upload-pages-artifact@v3.0.1
      with:
        path: ./dist

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e  # ratchet:actions/deploy-pages@v4.0.5

    - name: Generate deployment metadata
      run: |
        DEPLOY_URL="${{ steps.deployment.outputs.page_url }}"
        TIMESTAMP="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        cat > deployment-metadata.json <<-EOF
        {
          "repository": "${{ github.repository }}",
          "source_url": "https://github.com/${{ github.repository }}",
          "app_type": "${{ needs.detect-app-type.outputs.app_type }}",
          "deployment_strategy": "pages-direct",
          "live_url": "$DEPLOY_URL",
          "status": "deployed",
          "last_updated": "$TIMESTAMP"
        }
        EOF

    - name: Upload deployment metadata
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: app-deployment
        path: deployment-metadata.json
        retention-days: 7

  deploy-docker:
    needs: detect-app-type
    if: needs.detect-app-type.outputs.deployment_strategy == 'docker'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # ratchet:docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9  # ratchet:docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051  # ratchet:docker/metadata-action@v5
      with:
        images: ${{ github.repository }}

    - name: Build and push Docker image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83  # ratchet:docker/build-push-action@v6
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.58.1

    - name: Scan container image for vulnerabilities
      run: |
        IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n 1)
        trivy image --format sarif --output trivy-results.sarif --severity CRITICAL,HIGH "$IMAGE_TAG" || true

    - name: Upload Trivy scan results
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: trivy-container-scan
        path: trivy-results.sarif
        retention-days: 30

    - name: Create embed page
      run: |
        mkdir -p docs/live-apps
        cat > docs/live-apps/${{ github.event.repository.name }}.md <<- 'EOF'
        ---
        layout: app-demo
        title: "Live Demo: ${{ github.event.repository.name }}"
        repository: "${{ github.repository }}"
        docker_image: "${{ steps.meta.outputs.tags }}"
        ---

        # Live Demo: ${{ github.event.repository.name }}

        This is a live demonstration of the application running in a Docker container.
        EOF

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add docs/live-apps/
        git commit -m "chore: add live app embed page [skip ci]" || echo "No changes to commit"
        git push || echo "No changes to push"

    - name: Generate deployment metadata
      run: |
        TAGS="${{ steps.meta.outputs.tags }}"
        PRIMARY_TAG=$(echo "$TAGS" | head -n 1)
        TIMESTAMP="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        cat > deployment-metadata.json <<-'EOF'
        {
          "repository": "${{ github.repository }}",
          "source_url": "https://github.com/${{ github.repository }}",
          "app_type": "${{ needs.detect-app-type.outputs.app_type }}",
          "deployment_strategy": "docker",
          "docker_image": "$PRIMARY_TAG",
          "status": "deployed",
          "last_updated": "$TIMESTAMP"
        }
        EOF

    - name: Upload deployment metadata
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: app-deployment
        path: deployment-metadata.json
        retention-days: 7

  deploy-codespaces:
    needs: detect-app-type
    if: needs.detect-app-type.outputs.deployment_strategy == 'codespaces'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Create Codespaces configuration
      run: |
        mkdir -p .devcontainer

        if [ ! -f ".devcontainer/devcontainer.json" ]; then
          cat > .devcontainer/devcontainer.json <<- 'EOF'
          {
            "name": "${{ github.event.repository.name }} Development",
            "image": "mcr.microsoft.com/devcontainers/universal:2",
            "features": {
              "ghcr.io/devcontainers/features/node:1": {},
              "ghcr.io/devcontainers/features/python:1": {},
              "ghcr.io/devcontainers/features/docker-in-docker:2": {}
            },
            "postCreateCommand": "echo 'Environment ready!'",
            "forwardPorts": [3000, 5000, 8000, 8080]
          }
          EOF
        fi

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .devcontainer/
        git commit -m "chore: add Codespaces configuration [skip ci]" || echo "No changes to commit"
        git push || echo "No changes to push"

    - name: Generate deployment metadata
      run: |
        TIMESTAMP="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        cat > deployment-metadata.json <<-'EOF'
        {
          "repository": "${{ github.repository }}",
          "source_url": "https://github.com/${{ github.repository }}",
          "app_type": "${{ needs.detect-app-type.outputs.app_type }}",
          "deployment_strategy": "codespaces",
          "codespaces_url": "https://github.com/${{ github.repository }}/codespaces",
          "status": "deployed",
          "last_updated": "$TIMESTAMP"
        }
        EOF

    - name: Upload deployment metadata
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: app-deployment
        path: deployment-metadata.json
        retention-days: 7

  deploy-documentation-only:
    needs: detect-app-type
    if: needs.detect-app-type.outputs.deployment_strategy == 'documentation-only'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Generate deployment metadata
      run: |
        TIMESTAMP="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        cat > deployment-metadata.json <<-'EOF'
        {
          "repository": "${{ github.repository }}",
          "source_url": "https://github.com/${{ github.repository }}",
          "app_type": "${{ needs.detect-app-type.outputs.app_type }}",
          "deployment_strategy": "documentation-only",
          "documentation_url": "${{ github.event.repository.html_url }}/blob/main/README.md",
          "status": "documentation",
          "last_updated": "$TIMESTAMP"
        }
        EOF

    - name: Upload deployment metadata
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: app-deployment
        path: deployment-metadata.json
        retention-days: 7
