name: Deploy to GitHub Pages Live

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_strategy:
        description: 'Force specific deployment strategy'
        required: false
        type: choice
        options:
          - auto
          - pages_direct
          - docker
          - codespaces
          - none

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  detect-strategy:
    runs-on: ubuntu-latest
    outputs:
      strategy: ${{ steps.detect.outputs.strategy }}
      app_type: ${{ steps.detect.outputs.app_type }}
      port: ${{ steps.detect.outputs.port }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect application type and deployment strategy
        id: detect
        run: |
          echo "Detecting application type and deployment strategy..."
          
          # Check for manual override
          if [ "${{ github.event.inputs.force_strategy }}" != "" ] && [ "${{ github.event.inputs.force_strategy }}" != "auto" ]; then
            echo "strategy=${{ github.event.inputs.force_strategy }}" >> $GITHUB_OUTPUT
            echo "Manual strategy override: ${{ github.event.inputs.force_strategy }}"
            exit 0
          fi
          
          # Load config if exists
          CONFIG_FILE=".github/app-deployment-config.yml"
          if [ -f "$CONFIG_FILE" ]; then
            CONFIGURED_STRATEGY=$(grep "^deployment_strategy:" "$CONFIG_FILE" | awk '{print $2}' || echo "auto")
            if [ "$CONFIGURED_STRATEGY" != "auto" ]; then
              echo "strategy=$CONFIGURED_STRATEGY" >> $GITHUB_OUTPUT
              echo "Using configured strategy: $CONFIGURED_STRATEGY"
              exit 0
            fi
          fi
          
          STRATEGY="none"
          APP_TYPE="unknown"
          PORT="3000"
          
          # Strategy A: Static/Frontend Apps (Pages Direct)
          if [ -f "package.json" ]; then
            if grep -q "\"react\"" package.json; then
              STRATEGY="pages_direct"
              APP_TYPE="react"
              PORT="3000"
            elif grep -q "\"vue\"" package.json; then
              STRATEGY="pages_direct"
              APP_TYPE="vue"
              PORT="8080"
            elif grep -q "\"@angular/core\"" package.json; then
              STRATEGY="pages_direct"
              APP_TYPE="angular"
              PORT="4200"
            elif grep -q "\"next\"" package.json; then
              STRATEGY="pages_direct"
              APP_TYPE="nextjs"
              PORT="3000"
            fi
          fi
          
          # Check for pure static HTML
          if [ -f "index.html" ] && [ ! -f "package.json" ] && [ ! -f "requirements.txt" ]; then
            STRATEGY="pages_direct"
            APP_TYPE="static"
            PORT="80"
          fi
          
          # Strategy B: Backend Apps (Docker)
          if [ -f "Dockerfile" ]; then
            STRATEGY="docker"
            if [ -f "package.json" ]; then
              if grep -q "\"express\"" package.json; then
                APP_TYPE="express"
                PORT="3000"
              else
                APP_TYPE="nodejs-backend"
                PORT="3000"
              fi
            elif [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
              if [ -f "app.py" ]; then
                APP_TYPE="flask"
                PORT="5000"
              elif grep -q "fastapi\|uvicorn" requirements.txt 2>/dev/null; then
                APP_TYPE="fastapi"
                PORT="8000"
              elif [ -f "manage.py" ]; then
                APP_TYPE="django"
                PORT="8000"
              else
                APP_TYPE="python-backend"
                PORT="8000"
              fi
            fi
          fi
          
          # Strategy C: Complex Apps (Codespaces)
          if [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
            STRATEGY="codespaces"
            APP_TYPE="microservices"
          fi
          
          if [ -f ".devcontainer/devcontainer.json" ]; then
            STRATEGY="codespaces"
          fi
          
          # Strategy D: CLI/Libraries (None)
          if [ -f "package.json" ]; then
            if grep -q "\"bin\":" package.json; then
              STRATEGY="none"
              APP_TYPE="cli"
            fi
          fi
          
          if [ -f "setup.py" ] && grep -q "entry_points" setup.py; then
            STRATEGY="none"
            APP_TYPE="cli"
          fi
          
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "app_type=$APP_TYPE" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "Detected strategy: $STRATEGY, app_type: $APP_TYPE, port: $PORT"

  deploy-pages-direct:
    needs: detect-strategy
    if: needs.detect-strategy.outputs.strategy == 'pages_direct'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: contains(needs.detect-strategy.outputs.app_type, 'react') || contains(needs.detect-strategy.outputs.app_type, 'vue') || contains(needs.detect-strategy.outputs.app_type, 'angular') || contains(needs.detect-strategy.outputs.app_type, 'next')
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: contains(needs.detect-strategy.outputs.app_type, 'react') || contains(needs.detect-strategy.outputs.app_type, 'vue') || contains(needs.detect-strategy.outputs.app_type, 'angular') || contains(needs.detect-strategy.outputs.app_type, 'next')
        run: npm ci

      - name: Build application
        if: contains(needs.detect-strategy.outputs.app_type, 'react') || contains(needs.detect-strategy.outputs.app_type, 'vue') || contains(needs.detect-strategy.outputs.app_type, 'angular') || contains(needs.detect-strategy.outputs.app_type, 'next')
        run: |
          if [ "${{ needs.detect-strategy.outputs.app_type }}" = "react" ] || [ "${{ needs.detect-strategy.outputs.app_type }}" = "nextjs" ]; then
            npm run build
          elif [ "${{ needs.detect-strategy.outputs.app_type }}" = "vue" ]; then
            npm run build
          elif [ "${{ needs.detect-strategy.outputs.app_type }}" = "angular" ]; then
            npm run build -- --configuration production
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: |
            build
            dist
            .next
            out
            .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Update deployment metadata
        run: |
          echo "Deployment URL: ${{ steps.deployment.outputs.page_url }}"
          
          # Update app-deployments registry
          mkdir -p docs/_data
          
          cat >> docs/_data/app-deployments.yml << EOF
            - app_name: "${{ github.event.repository.name }}"
              deployment_strategy: "pages_direct"
              live_url: "${{ steps.deployment.outputs.page_url }}"
              status: "deployed"
              last_updated: "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          EOF

  deploy-docker:
    needs: detect-strategy
    if: needs.detect-strategy.outputs.strategy == 'docker'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger Docker build workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docker-build-push.yml',
              ref: 'main'
            });
            console.log('Docker build workflow triggered');

      - name: Update deployment metadata
        run: |
          echo "Docker deployment triggered"
          
          mkdir -p docs/_data
          cat >> docs/_data/app-deployments.yml << EOF
            - app_name: "${{ github.event.repository.name }}"
              deployment_strategy: "docker"
              status: "building"
              last_updated: "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          EOF

  deploy-codespaces:
    needs: detect-strategy
    if: needs.detect-strategy.outputs.strategy == 'codespaces'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create/update devcontainer configuration
        run: |
          mkdir -p .devcontainer
          
          if [ ! -f ".devcontainer/devcontainer.json" ]; then
            cat > .devcontainer/devcontainer.json << 'EOF'
          {
            "name": "${{ github.event.repository.name }}",
            "image": "mcr.microsoft.com/devcontainers/universal:latest",
            "features": {
              "ghcr.io/devcontainers/features/node:1": {},
              "ghcr.io/devcontainers/features/python:1": {},
              "ghcr.io/devcontainers/features/docker-in-docker:2": {}
            },
            "customizations": {
              "vscode": {
                "extensions": [
                  "dbaeumer.vscode-eslint",
                  "esbenp.prettier-vscode"
                ]
              }
            },
            "forwardPorts": [${{ needs.detect-strategy.outputs.port }}],
            "postCreateCommand": "npm install || pip install -r requirements.txt || true"
          }
          EOF
          fi

      - name: Generate Codespaces button
        run: |
          CODESPACES_URL="https://codespaces.new/${{ github.repository }}"
          echo "Codespaces URL: $CODESPACES_URL"
          
          # Update README with Codespaces badge
          if [ -f "README.md" ]; then
            BADGE="[![Open in GitHub Codespaces](https://github.com/codespaces/badge.svg)](${CODESPACES_URL})"
            
            if ! grep -q "Open in GitHub Codespaces" README.md; then
              sed -i "0,/^#/s|\(^#.*\)|\1\n\n${BADGE}|" README.md
            fi
          fi
          
          # Update deployment metadata
          mkdir -p docs/_data
          cat >> docs/_data/app-deployments.yml << EOF
            - app_name: "${{ github.event.repository.name }}"
              deployment_strategy: "codespaces"
              codespaces_url: "$CODESPACES_URL"
              status: "deployed"
              last_updated: "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .devcontainer/ README.md docs/_data/
          
          if ! git diff --staged --quiet; then
            git commit -m "feat: Add Codespaces configuration [skip ci]"
            git push
          fi

  skip-deployment:
    needs: detect-strategy
    if: needs.detect-strategy.outputs.strategy == 'none'
    runs-on: ubuntu-latest
    steps:
      - name: Log skip reason
        run: |
          echo "Application type: ${{ needs.detect-strategy.outputs.app_type }}"
          echo "This is a CLI tool or library - no live demo deployment needed"
          echo "Video walkthrough will be the primary showcase"

      - name: Update deployment metadata
        run: |
          mkdir -p docs/_data
          cat >> docs/_data/app-deployments.yml << EOF
            - app_name: "${{ github.event.repository.name }}"
              deployment_strategy: "none"
              status: "none"
              reason: "CLI tool or library - no web interface"
              last_updated: "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          EOF

  create-deployment-pr:
    needs: [detect-strategy, deploy-pages-direct, deploy-docker, deploy-codespaces, skip-deployment]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat: Update deployment configuration and metadata'
          title: 'ðŸŒ Live Deployment Update - ${{ needs.detect-strategy.outputs.strategy }}'
          body: |
            ## Live Deployment Update
            
            **Strategy:** ${{ needs.detect-strategy.outputs.strategy }}
            **App Type:** ${{ needs.detect-strategy.outputs.app_type }}
            **Port:** ${{ needs.detect-strategy.outputs.port }}
            
            ### Deployment Details
            
            {% if needs.detect-strategy.outputs.strategy == 'pages_direct' %}
            âœ… **Static deployment to GitHub Pages**
            - Built and deployed successfully
            - Access via GitHub Pages URL
            {% elsif needs.detect-strategy.outputs.strategy == 'docker' %}
            ðŸ³ **Docker containerization**
            - Docker image building
            - Will be available via container registry
            {% elsif needs.detect-strategy.outputs.strategy == 'codespaces' %}
            ðŸš€ **GitHub Codespaces ready**
            - Devcontainer configuration created
            - Open in Codespaces button added to README
            {% else %}
            ðŸ“¦ **CLI/Library - No live demo**
            - This application doesn't require live deployment
            - Video walkthrough is the primary showcase
            {% endif %}
            
            ---
            *Deployed automatically by Live Deployment workflow*
          branch: live-deployment-update
          delete-branch: true
