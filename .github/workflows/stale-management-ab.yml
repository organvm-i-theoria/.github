name: Stale Management (A/B Test)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      dryRun:
        description: "Dry run (no actual stale marking)"
        required: false
        default: "false"
        type: boolean

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  determine-grace-period:
    name: Determine Grace Period (A/B Test)
    runs-on: ubuntu-latest
    outputs:
      grace-period: ${{ steps.assign.outputs.grace-period }}
      group: ${{ steps.assign.outputs.group }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install PyYAML

      - name: Determine A/B test group
        id: assign
        run: |
          python3 automation/scripts/ab_test_assignment.py \
            --repo "${{ github.repository }}" \
            --json > assignment.json

          GRACE_PERIOD=$(jq -r '.gracePeriod' assignment.json)
          GROUP=$(jq -r '.group' assignment.json)

          echo "grace-period=${GRACE_PERIOD}" >> $GITHUB_OUTPUT
          echo "group=${GROUP}" >> $GITHUB_OUTPUT

          echo "Repository assigned to: ${GROUP}"
          echo "Grace period: ${GRACE_PERIOD} days"

      - name: Upload assignment
        uses: actions/upload-artifact@v4
        with:
          name: ab-test-assignment
          path: assignment.json
          retention-days: 90

  mark-stale:
    name: Mark Stale Issues and PRs
    runs-on: ubuntu-latest
    needs: determine-grace-period

    steps:
      - name: Mark stale issues and PRs
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

          # Use A/B test grace period
          days-before-stale: ${{ needs.determine-grace-period.outputs.grace-period }}
          days-before-close: 7

          # Stale issue configuration
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had recent activity.

            **Grace Period:** ${{ needs.determine-grace-period.outputs.grace-period }} days
            **A/B Test Group:** ${{ needs.determine-grace-period.outputs.group }}

            It will be closed in 7 days if no further activity occurs. Thank you for your contributions!

            If this issue is still relevant, please comment to keep it open.

          stale-issue-label: "stale"
          close-issue-message: |
            This issue was automatically closed because it has been stale for 7 days with no activity.

            If you believe this was closed in error, please reopen it and let us know!

          # Stale PR configuration
          stale-pr-message: |
            This pull request has been automatically marked as stale because it has not had recent activity.

            **Grace Period:** ${{ needs.determine-grace-period.outputs.grace-period }} days
            **A/B Test Group:** ${{ needs.determine-grace-period.outputs.group }}

            It will be closed in 7 days if no further activity occurs. Thank you for your contributions!

            If this PR is still relevant, please comment or push new commits to keep it open.

          stale-pr-label: "stale"
          close-pr-message: |
            This pull request was automatically closed because it has been stale for 7 days with no activity.

            If you believe this was closed in error, please reopen it and let us know!

          # Exempt labels
          exempt-issue-labels: "security,critical,pinned,good-first-issue"
          exempt-pr-labels: "security,critical,pinned,work-in-progress"

          # Exempt milestones
          exempt-milestones: true

          # Exempt all issues/PRs with assignees
          exempt-all-assignees: false

          # Operations per run (avoid rate limits)
          operations-per-run: 100

          # Remove stale label when activity resumes
          remove-stale-when-updated: true

          # Dry run mode
          debug-only: ${{ github.event.inputs.dryRun == 'true' }}

  track-metrics:
    name: Track A/B Test Metrics
    runs-on: ubuntu-latest
    needs: [determine-grace-period, mark-stale]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download assignment
        uses: actions/download-artifact@v4
        with:
          name: ab-test-assignment

      - name: Track stale events
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get workflow run details
          RUN_ID="${{ github.run_id }}"
          REPO="${{ github.repository }}"
          GROUP="${{ needs.determine-grace-period.outputs.group }}"
          GRACE_PERIOD="${{ needs.determine-grace-period.outputs.grace-period }}"

          # Count stale issues and PRs
          STALE_ISSUES=$(gh issue list --repo "$REPO" --label "stale" --json number --jq '. | length')
          STALE_PRS=$(gh pr list --repo "$REPO" --label "stale" --json number --jq '. | length')

          # Create metrics file
          cat > stale-metrics.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "$REPO",
            "runId": "$RUN_ID",
            "abTest": {
              "group": "$GROUP",
              "gracePeriod": $GRACE_PERIOD
            },
            "metrics": {
              "staleIssues": $STALE_ISSUES,
              "stalePRs": $STALE_PRS,
              "total": $((STALE_ISSUES + STALE_PRS))
            }
          }
          EOF

          echo "Metrics tracked:"
          cat stale-metrics.json

      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: stale-metrics-${{ github.run_id }}
          path: stale-metrics.json
          retention-days: 90

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [determine-grace-period, mark-stale, track-metrics]
    if: always() && needs.mark-stale.result == 'failure'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send Slack notification
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          priority: "P2"
          title: "Stale Management Workflow Failed"
          message: |
            A/B Test Group: ${{ needs.determine-grace-period.outputs.group }}
            Grace Period: ${{ needs.determine-grace-period.outputs.grace-period }} days

            The stale management workflow encountered an error.
          workflow-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          repository: ${{ github.repository }}
