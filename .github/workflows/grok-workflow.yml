name: Grok Workflow

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: The prompt for the Grok task
        required: true

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  grok:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4.2.2

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5.3.0
      with:
        python-version: "3.12"
        cache: pip

    - name: Check quota
      id: quota
      run: |
        usage=$(python scripts/quota_manager.py get_usage "Grok_API")
        quota=$(jq -r '.subscriptions[] | select(.name=="Grok_API") | .quota' .github/subscriptions.json)
        echo "usage=$usage" >> $GITHUB_OUTPUT
        echo "quota=$quota" >> $GITHUB_OUTPUT

    - name: Run Grok Task
      if: ${{ steps.quota.outputs.usage < steps.quota.outputs.quota }}
      env:
        GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        INPUT_PROMPT: ${{ github.event.inputs.prompt }}
      run: |
        echo "Running Grok task with prompt: $INPUT_PROMPT"
        # Simulate a variable cost based on prompt length
        prompt_length=${#INPUT_PROMPT}
        cost=$(echo "scale=4; $prompt_length * 0.0002" | bc)
        echo "Simulated cost: $cost"
        python scripts/quota_manager.py increment_usage "Grok_API" $cost

        # Simulate output
        echo "This is a simulated output from Grok for the prompt: $INPUT_PROMPT" > grok_output_${{ github.run_id }}.txt

    - name: Queue Task
      if: ${{ steps.quota.outputs.usage >= steps.quota.outputs.quota }}
      run: |
        task='{ "subscription": "Grok_API", "details": "..." }'
        python scripts/quota_manager.py add_task "$task"
        echo "Grok API quota reached. Task queued."

    - name: Commit state changes
      if: always()
      run: |
        ./scripts/commit_changes.sh "chore: update state for Grok task"
