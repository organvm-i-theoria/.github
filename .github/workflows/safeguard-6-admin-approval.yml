name: 'Safeguard 6: Admin Approval Dashboard'

on:
  workflow_dispatch:
    inputs:
      batch_run_id:
        description: Batch run identifier to review
        required: false
        type: string
      auto_approve_quality_threshold:
        description: Auto-approve if quality score >= threshold (0-100)
        required: false
        default: '85'
        type: string
  workflow_run:
    workflows: [org-walkthrough-generator, scheduled-walkthrough-generator]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  generate-approval-dashboard:
    name: Generate Approval Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies
      run: |
        pip install pyyaml requests pillow
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Collect pending walkthroughs
      id: collect
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BATCH_RUN_ID: ${{ github.event.inputs.batch_run_id || github.event.workflow_run.id }}
      run: |
        python3 << 'PYTHON_SCRIPT'
        import os
        import json
        import yaml
        import requests
        import subprocess
        from pathlib import Path
        from datetime import datetime

        github_token = os.getenv('GITHUB_TOKEN')
        repo = os.getenv('GITHUB_REPOSITORY')
        batch_run_id = os.getenv('BATCH_RUN_ID', 'unknown')

        headers = {
            'Authorization': f'token {github_token}',
            'Accept': 'application/vnd.github.v3+json'
        }

        # Find open PRs created by walkthrough workflows
        url = f'https://api.github.com/repos/{repo}/pulls'
        params = {
            'state': 'open',
            'sort': 'created',
            'direction': 'desc',
            'per_page': 50
        }

        response = requests.get(url, headers=headers, params=params)
        response.raise_for_status()
        pulls = response.json()

        # Filter PRs created by walkthrough workflows
        walkthrough_prs = []
        for pr in pulls:
            # Check if PR was created by bot and has walkthrough label
            if 'walkthrough' in pr.get('title', '').lower() or 'bot' in pr['user']['login']:
                # Get PR files to check for videos
                files_url = pr['_links']['self']['href'] + '/files'
                files_resp = requests.get(files_url, headers=headers)
                files = files_resp.json()

                video_files = [f for f in files if f['filename'].endswith('.mp4')]
                metadata_files = [f for f in files if f['filename'].endswith('.json') and 'metadata' in f['filename']]

                if video_files:
                    walkthrough_prs.append({
                        'number': pr['number'],
                        'title': pr['title'],
                        'url': pr['html_url'],
                        'created_at': pr['created_at'],
                        'video_files': video_files,
                        'metadata_files': metadata_files,
                        'branch': pr['head']['ref']
                    })

        print(f"Found {len(walkthrough_prs)} pending walkthrough PRs")

        # Save PR data
        with open('pending_approvals.json', 'w') as f:
            json.dump(walkthrough_prs, f, indent=2)

        # Set output
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"pending_count={len(walkthrough_prs)}\n")
            f.write(f"has_pending={'true' if walkthrough_prs else 'false'}\n")

        print(f"Pending approvals: {len(walkthrough_prs)}")
        PYTHON_SCRIPT

    - name: Generate video thumbnails
      if: steps.collect.outputs.has_pending == 'true'
      run: |
        python3 << 'PYTHON_SCRIPT'
        import json
        import subprocess
        import os
        from pathlib import Path

        with open('pending_approvals.json', 'r') as f:
            prs = json.load(f)

        thumbnails_dir = Path('approval-dashboard/thumbnails')
        thumbnails_dir.mkdir(parents=True, exist_ok=True)

        for pr in prs:
            pr_num = pr['number']
            for video_file in pr['video_files']:
                video_path = video_file['filename']
                if Path(video_path).exists():
                    # Generate thumbnail at 5 second mark
                    thumbnail_path = thumbnails_dir / f"pr-{pr_num}-{Path(video_path).stem}.jpg"
                    cmd = [
                        'ffmpeg', '-y',
                        '-i', str(video_path),
                        '-ss', '00:00:05',
                        '-vframes', '1',
                        '-vf', 'scale=640:360',
                        str(thumbnail_path)
                    ]
                    try:
                        subprocess.run(cmd, check=True, capture_output=True)
                        print(f"Generated thumbnail: {thumbnail_path}")
                    except Exception as e:
                        print(f"Error generating thumbnail for {video_path}: {e}")
        PYTHON_SCRIPT

    - name: Calculate quality scores
      if: steps.collect.outputs.has_pending == 'true'
      id: quality
      run: |
        python3 << 'PYTHON_SCRIPT'
        import json
        import subprocess
        import os
        from pathlib import Path

        def calculate_quality_score(video_path):
            """Calculate quality score based on video properties"""
            score = 100

            try:
                # Get video info using ffprobe
                cmd = [
                    'ffprobe', '-v', 'error',
                    '-select_streams', 'v:0',
                    '-show_entries', 'stream=width,height,bit_rate,duration',
                    '-show_entries', 'format=duration,size',
                    '-of', 'json',
                    str(video_path)
                ]
                result = subprocess.run(cmd, capture_output=True, text=True, check=True)
                info = json.loads(result.stdout)

                stream = info.get('streams', [{}])[0]
                format_info = info.get('format', {})

                width = int(stream.get('width', 0))
                height = int(stream.get('height', 0))
                duration = float(format_info.get('duration', 0))
                size = int(format_info.get('size', 0))

                # Resolution check (expect 1920x1080 or similar)
                if width < 1280 or height < 720:
                    score -= 20
                elif width < 1920 or height < 1080:
                    score -= 10

                # Duration check (expect 60-300 seconds)
                if duration < 30:
                    score -= 30
                elif duration < 60:
                    score -= 10
                elif duration > 600:
                    score -= 15

                # Bitrate check (expect reasonable bitrate)
                if duration > 0 and size > 0:
                    bitrate = (size * 8) / duration / 1000  # kbps
                    if bitrate < 500:
                        score -= 20
                    elif bitrate < 1000:
                        score -= 10

                return max(0, score)

            except Exception as e:
                print(f"Error calculating quality for {video_path}: {e}")
                return 50  # Default medium score if can't analyze

        with open('pending_approvals.json', 'r') as f:
            prs = json.load(f)

        for pr in prs:
            quality_scores = []
            for video_file in pr['video_files']:
                video_path = video_file['filename']
                if Path(video_path).exists():
                    score = calculate_quality_score(video_path)
                    quality_scores.append(score)
                    print(f"PR #{pr['number']} - {Path(video_path).name}: Quality score = {score}")

            pr['quality_score'] = sum(quality_scores) / len(quality_scores) if quality_scores else 0
            pr['quality_scores'] = quality_scores

        # Save updated data
        with open('pending_approvals.json', 'w') as f:
            json.dump(prs, f, indent=2)

        # Calculate overall stats
        avg_score = sum(pr['quality_score'] for pr in prs) / len(prs) if prs else 0
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"average_quality={avg_score:.1f}\n")
        PYTHON_SCRIPT

    - name: Generate approval dashboard HTML
      if: steps.collect.outputs.has_pending == 'true'
      run: |
        python3 << 'PYTHON_SCRIPT'
        import json
        from datetime import datetime
        from pathlib import Path

        with open('pending_approvals.json', 'r') as f:
            prs = json.load(f)

        html = f'''<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Walkthrough Approval Dashboard</title>
            <style>
                body {{
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                    max-width: 1400px;
                    margin: 0 auto;
                    padding: 20px;
                    background: #f5f5f5;
                }}
                .header {{
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 30px;
                    border-radius: 10px;
                    margin-bottom: 30px;
                }}
                .stats {{
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }}
                .stat-card {{
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }}
                .stat-value {{
                    font-size: 2em;
                    font-weight: bold;
                    color: #667eea;
                }}
                .pr-card {{
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    margin-bottom: 20px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }}
                .pr-header {{
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                }}
                .quality-badge {{
                    padding: 5px 15px;
                    border-radius: 20px;
                    font-weight: bold;
                    font-size: 0.9em;
                }}
                .quality-excellent {{ background: #10b981; color: white; }}
                .quality-good {{ background: #3b82f6; color: white; }}
                .quality-fair {{ background: #f59e0b; color: white; }}
                .quality-poor {{ background: #ef4444; color: white; }}
                .thumbnails {{
                    display: flex;
                    gap: 15px;
                    flex-wrap: wrap;
                    margin: 15px 0;
                }}
                .thumbnail {{
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    overflow: hidden;
                }}
                .thumbnail img {{
                    display: block;
                    max-width: 320px;
                    height: auto;
                }}
                .actions {{
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                }}
                .btn {{
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    text-decoration: none;
                    display: inline-block;
                }}
                .btn-approve {{ background: #10b981; color: white; }}
                .btn-reject {{ background: #ef4444; color: white; }}
                .btn-view {{ background: #6b7280; color: white; }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üé• Walkthrough Approval Dashboard</h1>
                <p>Review and approve pending walkthrough videos</p>
                <p><small>Generated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}</small></p>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value">{len(prs)}</div>
                    <div>Pending PRs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{sum(len(pr['video_files']) for pr in prs)}</div>
                    <div>Total Videos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{sum(pr['quality_score'] for pr in prs) / len(prs) if prs else 0:.0f}</div>
                    <div>Avg Quality Score</div>
                </div>
            </div>

            <h2>Pending Approvals</h2>
        '''

        for pr in prs:
            quality = pr['quality_score']
            if quality >= 85:
                quality_class = 'quality-excellent'
                quality_text = 'Excellent'
            elif quality >= 70:
                quality_class = 'quality-good'
                quality_text = 'Good'
            elif quality >= 50:
                quality_class = 'quality-fair'
                quality_text = 'Fair'
            else:
                quality_class = 'quality-poor'
                quality_text = 'Poor'

            html += f'''
            <div class="pr-card">
                <div class="pr-header">
                    <div>
                        <h3>PR #{pr['number']}: {pr['title']}</h3>
                        <p><small>Created: {pr['created_at']} ‚Ä¢ Branch: {pr['branch']}</small></p>
                    </div>
                    <span class="quality-badge {quality_class}">{quality_text} ({quality:.0f})</span>
                </div>

                <div class="thumbnails">
            '''

            # Add thumbnails (would need to be generated separately)
            for video_file in pr['video_files']:
                video_name = Path(video_file['filename']).name
                html += f'''
                    <div class="thumbnail">
                        <img src="thumbnails/pr-{pr['number']}-{Path(video_file['filename']).stem}.jpg"
                             alt="{video_name}"
                             onerror="this.src='https://via.placeholder.com/320x180?text=No+Thumbnail'">
                        <p style="text-align: center; margin: 5px; font-size: 0.8em;">{video_name}</p>
                    </div>
                '''

            html += f'''
                </div>

                <div class="actions">
                    <a href="{pr['url']}" class="btn btn-view" target="_blank">View PR</a>
                    <a href="{pr['url']}/files" class="btn btn-view" target="_blank">View Files</a>
                    <button class="btn btn-approve" onclick="approvePR({pr['number']})">‚úÖ Approve & Merge</button>
                    <button class="btn btn-reject" onclick="rejectPR({pr['number']})">‚ùå Reject</button>
                </div>
            </div>
            '''

        html += '''
            <script>
                function approvePR(prNumber) {
                    if (confirm(`Approve and merge PR #${prNumber}?`)) {
                        alert('Approval would be triggered via GitHub API. This requires backend implementation.');
                        // In production: Call GitHub API to approve and merge
                    }
                }

                function rejectPR(prNumber) {
                    const reason = prompt(`Reject PR #${prNumber}. Please provide a reason:`);
                    if (reason) {
                        alert('Rejection would be triggered via GitHub API. This requires backend implementation.');
                        // In production: Call GitHub API to close PR with comment
                    }
                }
            </script>
        </body>
        </html>
        '''

        dashboard_path = Path('approval-dashboard/index.html')
        dashboard_path.parent.mkdir(parents=True, exist_ok=True)
        with open(dashboard_path, 'w') as f:
            f.write(html)

        print(f"Generated dashboard: {dashboard_path}")
        PYTHON_SCRIPT

    - name: Auto-approve high-quality videos
      if: steps.collect.outputs.has_pending == 'true'
      id: auto_approve
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        QUALITY_THRESHOLD: ${{ github.event.inputs.auto_approve_quality_threshold || '85' }}
      run: |
        python3 << 'PYTHON_SCRIPT'
        import json
        import os
        import requests

        github_token = os.getenv('GITHUB_TOKEN')
        repo = os.getenv('GITHUB_REPOSITORY')
        threshold = float(os.getenv('QUALITY_THRESHOLD', '85'))

        headers = {
            'Authorization': f'token {github_token}',
            'Accept': 'application/vnd.github.v3+json'
        }

        with open('pending_approvals.json', 'r') as f:
            prs = json.load(f)

        auto_approved = []

        for pr in prs:
            if pr['quality_score'] >= threshold:
                pr_number = pr['number']

                # Add approval review
                review_url = f'https://api.github.com/repos/{repo}/pulls/{pr_number}/reviews'
                review_data = {
                    'event': 'APPROVE',
                    'body': f'‚úÖ Auto-approved by Safeguard 6: Quality score {pr["quality_score"]:.0f} meets threshold ({threshold})'
                }

                try:
                    response = requests.post(review_url, headers=headers, json=review_data)
                    response.raise_for_status()
                    auto_approved.append(pr_number)
                    print(f"Auto-approved PR #{pr_number}")

                    # Optionally auto-merge (commented out for safety)
                    # merge_url = f'https://api.github.com/repos/{repo}/pulls/{pr_number}/merge'
                    # merge_data = {'merge_method': 'squash'}
                    # requests.put(merge_url, headers=headers, json=merge_data)

                except Exception as e:
                    print(f"Error auto-approving PR #{pr_number}: {e}")

        print(f"Auto-approved {len(auto_approved)} PRs: {auto_approved}")

        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"auto_approved_count={len(auto_approved)}\n")
        PYTHON_SCRIPT

    - name: Upload approval dashboard
      if: steps.collect.outputs.has_pending == 'true'
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # ratchet:actions/upload-artifact@v4
      with:
        name: approval-dashboard-${{ github.run_number }}
        path: |
          approval-dashboard/
          pending_approvals.json
        retention-days: 30

    - name: Create approval issue
      if: steps.collect.outputs.has_pending == 'true'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # ratchet:actions/github-script@v7
      with:
        script: |
          const pendingCount = '${{ steps.collect.outputs.pending_count }}';
          const autoApproved = '${{ steps.auto_approve.outputs.auto_approved_count || '0' }}';
          const avgQuality = '${{ steps.quality.outputs.average_quality || '0' }}';

          const title = `üìã Walkthrough Approval Required (${pendingCount} pending)`;
          const body = `
          ## Walkthrough Approval Dashboard

          **Pending PRs:** ${pendingCount}
          **Auto-Approved:** ${autoApproved}
          **Average Quality Score:** ${avgQuality}

          ### Review Required

          ${parseInt(pendingCount) - parseInt(autoApproved)} walkthrough PRs require manual review.

          ### How to Review

          1. Download the approval dashboard artifact from this workflow run
          2. Open \`approval-dashboard/index.html\` in your browser
          3. Review video thumbnails and quality scores
          4. Approve or reject each PR via the GitHub UI

          ### Dashboard Access

          [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Download the \`approval-dashboard-${{ github.run_number }}\` artifact to access the full dashboard with:
          - Video thumbnails
          - Quality scores
          - Direct links to PRs
          - Metadata preview

          ### Auto-Approval Policy

          Videos with quality scores ‚â• 85 are automatically approved.
          Lower-scoring videos require manual review to ensure quality standards.

          ---

          **This dashboard was generated by Safeguard 6: Admin Approval Dashboard**
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['approval-required', 'walkthrough', 'safeguard-6']
          });

    - name: Generate summary
      if: always()
      run: |
        echo "## üìã Approval Dashboard Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pending PRs:** ${{ steps.collect.outputs.pending_count || '0' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Auto-Approved:** ${{ steps.auto_approve.outputs.auto_approved_count || '0' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Average Quality:** ${{ steps.quality.outputs.average_quality || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Actions" >> $GITHUB_STEP_SUMMARY
        echo "- Download the \`approval-dashboard-${{ github.run_number }}\` artifact" >> $GITHUB_STEP_SUMMARY
        echo "- Open \`index.html\` to review pending walkthroughs" >> $GITHUB_STEP_SUMMARY
        echo "- Approve/reject PRs based on quality assessment" >> $GITHUB_STEP_SUMMARY
