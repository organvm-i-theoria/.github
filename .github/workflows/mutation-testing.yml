name: Mutation Testing

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      mutant_threshold:
        description: 'Minimum mutation score (0-100)'
        required: false
        default: '80'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  javascript-mutation:
    name: JavaScript Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: hashFiles('package.json') != ''
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Stryker
        run: npm install --save-dev @stryker-mutator/core

      - name: Create Stryker config
        run: |
          cat > stryker.conf.json << 'EOF'
          {
            "$schema": "./node_modules/@stryker-mutator/core/schema/stryker-schema.json",
            "packageManager": "npm",
            "reporters": [
              "html",
              "clear-text",
              "progress",
              "json"
            ],
            "testRunner": "jest",
            "coverageAnalysis": "perTest",
            "mutate": [
              "src/**/*.js",
              "!src/**/*.test.js",
              "!src/**/*.spec.js"
            ],
            "thresholds": {
              "high": 80,
              "low": 60,
              "break": 50
            },
            "timeoutMS": 60000,
            "maxConcurrentTestRunners": 4
          }
          EOF

      - name: Run Stryker Mutation Testing
        run: npx stryker run
        continue-on-error: true

      - name: Parse Mutation Score
        id: mutation
        run: |
          if [ -f "reports/mutation/mutation.json" ]; then
            SCORE=$(jq -r '.mutationScore' reports/mutation/mutation.json)
            echo "score=$SCORE" >> $GITHUB_OUTPUT
          else
            echo "score=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload Mutation Report
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # ratchet:actions/upload-artifact@v4
        with:
          name: mutation-report-javascript
          path: reports/mutation/
          retention-days: 30

      - name: Comment on commit
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # ratchet:actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.mutation.outputs.score }}';
            const threshold = ${{ inputs.mutant_threshold || 80 }};

            const message = `## ðŸ§¬ Mutation Testing Results (JavaScript)

            **Mutation Score**: ${score}%
            **Threshold**: ${threshold}%
            **Status**: ${score >= threshold ? 'âœ… PASS' : 'âŒ FAIL'}

            ### What is Mutation Testing?

            Mutation testing validates the quality of your tests by introducing small changes (mutations) to your code and checking if tests catch them.

            - **Killed**: Tests caught the mutation âœ…
            - **Survived**: Mutation wasn't detected âŒ
            - **Timeout**: Tests took too long
            - **No Coverage**: Code not tested

            **Goal**: Higher mutation score = better test quality

            [View Full Report](../actions/runs/${{ github.run_id }})
            `;

            console.log(message);

  python-mutation:
    name: Python Mutation Testing
    runs-on: ubuntu-latest
    if: hashFiles('requirements.txt', 'setup.py', 'pyproject.toml') != ''
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # ratchet:actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest mutmut

      - name: Install project dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run mutmut
        run: |
          mutmut run --paths-to-mutate=src/ || true

      - name: Generate HTML report
        run: mutmut junitxml > mutmut-results.xml || true

      - name: Mutmut Results
        run: mutmut results || true

      - name: Upload Results
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # ratchet:actions/upload-artifact@v4
        with:
          name: mutation-report-python
          path: |
            mutmut-results.xml
            .mutmut-cache
          retention-days: 30

  mutation-summary:
    name: Mutation Testing Summary
    needs: [javascript-mutation, python-mutation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ§¬ Mutation Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Language | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | ${{ needs.javascript-mutation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ needs.python-mutation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What to do next?" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review survived mutants" >> $GITHUB_STEP_SUMMARY
          echo "2. Add tests to catch mutations" >> $GITHUB_STEP_SUMMARY
          echo "3. Aim for >80% mutation score" >> $GITHUB_STEP_SUMMARY
