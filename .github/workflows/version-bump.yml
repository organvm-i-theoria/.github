name: Version Bump

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: Type of version bump
        required: true
        type: choice
        options:
        - patch
        - minor
        - major
        default: patch

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683   # ratchet:actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Get current version
      id: current_version
      run: |
        # Try to get version from package.json
        if [ -f "package.json" ]; then
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "file=package.json" >> $GITHUB_OUTPUT
        # Try to get version from pyproject.toml
        elif [ -f "pyproject.toml" ]; then
          VERSION=$(grep -m 1 'version = ' pyproject.toml | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "file=pyproject.toml" >> $GITHUB_OUTPUT
        # Try to get version from setup.py
        elif [ -f "setup.py" ]; then
          VERSION=$(grep -m 1 "version=" setup.py | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "file=setup.py" >> $GITHUB_OUTPUT
        # Try to get version from Cargo.toml
        elif [ -f "Cargo.toml" ]; then
          VERSION=$(grep -m 1 'version = ' Cargo.toml | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "file=Cargo.toml" >> $GITHUB_OUTPUT
        else
          echo "No version file found"
          exit 1
        fi

    - name: Bump version
      id: bump
      run: |
        CURRENT="${{ steps.current_version.outputs.version }}"
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT"
        MAJOR="${VERSION_PARTS[0]}"
        MINOR="${VERSION_PARTS[1]}"
        PATCH="${VERSION_PARTS[2]}"

        case "${{ inputs.bump_type }}" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac

        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Update version in files
      run: |
        NEW_VERSION="${{ steps.bump.outputs.new_version }}"

        # Update package.json
        if [ -f "package.json" ]; then
          jq ".version = \"$NEW_VERSION\"" package.json > package.json.tmp
          mv package.json.tmp package.json
        fi

        # Update pyproject.toml
        if [ -f "pyproject.toml" ]; then
          sed -i "s/version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml
        fi

        # Update Cargo.toml
        if [ -f "Cargo.toml" ]; then
          sed -i "s/version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
        fi

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@8867c4aba1b742c39f8d0ba387c70f678c12193f   # ratchet:peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: bump version to ${{ steps.bump.outputs.new_version }}'
        title: 'chore: bump version to ${{ steps.bump.outputs.new_version }}'
        body: |
          ## Version Bump

          This PR bumps the version from `${{ steps.current_version.outputs.version }}` to `${{ steps.bump.outputs.new_version }}`.

          **Bump Type**: ${{ inputs.bump_type }}

          ### Checklist
          - [ ] Version updated in all relevant files
          - [ ] CHANGELOG.md updated (if needed)
          - [ ] Documentation updated (if needed)

          After merging, create a new release with tag `v${{ steps.bump.outputs.new_version }}`.
        branch: version-bump-${{ steps.bump.outputs.new_version }}
        delete-branch: true
        labels: |
          automated
          version-bump
