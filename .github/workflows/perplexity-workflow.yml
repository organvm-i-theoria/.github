name: Perplexity Workflow

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: The prompt for the Perplexity task
        required: true

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  perplexity:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5.3.0
      with:
        python-version: '3.12'
        cache: pip

    - name: Check quota
      id: quota
      run: |
        usage=$(python src/automation/scripts/quota_manager.py get_usage "Perplexity_Pro_API")
        quota=$(jq -r '.subscriptions[] | select(.name=="Perplexity_Pro_API") | .quota' .github/subscriptions.json)
        echo "usage=$usage" >> $GITHUB_OUTPUT
        echo "quota=$quota" >> $GITHUB_OUTPUT

    - name: Run Perplexity Task
      if: ${{ steps.quota.outputs.usage < steps.quota.outputs.quota }}
      env:
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        INPUT_PROMPT: ${{ github.event.inputs.prompt }}
      run: |
        echo "Running Perplexity task with prompt: $INPUT_PROMPT"
        # Simulate a variable cost based on prompt length
        prompt_length=${#INPUT_PROMPT}
        cost=$(echo "scale=4; $prompt_length * 0.0001" | bc)
        echo "Simulated cost: $cost"
        python src/automation/scripts/quota_manager.py increment_usage "Perplexity_Pro_API" $cost

        # Simulate output
        echo "This is a simulated output from Perplexity for the prompt: $INPUT_PROMPT" > perplexity_output_${{ github.run_id }}.txt

    - name: Queue Task
      if: ${{ steps.quota.outputs.usage >= steps.quota.outputs.quota }}
      run: |
        task='{ "subscription": "Perplexity_Pro_API", "details": "..." }'
        python src/automation/scripts/quota_manager.py add_task "$task"
        echo "Perplexity API quota reached. Task queued."

    - name: Commit state changes
      if: always()
      run: |
        ./src/automation/scripts/commit_changes.sh "chore: update state for Perplexity task"
