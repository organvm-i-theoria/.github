name: Validate Workspace Configurations

on:
  push:
    paths:
    - .devcontainer/**
    - src/automation/scripts/workspace/**
    - docker-compose*.yml
    - Dockerfile*
  pull_request:
    paths:
    - .devcontainer/**
    - src/automation/scripts/workspace/**
    - docker-compose*.yml
    - Dockerfile*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-devcontainer:
    name: Validate DevContainer Configurations
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        template:
        - basic
        - fullstack
        - datascience
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Validate devcontainer.json syntax
      continue-on-error: true
      run: |
        if [ -f ".devcontainer/templates/${{ matrix.template }}/devcontainer.json" ]; then
          echo "Validating .devcontainer/templates/${{ matrix.template }}/devcontainer.json"
          jq empty ".devcontainer/templates/${{ matrix.template }}/devcontainer.json"
        else
          echo "No devcontainer.json found for ${{ matrix.template }}"
          exit 1
        fi

    - name: Validate docker-compose.yml syntax
      run: |
        if [ -f ".devcontainer/templates/${{ matrix.template }}/docker-compose.yml" ]; then
          echo "Validating .devcontainer/templates/${{ matrix.template }}/docker-compose.yml"
          docker-compose -f ".devcontainer/templates/${{ matrix.template }}/docker-compose.yml" config --quiet
        fi

    - name: Check for required files
      continue-on-error: true
      run: |
        TEMPLATE_DIR=".devcontainer/templates/${{ matrix.template }}"

        # Check for devcontainer.json
        if [ ! -f "$TEMPLATE_DIR/devcontainer.json" ]; then
          echo "Error: devcontainer.json missing"
          exit 1
        fi

        # Check for docker-compose.yml
        if [ ! -f "$TEMPLATE_DIR/docker-compose.yml" ]; then
          echo "Warning: docker-compose.yml missing"
        fi

        # Check for post-create.sh
        if [ ! -f "$TEMPLATE_DIR/post-create.sh" ]; then
          echo "Warning: post-create.sh missing"
        fi

        echo "Template validation passed for ${{ matrix.template }}"

  test-devcontainer-build:
    name: Test DevContainer Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        template:
        - fullstack
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # ratchet:docker/setup-buildx-action@v3

    - name: Build devcontainer
      continue-on-error: true
      run: |
        cd .devcontainer/templates/${{ matrix.template }}

        # Build the container
        docker-compose build --no-cache

        echo "DevContainer build successful for ${{ matrix.template }}"

    - name: Test container startup
      continue-on-error: true
      run: |
        cd .devcontainer/templates/${{ matrix.template }}

        # Start services
        docker-compose up -d

        # Wait for services to be healthy
        sleep 30

        # Check services are running
        docker-compose ps

        # Cleanup
        docker-compose down -v

  validate-scripts:
    name: Validate Workspace Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Check script syntax
      continue-on-error: true
      run: |
        # Find all shell scripts
        find src/automation/scripts/workspace -name "*.sh" -type f | while read script; do
          echo "Checking $script"
          bash -n "$script"
        done

    - name: Check script permissions
      continue-on-error: true
      run: |
        # Verify scripts are executable
        find src/automation/scripts/workspace -name "*.sh" -type f | while read script; do
          if [ ! -x "$script" ]; then
            echo "Error: $script is not executable"
            exit 1
          fi
        done

    - name: Test workspace creation script (dry-run)
      run: |
        # This would test the script without actually creating anything
        echo "Would test workspace creation script here"

  validate-documentation:
    name: Validate Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Check for broken links
      uses: gaurav-nelson/github-action-markdown-link-check@5c5dfc0ac2e225883c0e5f03a85311ec2830d368  # ratchet:gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: yes
        config-file: .github/markdown-link-check-config.json
        file-path: |
          docs/WORKSPACE_CONTAINERIZATION_PROTOCOLS.md
          docs/CODESPACES_GUIDE.md
          docs/CODE_SERVER_SETUP.md
          docs/WORKSPACE_QUICK_START.md

    - name: Validate README updates
      run: |
        # Check that workspace protocols are mentioned in README
        if ! grep -q "Workspace.*Containerization" README.md; then
          echo "Error: README.md not updated with workspace protocols"
          exit 1
        fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Scan for secrets in configs
      run: |
        # Check for potential secrets in devcontainer configs
        if grep -r "password.*=" .devcontainer/ | grep -v "PASSWORD=" | grep -v "example"; then
          echo "Warning: Potential hardcoded secrets found"
          # Don't fail, just warn
        fi

    - name: Check Docker security best practices
      run: |
        # Check for common Docker security issues
        find .devcontainer -name "docker-compose.yml" -type f | while read compose; do
          echo "Checking $compose"

          # Check for privileged containers
          if grep -q "privileged: true" "$compose"; then
            echo "Warning: Privileged container found in $compose"
          fi

          # Check for host network mode
          if grep -q "network_mode.*host" "$compose"; then
            echo "Warning: Host network mode found in $compose"
          fi
        done

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
    - validate-devcontainer
    - test-devcontainer-build
    - validate-scripts
    - validate-documentation
    - security-scan
    if: always()
    steps:
    - name: Check job results
      continue-on-error: true
      run: |
        echo "Workspace configuration validation complete"

        if [ "${{ needs.validate-devcontainer.result }}" != "success" ]; then
          echo "âš ï¸ DevContainer validation: ${{ needs.validate-devcontainer.result }}"
        fi

        if [ "${{ needs.test-devcontainer-build.result }}" != "success" ]; then
          echo "âš ï¸ DevContainer build test: ${{ needs.test-devcontainer-build.result }}"
        fi

        if [ "${{ needs.validate-scripts.result }}" != "success" ]; then
          echo "âš ï¸ Script validation: ${{ needs.validate-scripts.result }}"
        fi

        if [ "${{ needs.validate-documentation.result }}" != "success" ]; then
          echo "âš ï¸ Documentation validation: ${{ needs.validate-documentation.result }}"
        fi

        echo "Workspace configuration validation summary complete"

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # ratchet:actions/github-script@v7
      with:
        script: |
          const results = {
            devcontainer: '${{ needs.validate-devcontainer.result }}',
            build: '${{ needs.test-devcontainer-build.result }}',
            scripts: '${{ needs.validate-scripts.result }}',
            docs: '${{ needs.validate-documentation.result }}',
            security: '${{ needs.security-scan.result }}'
          };

          const allPassed = Object.values(results).every(r => r === 'success');
          const icon = allPassed ? 'âœ…' : 'âŒ';

          const body = `
          ## ${icon} Workspace Configuration Validation

          | Check | Status |
          |-------|--------|
          | DevContainer Config | ${results.devcontainer === 'success' ? 'âœ…' : 'âŒ'} |
          | Container Build | ${results.build === 'success' ? 'âœ…' : 'âŒ'} |
          | Scripts | ${results.scripts === 'success' ? 'âœ…' : 'âŒ'} |
          | Documentation | ${results.docs === 'success' ? 'âœ…' : 'âŒ'} |
          | Security | ${results.security === 'success' ? 'âœ…' : 'âŒ'} |

          ${allPassed ?
            '**All validations passed!** ğŸ‰ Workspace configurations are ready to merge.' :
            '**Some validations failed.** Please check the workflow logs for details.'}
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
