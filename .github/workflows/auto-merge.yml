name: Auto Merge Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}
  # Manual trigger for specific PRs
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to auto-merge'
        required: true
        type: number

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

jobs:
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Skip if PR contains [skip-auto-merge] in title or body
    if: |
      !contains(github.event.pull_request.title, '[skip-auto-merge]') &&
      !contains(github.event.pull_request.body, '[skip-auto-merge]')

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR details
        id: pr-details
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            let prNumber;

            if (context.eventName === 'workflow_dispatch') {
              prNumber = ${{ github.event.inputs.pr_number }};
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else {
              console.log('No PR found in event payload');
              return null;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            console.log(`Processing PR #${prNumber}: ${pr.title}`);
            core.setOutput('number', prNumber);
            core.setOutput('head', pr.head.ref);
            core.setOutput('base', pr.base.ref);
            core.setOutput('mergeable', pr.mergeable);
            core.setOutput('draft', pr.draft);

            return pr;

      - name: Check auto-merge eligibility
        id: check-eligibility
        if: steps.pr-details.outputs.number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};
            const isDraft = '${{ steps.pr-details.outputs.draft }}' === 'true';

            if (isDraft) {
              console.log('PR is in draft mode, skipping auto-merge');
              return { eligible: false, reason: 'PR is in draft mode' };
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Check for auto-merge label
            const hasAutoMergeLabel = pr.labels.some(label =>
              label.name === 'auto-merge' || label.name === 'automerge'
            );

            // Check for auto-created label (auto-created PRs are eligible)
            const isAutoCreated = pr.labels.some(label => label.name === 'auto-created');

            // Check if PR title indicates it should be auto-merged
            const titleIndicatesAutoMerge = /\[auto-merge\]/i.test(pr.title);

            const shouldAutoMerge = hasAutoMergeLabel || isAutoCreated || titleIndicatesAutoMerge;

            if (!shouldAutoMerge) {
              console.log('PR not marked for auto-merge');
              return { eligible: false, reason: 'Not marked for auto-merge' };
            }

            core.setOutput('eligible', 'true');
            return { eligible: true, reason: 'Eligible for auto-merge' };

      - name: Check merge conflicts
        id: check-conflicts
        if: steps.check-eligibility.outputs.eligible == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const mergeable = pr.mergeable;
            const mergeableState = pr.mergeable_state;

            console.log(`Mergeable: ${mergeable}, State: ${mergeableState}`);

            if (mergeable === false) {
              core.setOutput('has-conflicts', 'true');
              return { hasConflicts: true, state: mergeableState };
            }

            core.setOutput('has-conflicts', 'false');
            return { hasConflicts: false, state: mergeableState };

      - name: Auto-fix merge conflicts
        id: fix-conflicts
        if: steps.check-conflicts.outputs.has-conflicts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};
            const headBranch = '${{ steps.pr-details.outputs.head }}';
            const baseBranch = '${{ steps.pr-details.outputs.base }}';

            // Attempt to update branch (merge base into head)
            try {
              await github.rest.pulls.updateBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ðŸ”„ **Auto-Merge: Branch Updated**\n\nThe base branch \`${baseBranch}\` has been merged into \`${headBranch}\` to resolve conflicts.\n\nWaiting for checks to complete before auto-merging.`
              });

              core.setOutput('fixed', 'true');
              return { fixed: true };
            } catch (error) {
              console.log(`Could not auto-update branch: ${error.message}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ **Auto-Merge: Conflicts Detected**\n\nThis PR has merge conflicts that cannot be automatically resolved.\n\n**To resolve:**\n1. Update your local branch: \`git checkout ${headBranch}\`\n2. Merge the base branch: \`git merge ${baseBranch}\`\n3. Resolve conflicts in your editor\n4. Commit the resolved changes\n5. Push to update this PR\n\nOnce conflicts are resolved and all checks pass, auto-merge will proceed.`
              });

              core.setOutput('fixed', 'false');
              return { fixed: false };
            }

      - name: Check required status checks
        id: check-status
        if: |
          steps.check-eligibility.outputs.eligible == 'true' &&
          (steps.check-conflicts.outputs.has-conflicts == 'false' || steps.fix-conflicts.outputs.fixed == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Get combined status
            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            console.log(`Combined status: ${status.state}`);

            // Check if all checks have passed
            const allChecksPassed = status.state === 'success';

            // Get check runs
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const failedChecks = checkRuns.check_runs.filter(check =>
              check.conclusion === 'failure' || check.conclusion === 'cancelled'
            );

            if (failedChecks.length > 0) {
              console.log(`Failed checks: ${failedChecks.map(c => c.name).join(', ')}`);
              core.setOutput('all-passed', 'false');
              return { passed: false, failedChecks: failedChecks.map(c => c.name) };
            }

            core.setOutput('all-passed', allChecksPassed ? 'true' : 'false');
            return { passed: allChecksPassed };

      - name: Check required approvals
        id: check-approvals
        if: steps.check-status.outputs.all-passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};

            // Get reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Count approvals (take latest review from each user)
            const latestReviews = {};
            reviews.forEach(review => {
              if (!latestReviews[review.user.login] ||
                  new Date(review.submitted_at) > new Date(latestReviews[review.user.login].submitted_at)) {
                latestReviews[review.user.login] = review;
              }
            });

            const approvals = Object.values(latestReviews).filter(
              review => review.state === 'APPROVED'
            ).length;

            const changesRequested = Object.values(latestReviews).filter(
              review => review.state === 'CHANGES_REQUESTED'
            ).length;

            console.log(`Approvals: ${approvals}, Changes requested: ${changesRequested}`);

            // Auto-created PRs or PRs with auto-merge label need at least 1 approval
            // unless it's a hotfix (then 0 is ok)
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const isHotfix = pr.labels.some(label => label.name === 'hotfix');
            const requiredApprovals = isHotfix ? 0 : 1;

            const hasEnoughApprovals = approvals >= requiredApprovals && changesRequested === 0;

            core.setOutput('approved', hasEnoughApprovals ? 'true' : 'false');
            core.setOutput('approval-count', approvals);

            return { approved: hasEnoughApprovals, count: approvals, required: requiredApprovals };

      - name: Enable auto-merge
        id: enable-auto-merge
        if: |
          steps.check-eligibility.outputs.eligible == 'true' &&
          steps.check-status.outputs.all-passed == 'true' &&
          steps.check-approvals.outputs.approved == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr-details.outputs.number }};

            try {
              // Use GraphQL to enable auto-merge
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              // Merge the PR
              const { data: merge } = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash', // Can be 'merge', 'squash', or 'rebase'
                commit_title: pr.title,
                commit_message: `Auto-merged PR #${prNumber}\n\n${pr.body || ''}`
              });

              console.log(`PR #${prNumber} merged successfully`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âœ… **Auto-Merge Successful**\n\nThis PR has been automatically merged!\n\n**Details:**\n- All required checks passed\n- Required approvals obtained (${steps.check-approvals.outputs.approval-count})\n- No merge conflicts\n\n**Merge SHA:** ${merge.sha}`
              });

              core.setOutput('merged', 'true');
              core.setOutput('merge-sha', merge.sha);

              return { merged: true, sha: merge.sha };
            } catch (error) {
              console.log(`Failed to merge PR: ${error.message}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âŒ **Auto-Merge Failed**\n\nCould not automatically merge this PR.\n\n**Error:** ${error.message}\n\nPlease merge manually or check the workflow logs.`
              });

              core.setOutput('merged', 'false');
              return { merged: false, error: error.message };
            }

      - name: Cleanup merged branch
        if: steps.enable-auto-merge.outputs.merged == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const headBranch = '${{ steps.pr-details.outputs.head }}';

            // Don't delete main, develop, or master branches
            const protectedBranches = ['main', 'master', 'develop'];
            if (protectedBranches.includes(headBranch)) {
              console.log(`Skipping deletion of protected branch: ${headBranch}`);
              return;
            }

            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${headBranch}`
              });

              console.log(`Deleted branch: ${headBranch}`);
            } catch (error) {
              console.log(`Could not delete branch ${headBranch}: ${error.message}`);
            }

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ¤– Auto-Merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.pr-details.outputs.number }}" != "" ]; then
            echo "**PR Number:** #${{ steps.pr-details.outputs.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** ${{ steps.pr-details.outputs.head }} â†’ ${{ steps.pr-details.outputs.base }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.check-eligibility.outputs.eligible }}" == "true" ]; then
              echo "âœ… Eligible for auto-merge" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Not eligible for auto-merge" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ steps.check-conflicts.outputs.has-conflicts }}" == "true" ]; then
              if [ "${{ steps.fix-conflicts.outputs.fixed }}" == "true" ]; then
                echo "âœ… Conflicts resolved automatically" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Conflicts detected - manual resolution required" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âœ… No merge conflicts" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ steps.check-status.outputs.all-passed }}" == "true" ]; then
              echo "âœ… All status checks passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "â³ Waiting for status checks" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ steps.check-approvals.outputs.approved }}" == "true" ]; then
              echo "âœ… Required approvals obtained (${{ steps.check-approvals.outputs.approval-count }})" >> $GITHUB_STEP_SUMMARY
            else
              echo "â³ Waiting for approvals" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ steps.enable-auto-merge.outputs.merged }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŽ‰ **PR Successfully Auto-Merged!**" >> $GITHUB_STEP_SUMMARY
              echo "Merge SHA: ${{ steps.enable-auto-merge.outputs.merge-sha }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No PR found in event payload" >> $GITHUB_STEP_SUMMARY
          fi
