name: Auto-Merge PRs

on:
  pull_request_target:
    types: [labeled, unlabeled, synchronize, opened, reopened, ready_for_review]
  check_suite:
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to evaluate for auto-merge'
        required: false

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: Auto-Merge When Ready
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.draft == false &&
       github.event.pull_request.state == 'open')

    steps:
      - name: Get PR Number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "check_suite" ]; then
            # Get PR number from check suite
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --json number,headRefName --jq ".[] | select(.headRefName == \"${{ github.event.check_suite.head_branch }}\") | .number" | head -1)
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get PR Details
        id: pr_details
        run: |
          PR_DATA=$(gh pr view ${{ steps.pr.outputs.number }} --json \
            labels,isDraft,mergeable,reviewDecision,statusCheckRollup,baseRefName,headRefName,title,body)

          echo "labels=$(echo "$PR_DATA" | jq -r '.labels | map(.name) | join(",")')" >> $GITHUB_OUTPUT
          echo "is_draft=$(echo "$PR_DATA" | jq -r '.isDraft')" >> $GITHUB_OUTPUT
          echo "mergeable=$(echo "$PR_DATA" | jq -r '.mergeable')" >> $GITHUB_OUTPUT
          echo "review_decision=$(echo "$PR_DATA" | jq -r '.reviewDecision // "NONE"')" >> $GITHUB_OUTPUT
          echo "base_ref=$(echo "$PR_DATA" | jq -r '.baseRefName')" >> $GITHUB_OUTPUT
          echo "head_ref=$(echo "$PR_DATA" | jq -r '.headRefName')" >> $GITHUB_OUTPUT
          echo "title=$(echo "$PR_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT

          # Check if all status checks passed
          ALL_CHECKS_PASSED=$(echo "$PR_DATA" | jq -r '
            .statusCheckRollup // [] |
            map(select(.conclusion != null)) |
            all(.conclusion == "SUCCESS" or .conclusion == "SKIPPED" or .conclusion == "NEUTRAL")
          ')
          echo "all_checks_passed=$ALL_CHECKS_PASSED" >> $GITHUB_OUTPUT

          # Get PR age in hours
          CREATED_AT=$(echo "$PR_DATA" | jq -r '.createdAt // ""')
          if [ -n "$CREATED_AT" ]; then
            PR_AGE_HOURS=$(( ($(date +%s) - $(date -d "$CREATED_AT" +%s)) / 3600 ))
          else
            PR_AGE_HOURS=0
          fi
          echo "pr_age_hours=$PR_AGE_HOURS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Auto-Merge Eligibility
        id: eligibility
        run: |
          LABELS="${{ steps.pr_details.outputs.labels }}"
          IS_DRAFT="${{ steps.pr_details.outputs.is_draft }}"
          MERGEABLE="${{ steps.pr_details.outputs.mergeable }}"
          REVIEW_DECISION="${{ steps.pr_details.outputs.review_decision }}"
          ALL_CHECKS="${{ steps.pr_details.outputs.all_checks_passed }}"
          BASE_REF="${{ steps.pr_details.outputs.base_ref }}"
          PR_AGE_HOURS="${{ steps.pr_details.outputs.pr_age_hours }}"

          echo "ðŸ” Evaluating auto-merge eligibility..."
          echo "Labels: $LABELS"
          echo "Draft: $IS_DRAFT"
          echo "Mergeable: $MERGEABLE"
          echo "Review Decision: $REVIEW_DECISION"
          echo "All Checks Passed: $ALL_CHECKS"
          echo "Base Branch: $BASE_REF"
          echo "PR Age (hours): $PR_AGE_HOURS"

          # Blockers
          ELIGIBLE="true"
          REASON=""

          # Check if PR is draft
          if [ "$IS_DRAFT" == "true" ]; then
            ELIGIBLE="false"
            REASON="PR is in draft state"
          fi

          # Check if PR has merge conflicts
          if [ "$MERGEABLE" != "MERGEABLE" ]; then
            ELIGIBLE="false"
            REASON="PR has merge conflicts or is not mergeable"
          fi

          # Check if targeting main (require manual review)
          if [ "$BASE_REF" == "main" ] || [ "$BASE_REF" == "master" ]; then
            if [[ ! "$LABELS" =~ "automerge:when-ci-passes" ]]; then
              ELIGIBLE="false"
              REASON="PRs to main/master require explicit automerge:when-ci-passes label"
            fi
          fi

          # Check for hold label
          if [[ "$LABELS" =~ "hold" ]]; then
            ELIGIBLE="false"
            REASON="PR has 'hold' label"
          fi

          # Check for needs-review label (blocks auto-merge)
          if [[ "$LABELS" =~ "needs-review" ]]; then
            if [ "$REVIEW_DECISION" != "APPROVED" ]; then
              ELIGIBLE="false"
              REASON="PR requires manual review (needs-review label)"
            fi
          fi

          # Check if all CI checks passed
          if [ "$ALL_CHECKS" != "true" ]; then
            ELIGIBLE="false"
            REASON="Not all CI checks have passed"
          fi

          # Determine merge strategy based on labels
          SHOULD_MERGE="false"

          if [ "$ELIGIBLE" == "true" ]; then
            if [[ "$LABELS" =~ "automerge:when-ci-passes" ]]; then
              SHOULD_MERGE="true"
              echo "âœ… Will auto-merge immediately (automerge:when-ci-passes)"
            elif [[ "$LABELS" =~ "automerge:after-24h" ]]; then
              if [ "$PR_AGE_HOURS" -ge 24 ]; then
                SHOULD_MERGE="true"
                echo "âœ… Will auto-merge (>24h old, automerge:after-24h)"
              else
                echo "â³ Waiting for 24h (currently ${PR_AGE_HOURS}h old)"
                REASON="PR not yet 24 hours old"
              fi
            elif [[ "$LABELS" =~ "automerge:batch" ]]; then
              echo "â³ Batch merge label detected, handled by separate workflow"
              REASON="Batch merge pending"
            else
              echo "â„¹ï¸ No auto-merge label found"
              REASON="No auto-merge label (automerge:when-ci-passes, automerge:after-24h)"
            fi
          fi

          echo "eligible=$ELIGIBLE" >> $GITHUB_OUTPUT
          echo "should_merge=$SHOULD_MERGE" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

      - name: Add Comment on Block
        if: steps.eligibility.outputs.eligible == 'false' && steps.eligibility.outputs.reason != ''
        run: |
          # Check if we already commented with this reason
          EXISTING_COMMENT=$(gh pr view ${{ steps.pr.outputs.number }} --json comments --jq '
            .comments[] |
            select(.author.login == "github-actions" and (.body | contains("Auto-merge blocked"))) |
            .body
          ' | tail -1)

          REASON="${{ steps.eligibility.outputs.reason }}"

          if [[ "$EXISTING_COMMENT" != *"$REASON"* ]]; then
            gh pr comment ${{ steps.pr.outputs.number }} --body "ðŸš« **Auto-merge blocked**

**Reason:** $REASON

**To enable auto-merge:**
- Ensure all CI checks pass
- Remove any 'hold' or 'needs-review' labels (or get approval)
- Resolve merge conflicts
- Add label: \`automerge:when-ci-passes\` or \`automerge:after-24h\`

See [AI_RAPID_WORKFLOW.md](../blob/main/AI_RAPID_WORKFLOW.md) for details."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Execute Auto-Merge
        if: steps.eligibility.outputs.should_merge == 'true'
        run: |
          echo "ðŸš€ Auto-merging PR #${{ steps.pr.outputs.number }}"

          gh pr merge ${{ steps.pr.outputs.number }} \
            --squash \
            --auto \
            --delete-branch \
            --subject "${{ steps.pr_details.outputs.title }}" \
            --body "Auto-merged by workflow after all checks passed âœ…"

          echo "âœ… Auto-merge enabled. Will merge when all checks pass."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Success Comment
        if: steps.eligibility.outputs.should_merge == 'true'
        run: |
          gh pr comment ${{ steps.pr.outputs.number }} --body "âœ… **Auto-merge enabled**

This PR will be automatically merged when all checks pass.

Merge method: Squash
Branch will be deleted after merge.

_Automated by [auto-merge.yml](../.github/workflows/auto-merge.yml)_"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job to handle PRs without auto-merge labels (informational)
  suggest-auto-merge:
    name: Suggest Auto-Merge Label
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request_target' &&
      github.event.action == 'opened' &&
      github.event.pull_request.draft == false

    steps:
      - name: Check for Auto-Merge Labels
        run: |
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels | map(.name) | join(",")')

          if [[ ! "$LABELS" =~ "automerge:" ]] && [[ ! "$LABELS" =~ "needs-review" ]]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "ðŸ‘‹ **Auto-merge not configured**

This PR doesn't have an auto-merge label. Consider adding one for faster merging:

- \`automerge:when-ci-passes\` - Merges immediately when CI passes (for bug fixes, docs, small features)
- \`automerge:after-24h\` - Merges 24h after creation if CI passes (for standard features)
- \`needs-review\` - Requires manual review and approval

Or leave as-is for manual merge.

See [AI_RAPID_WORKFLOW.md](../blob/main/AI_RAPID_WORKFLOW.md) for details."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
