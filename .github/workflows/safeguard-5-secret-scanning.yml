name: 'Safeguard 5: Secret Scanning for Walkthroughs'

on:
  workflow_dispatch:
  pull_request:
    paths:
    - walkthroughs/**/*.mp4
    - walkthroughs/**/*.json
  push:
    paths:
    - walkthroughs/**/*.mp4
    - walkthroughs/**/*.json

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

jobs:
  pre-record-scan:
    name: Pre-Record Code Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'workflow_dispatch' || github.event.before != '0000000000000000000000000000000000000000'

    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install secret scanning tools
      run: |
        pip install truffleHog3 detect-secrets

        # Install gitleaks
        wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
        tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
        sudo mv gitleaks /usr/local/bin/
        rm gitleaks_8.18.1_linux_x64.tar.gz

    - name: Scan with TruffleHog
      id: trufflehog
      continue-on-error: true
      run: |
        echo "Running TruffleHog scan..."
        trufflehog3 -r . --format json --output trufflehog-results.json || true

        if [ -f "trufflehog-results.json" ] && [ -s "trufflehog-results.json" ]; then
          echo "found_secrets=true" >> $GITHUB_OUTPUT
          echo "TruffleHog found potential secrets!"
          cat trufflehog-results.json
        else
          echo "found_secrets=false" >> $GITHUB_OUTPUT
          echo "TruffleHog scan clean"
        fi

    - name: Scan with Gitleaks
      id: gitleaks
      continue-on-error: true
      run: |
        echo "Running Gitleaks scan..."
        # Use .gitleaks.toml config if it exists
        if [ -f ".gitleaks.toml" ]; then
          echo "Using .gitleaks.toml configuration"
          gitleaks detect --source . --config .gitleaks.toml --report-format json --report-path gitleaks-report.json --verbose || true
        else
          gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose || true
        fi

        if [ -f "gitleaks-report.json" ] && [ -s "gitleaks-report.json" ]; then
          echo "found_secrets=true" >> $GITHUB_OUTPUT
          echo "Gitleaks found potential secrets!"
          cat gitleaks-report.json | jq '.'
        else
          echo "found_secrets=false" >> $GITHUB_OUTPUT
          echo "Gitleaks scan clean"
        fi

    - name: Scan with detect-secrets
      id: detect_secrets
      continue-on-error: true
      run: |
        echo "Running detect-secrets scan..."
        # Use baseline if it exists
        if [ -f ".secrets.baseline" ]; then
          echo "Using .secrets.baseline for comparison"
          detect-secrets scan --all-files --force-use-all-plugins --baseline .secrets.baseline > detect-secrets-results.json || true
        else
          detect-secrets scan --all-files --force-use-all-plugins > detect-secrets-results.json || true
        fi

        if [ -f "detect-secrets-results.json" ]; then
          RESULTS_COUNT=$(cat detect-secrets-results.json | jq '.results | length')
          if [ "$RESULTS_COUNT" -gt 0 ]; then
            echo "found_secrets=true" >> $GITHUB_OUTPUT
            echo "detect-secrets found $RESULTS_COUNT potential secrets!"
            cat detect-secrets-results.json | jq '.results'
          else
            echo "found_secrets=false" >> $GITHUB_OUTPUT
            echo "detect-secrets scan clean"
          fi
        else
          echo "found_secrets=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # ratchet:actions/upload-artifact@v4
      with:
        name: secret-scan-results-pre-record
        path: |
          trufflehog-results.json
          gitleaks-report.json
          detect-secrets-results.json
        retention-days: 90

    - name: Check for secrets found
      if: steps.trufflehog.outputs.found_secrets == 'true' || steps.gitleaks.outputs.found_secrets == 'true' || steps.detect_secrets.outputs.found_secrets == 'true'
      run: |
        echo "::error::Potential secrets detected in codebase before recording!"
        echo "::error::Please review scan results and remove any secrets before proceeding."
        echo "::error::Artifacts uploaded for detailed review."
        exit 1

  post-record-video-scan:
    name: Post-Record Video Frame Scanning
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install video and OCR tools
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg tesseract-ocr libtesseract-dev
        pip install opencv-python pytesseract pillow regex

    - name: Extract and scan video frames
      id: frame_scan
      run: |
        python3 << 'PYTHON_SCRIPT'
        import os
        import re
        import cv2
        import pytesseract
        from pathlib import Path
        import json

        # Secret patterns to detect
        SECRET_PATTERNS = {
            'AWS Access Key': r'AKIA[0-9A-Z]{16}',
            'AWS Secret Key': r'[A-Za-z0-9/+=]{40}',
            'GitHub Token': r'gh[pousr]_[A-Za-z0-9]{36,}',
            'Generic API Key': r'[aA][pP][iI][-_]?[kK][eE][yY][\s:=]+[\'"]?([A-Za-z0-9\-_]{20,})[\'"]?',
            'Generic Secret': r'[sS][eE][cC][rR][eE][tT][\s:=]+[\'"]?([A-Za-z0-9\-_]{20,})[\'"]?',
            'Private Key Header': r'-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----',
            'JWT Token': r'eyJ[A-Za-z0-9\-_=]+\.eyJ[A-Za-z0-9\-_=]+\.[A-Za-z0-9\-_.+/=]+',
            'Google API Key': r'AIza[0-9A-Za-z\-_]{35}',
            'Slack Token': r'xox[baprs]-[0-9]{10,12}-[0-9]{10,12}-[a-zA-Z0-9]{24,}',
        }

        found_secrets = []
        video_dir = Path('walkthroughs')

        if not video_dir.exists():
            print("No walkthroughs directory found, skipping video scan")
            exit(0)

        video_files = list(video_dir.glob('**/*.mp4'))

        if not video_files:
            print("No video files found, skipping scan")
            exit(0)

        print(f"Found {len(video_files)} video files to scan")

        for video_path in video_files:
            print(f"\nScanning video: {video_path}")

            # Open video
            cap = cv2.VideoCapture(str(video_path))
            if not cap.isOpened():
                print(f"Could not open video: {video_path}")
                continue

            # Get video properties
            fps = cap.get(cv2.CAP_PROP_FPS)
            total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))

            # Sample every 2 seconds to reduce processing time
            frame_interval = int(fps * 2) if fps > 0 else 60
            frame_count = 0
            scanned_frames = 0

            print(f"  Total frames: {total_frames}, FPS: {fps}, Sampling every {frame_interval} frames")

            while cap.isOpened():
                ret, frame = cap.read()
                if not ret:
                    break

                # Only process sampled frames
                if frame_count % frame_interval == 0:
                    scanned_frames += 1

                    # Convert frame to grayscale for better OCR
                    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)

                    # Apply OCR
                    try:
                        text = pytesseract.image_to_string(gray)

                        # Check for secret patterns
                        for secret_type, pattern in SECRET_PATTERNS.items():
                            matches = re.finditer(pattern, text, re.MULTILINE | re.IGNORECASE)
                            for match in matches:
                                found_secrets.append({
                                    'video': str(video_path),
                                    'frame': frame_count,
                                    'timestamp': round(frame_count / fps, 2) if fps > 0 else 0,
                                    'type': secret_type,
                                    'match': match.group()[:50] + '...' if len(match.group()) > 50 else match.group(),
                                    'context': text[max(0, match.start()-50):match.end()+50]
                                })
                                print(f"  âš ï¸  Found {secret_type} at frame {frame_count} (t={round(frame_count / fps, 2)}s)")
                    except Exception as e:
                        print(f"  Error processing frame {frame_count}: {e}")

                frame_count += 1

            cap.release()
            print(f"  Scanned {scanned_frames} frames from {video_path}")

        # Save results
        if found_secrets:
            with open('video-secrets-found.json', 'w') as f:
                json.dump(found_secrets, f, indent=2)
            print(f"\nðŸš¨ ALERT: Found {len(found_secrets)} potential secrets in videos!")
            print(json.dumps(found_secrets, indent=2))

            # Set output for GitHub Actions
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"secrets_found=true\n")
                f.write(f"secrets_count={len(found_secrets)}\n")

            exit(1)
        else:
            print("\nâœ… No secrets detected in video frames")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"secrets_found=false\n")
                f.write(f"secrets_count=0\n")
        PYTHON_SCRIPT

    - name: Upload video scan results
      if: always()
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # ratchet:actions/upload-artifact@v4
      with:
        name: video-secrets-scan-results
        path: video-secrets-found.json
        retention-days: 90
        if-no-files-found: ignore

    - name: Quarantine video with secrets
      if: failure() && steps.frame_scan.outputs.secrets_found == 'true'
      run: |
        echo "::error::Secrets detected in video frames!"
        echo "::error::Videos have been quarantined and will NOT be merged."
        echo "::error::Review the video-secrets-scan-results artifact for details."
        echo "::error::You MUST remove the secrets and regenerate the video."

    - name: Create security alert issue
      if: failure() && steps.frame_scan.outputs.secrets_found == 'true'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # ratchet:actions/github-script@v7
      with:
        script: |
          const secretsCount = '${{ steps.frame_scan.outputs.secrets_count }}';
          const prNumber = context.payload.pull_request?.number || 'N/A';

          const title = `ðŸš¨ SECURITY ALERT: Secrets Detected in Walkthrough Video`;
          const body = `
          ## ðŸš¨ Critical Security Alert

          **Potential secrets were detected in walkthrough video frames.**

          ### Details
          - **Secrets Found:** ${secretsCount}
          - **Pull Request:** ${prNumber !== 'N/A' ? `#${prNumber}` : 'Direct push'}
          - **Commit:** ${{ github.sha }}
          - **Branch:** ${{ github.ref_name }}
          - **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Immediate Actions Required

          1. â›” **DO NOT MERGE** this PR until secrets are removed
          2. ðŸ” Review the \`video-secrets-scan-results\` artifact in the workflow run
          3. ðŸ—‘ï¸ Remove any exposed secrets from the codebase
          4. ðŸ”„ Rotate any exposed credentials immediately
          5. ðŸŽ¥ Regenerate the walkthrough video without secrets

          ### What Was Detected

          The video frame scanner detected patterns matching:
          - API keys
          - Access tokens
          - Private keys
          - Passwords or secrets

          Download the \`video-secrets-scan-results\` artifact to see:
          - Exact timestamps where secrets appear
          - Types of secrets detected
          - Context around each detection

          ### Next Steps

          1. Identify the source of the leaked secrets
          2. Remove secrets from:
             - Environment files (.env)
             - Configuration files
             - Terminal history
             - Browser storage (visible in dev tools)
          3. Ensure secrets are in .gitignore
          4. Use environment variables or secure vaults
          5. Re-run walkthrough generation

          ### Security Team Notification

          @security-team - Please review and assist with credential rotation if needed.

          ---

          **This is an automated alert from Safeguard 5: Secret Scanning**
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'critical', 'secrets-detected', 'safeguard-5']
          });

    - name: Block PR merge
      if: failure() && steps.frame_scan.outputs.secrets_found == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # ratchet:actions/github-script@v7
      with:
        script: |
          await github.rest.pulls.createReview({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
            event: 'REQUEST_CHANGES',
            body: 'ðŸš¨ **SECURITY ALERT: Secrets detected in video!**\n\nThis PR cannot be merged until all secrets are removed and the video is regenerated. See the security alert issue for details.'
          });

  summary:
    name: Secret Scanning Summary
    runs-on: ubuntu-latest
    needs: [pre-record-scan, post-record-video-scan]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "## ðŸ”’ Secret Scanning Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** Safeguard 5 - Secret Scanning" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- Pre-Record Code Scan: ${{ needs.pre-record-scan.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Post-Record Video Scan: ${{ needs.post-record-video-scan.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.pre-record-scan.result }}" == "failure" ] || [ "${{ needs.post-record-video-scan.result }}" == "failure" ]; then
          echo "### âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Potential secrets were detected. Please review the scan results and:" >> $GITHUB_STEP_SUMMARY
          echo "1. Remove all secrets from the codebase" >> $GITHUB_STEP_SUMMARY
          echo "2. Rotate any exposed credentials" >> $GITHUB_STEP_SUMMARY
          echo "3. Regenerate the walkthrough video" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**DO NOT MERGE** until this issue is resolved." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âœ… All Clear" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No secrets detected in pre-record scan or video frames." >> $GITHUB_STEP_SUMMARY
        fi
