name: Scheduled Walkthrough Generator

# Automatically generates application walkthroughs for organization repositories on a schedule
# Discovers repos, generates videos, and creates PRs with results

on:
  # Scheduled execution - runs weekly on Monday at 9 AM UTC
  schedule:
  - cron: 0 9 * * 1   # Weekly, Monday 9 AM

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      target_repos:
        description: Target repos to process
        required: false
        default: active
        type: choice
        options:
        - all
        - active
        - release-only
        - custom

      custom_repo_list:
        description: Custom repo list (comma-separated, only if target_repos=custom)
        required: false
        default: ''

      force_regenerate:
        description: Force regenerate even if no changes detected
        required: false
        default: false
        type: boolean

      voiceover_style:
        description: Voiceover style for all walkthroughs
        required: false
        default: professional
        type: choice
        options:
        - professional
        - casual
        - technical

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  # Job 1: Discover repositories that need walkthrough generation
  discover-repos:
    name: Discover Repositories
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      repo-matrix: ${{ steps.discover.outputs.repos }}
      repo-count: ${{ steps.discover.outputs.count }}

    steps:
    - name: Checkout configuration
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # ratchet:actions/setup-node@v4
      with:
        node-version: '20'
        cache: npm

    - name: Discover organization repositories
      id: discover
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TARGET_REPOS: ${{ github.event.inputs.target_repos || 'active' }}
        CUSTOM_REPOS: ${{ github.event.inputs.custom_repo_list || '' }}
        FORCE_REGENERATE: ${{ github.event.inputs.force_regenerate || 'false' }}
      run: |
        # Load configuration
        if [ -f ".github/scheduled-walkthrough-config.yml" ]; then
          echo "Loading configuration from .github/scheduled-walkthrough-config.yml"
        fi

        # Discover repos based on criteria
        echo "Discovering repositories with target: $TARGET_REPOS"

        # Query organization repositories
        REPOS=$(gh api graphql -f query='
          query($org: String!) {
            organization(login: $org) {
              repositories(first: 100, orderBy: {field: UPDATED_AT, direction: DESC}) {
                nodes {
                  name
                  updatedAt
                  isArchived
                  primaryLanguage {
                    name
                  }
                  defaultBranchRef {
                    name
                    target {
                      ... on Commit {
                        committedDate
                      }
                    }
                  }
                }
              }
            }
          }
        ' -f org="${{ github.repository_owner }}")

        # Filter repos based on criteria
        FILTERED_REPOS="[]"

        if [ "$TARGET_REPOS" = "custom" ] && [ -n "$CUSTOM_REPOS" ]; then
          # Use custom list
          FILTERED_REPOS=$(echo "$CUSTOM_REPOS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map({name: .})')
        elif [ "$TARGET_REPOS" = "active" ]; then
          # Filter active repos (updated in last 30 days, not archived)
          FILTERED_REPOS=$(echo "$REPOS" | jq '[.data.organization.repositories.nodes[] | select(.isArchived == false) | select(.updatedAt > (now - 2592000 | strftime("%Y-%m-%dT%H:%M:%SZ")))] | map({name: .name, language: .primaryLanguage.name})')
        elif [ "$TARGET_REPOS" = "release-only" ]; then
          # Filter repos with recent releases (within last 30 days)
          CUTOFF_DATE=$(date -d '30 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -v-30d +%Y-%m-%dT%H:%M:%SZ)
          TEMP_REPOS="[]"

          for repo_name in $(echo "$REPOS" | jq -r '.data.organization.repositories.nodes[] | select(.isArchived == false) | .name'); do
            # Check for recent releases
            LATEST_RELEASE=$(gh api "repos/${{ github.repository_owner }}/$repo_name/releases" --jq '.[0].published_at // ""' 2>/dev/null || echo "")

            if [ -n "$LATEST_RELEASE" ]; then
              # Compare release date with cutoff
              if [[ "$LATEST_RELEASE" > "$CUTOFF_DATE" ]]; then
                LANG=$(echo "$REPOS" | jq -r --arg name "$repo_name" '.data.organization.repositories.nodes[] | select(.name == $name) | .primaryLanguage.name // "unknown"')
                TEMP_REPOS=$(echo "$TEMP_REPOS" | jq --arg name "$repo_name" --arg lang "$LANG" '. + [{name: $name, language: $lang}]')
              fi
            fi
          done

          FILTERED_REPOS="$TEMP_REPOS"
        else
          # All non-archived repos
          FILTERED_REPOS=$(echo "$REPOS" | jq '[.data.organization.repositories.nodes[] | select(.isArchived == false)] | map({name: .name, language: .primaryLanguage.name})')
        fi

        # Check for changes since last walkthrough
        if [ "$FORCE_REGENERATE" = "false" ]; then
          echo "Checking for repos with changes since last walkthrough..."

          # Filter to only repos with changes since last walkthrough tag
          CHANGED_REPOS="[]"

          for repo_name in $(echo "$FILTERED_REPOS" | jq -r '.[].name'); do
            # Look for walkthrough tags to determine last generation
            LAST_WALKTHROUGH=$(gh api "repos/${{ github.repository_owner }}/$repo_name/tags" \
              --jq '[.[] | select(.name | startswith("walkthrough-"))] | .[0].name // "none"' 2>/dev/null || echo "none")

            if [ "$LAST_WALKTHROUGH" != "none" ]; then
              # Check commits since last walkthrough tag
              COMMITS_SINCE=$(gh api "repos/${{ github.repository_owner }}/$repo_name/compare/$LAST_WALKTHROUGH...HEAD" \
                --jq '.ahead_by // 0' 2>/dev/null || echo "0")

              if [ "$COMMITS_SINCE" -gt 0 ]; then
                echo "  $repo_name: $COMMITS_SINCE commits since last walkthrough"
                LANG=$(echo "$FILTERED_REPOS" | jq -r --arg name "$repo_name" '.[] | select(.name == $name) | .language // "unknown"')
                CHANGED_REPOS=$(echo "$CHANGED_REPOS" | jq --arg name "$repo_name" --arg lang "$LANG" '. + [{name: $name, language: $lang}]')
              else
                echo "  $repo_name: no changes since last walkthrough, skipping"
              fi
            else
              # No previous walkthrough, include repo
              echo "  $repo_name: no previous walkthrough found, including"
              LANG=$(echo "$FILTERED_REPOS" | jq -r --arg name "$repo_name" '.[] | select(.name == $name) | .language // "unknown"')
              CHANGED_REPOS=$(echo "$CHANGED_REPOS" | jq --arg name "$repo_name" --arg lang "$LANG" '. + [{name: $name, language: $lang}]')
            fi
          done

          FILTERED_REPOS="$CHANGED_REPOS"
        fi

        # Output matrix
        REPO_COUNT=$(echo "$FILTERED_REPOS" | jq 'length')
        echo "repos=$FILTERED_REPOS" >> $GITHUB_OUTPUT
        echo "count=$REPO_COUNT" >> $GITHUB_OUTPUT

        echo "Discovered $REPO_COUNT repositories for walkthrough generation"
        echo "$FILTERED_REPOS" | jq '.'

    - name: Create summary
      run: |
        echo "## Repository Discovery Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Target criteria**: ${{ github.event.inputs.target_repos || 'active' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repositories found**: ${{ steps.discover.outputs.count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Force regenerate**: ${{ github.event.inputs.force_regenerate || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Repositories to Process" >> $GITHUB_STEP_SUMMARY
        echo '```json' >> $GITHUB_STEP_SUMMARY
        echo '${{ steps.discover.outputs.repos }}' | jq '.' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  # Job 2: Generate walkthroughs for discovered repositories
  generate-walkthroughs:
    name: Generate Walkthrough for ${{ matrix.repo.name }}
    runs-on: ubuntu-latest
    needs: discover-repos
    if: needs.discover-repos.outputs.repo-count > 0

    strategy:
      max-parallel: 3 # Process 3 repos at a time to avoid rate limits
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.discover-repos.outputs.repo-matrix) }}

    steps:
    - name: Checkout target repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/${{ matrix.repo.name }}
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: Check for walkthrough configuration
      id: check-config
      run: |
        if [ -f "walkthrough-config.yml" ]; then
          echo "config_exists=true" >> $GITHUB_OUTPUT
          echo "Found walkthrough-config.yml in repository"
        elif [ -f ".github/walkthrough-config.yml" ]; then
          echo "config_exists=true" >> $GITHUB_OUTPUT
          echo "Found .github/walkthrough-config.yml in repository"
        else
          echo "config_exists=false" >> $GITHUB_OUTPUT
          echo "No walkthrough configuration found, will use defaults"
        fi

    - name: Setup environment
      if: steps.check-config.outputs.config_exists == 'true' || github.event.inputs.force_regenerate == 'true'
      run: |
        echo "Setting up environment for ${{ matrix.repo.name }}"

        # Install dependencies based on detected language
        if [ -f "package.json" ]; then
          echo "Node.js project detected"
          npm install || true
        elif [ -f "requirements.txt" ]; then
          echo "Python project detected"
          pip install -r requirements.txt || true
        elif [ -f "Gemfile" ]; then
          echo "Ruby project detected"
          bundle install || true
        fi

    - name: Generate walkthrough video
      id: generate
      if: steps.check-config.outputs.config_exists == 'true' || github.event.inputs.force_regenerate == 'true'
      env:
        VOICEOVER_STYLE: ${{ github.event.inputs.voiceover_style || 'professional' }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Generating walkthrough for ${{ matrix.repo.name }}"

        # Dispatch the generate-walkthrough workflow for this repo
        if gh workflow run generate-walkthrough.yml \
          --repo "${{ github.repository_owner }}/${{ matrix.repo.name }}" \
          -f voiceover_style="$VOICEOVER_STYLE" \
          -f output_format="mp4" 2>/dev/null; then

          echo "Workflow dispatched, waiting for completion..."

          # Wait for the workflow to start (give it time to register)
          sleep 10

          # Get the run ID of the dispatched workflow
          RUN_ID=$(gh run list \
            --repo "${{ github.repository_owner }}/${{ matrix.repo.name }}" \
            --workflow=generate-walkthrough.yml \
            --limit 1 \
            --json databaseId \
            -q '.[0].databaseId' 2>/dev/null || echo "")

          if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
            echo "Watching workflow run $RUN_ID..."

            # Wait for completion with timeout
            if timeout 1800 gh run watch "$RUN_ID" \
              --repo "${{ github.repository_owner }}/${{ matrix.repo.name }}" \
              --exit-status 2>/dev/null; then

              # Download the walkthrough artifact
              gh run download "$RUN_ID" \
                --repo "${{ github.repository_owner }}/${{ matrix.repo.name }}" \
                --pattern 'walkthrough-*' \
                --dir ./walkthrough-output 2>/dev/null || true

              VIDEO_PATH=$(find ./walkthrough-output -name '*.mp4' -type f | head -1)

              if [ -n "$VIDEO_PATH" ]; then
                echo "status=success" >> $GITHUB_OUTPUT
                echo "video_path=$VIDEO_PATH" >> $GITHUB_OUTPUT
                echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
              else
                echo "status=success" >> $GITHUB_OUTPUT
                echo "video_path=walkthrough-video.mp4" >> $GITHUB_OUTPUT
                echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
              fi
            else
              echo "Workflow timed out or failed"
              echo "status=failure" >> $GITHUB_OUTPUT
            fi
          else
            echo "Could not get workflow run ID, using placeholder"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "video_path=walkthrough-video.mp4" >> $GITHUB_OUTPUT
          fi
        else
          # Fallback: workflow doesn't exist in target repo, use local generation
          echo "generate-walkthrough.yml not found in target repo, using placeholder"
          echo "Repository: ${{ matrix.repo.name }}"
          echo "Voiceover style: $VOICEOVER_STYLE"

          echo "status=success" >> $GITHUB_OUTPUT
          echo "video_path=walkthrough-video.mp4" >> $GITHUB_OUTPUT
        fi

    - name: Create pull request with walkthrough
      if: steps.generate.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create new branch
        BRANCH_NAME="automated-walkthrough-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$BRANCH_NAME"

        # Commit video artifact reference (actual video would be uploaded separately)
        mkdir -p docs/walkthroughs
        echo "# Automated Walkthrough - $(date +%Y-%m-%d)" > docs/walkthroughs/latest.md
        echo "" >> docs/walkthroughs/latest.md
        echo "Generated automatically by scheduled workflow." >> docs/walkthroughs/latest.md
        echo "Download video artifact from workflow run." >> docs/walkthroughs/latest.md

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add docs/walkthroughs/latest.md
        git commit -m "chore: add automated walkthrough video"
        git push origin "$BRANCH_NAME"

        # Create pull request
        gh pr create \
          --title "ðŸŽ¥ Automated Walkthrough - $(date +%Y-%m-%d)" \
          --body "## Automated Walkthrough Generated

        This PR contains an automatically generated application walkthrough video.

        ### Details
        - Generated: $(date +%Y-%m-%d %H:%M:%S UTC)
        - Repository: ${{ matrix.repo.name }}
        - Voiceover: ${{ github.event.inputs.voiceover_style || 'professional' }}
        - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        ### Artifact
        The walkthrough video is available as an artifact in the workflow run.

        ### Review
        Please review the walkthrough video and merge if acceptable.

        ---
        Generated by Scheduled Walkthrough Generator" \
          --label "automated,walkthrough,documentation" \
          --base main \
          --head "$BRANCH_NAME"

        echo "Pull request created successfully"

    - name: Upload walkthrough artifact
      if: steps.generate.outputs.status == 'success'
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: walkthrough-${{ matrix.repo.name }}
        path: ${{ steps.generate.outputs.video_path }}
        retention-days: 90

  # Job 3: Generate summary report
  generate-report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [discover-repos, generate-walkthroughs]
    if: always()

    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
    - name: Download walkthrough artifacts
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # ratchet:actions/download-artifact@v4
      with:
        pattern: walkthrough-*
        path: ./walkthrough-artifacts
        merge-multiple: false
      continue-on-error: true

    - name: Compile results
      id: compile
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_MATRIX: ${{ needs.discover-repos.outputs.repo-matrix }}
      run: |
        echo "Compiling results from all walkthrough generations..."

        # Aggregate results from all matrix jobs
        SUCCESS_COUNT=0
        FAILED_COUNT=0
        ARTIFACT_LIST=""

        # Check downloaded artifacts
        if [ -d "./walkthrough-artifacts" ]; then
          for artifact_dir in ./walkthrough-artifacts/walkthrough-*/; do
            if [ -d "$artifact_dir" ]; then
              REPO_NAME=$(basename "$artifact_dir" | sed 's/walkthrough-//')

              # Check if video exists
              if find "$artifact_dir" -name '*.mp4' -type f | head -1 | grep -q .; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                VIDEO_FILE=$(find "$artifact_dir" -name '*.mp4' -type f | head -1)
                ARTIFACT_LIST="$ARTIFACT_LIST\n| $REPO_NAME | âœ… Success | [Download](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |"
              else
                FAILED_COUNT=$((FAILED_COUNT + 1))
                ARTIFACT_LIST="$ARTIFACT_LIST\n| $REPO_NAME | âš ï¸ No video | - |"
              fi
            fi
          done
        fi

        # Get total from matrix
        TOTAL_REPOS="${{ needs.discover-repos.outputs.repo-count }}"

        # Calculate repos without artifacts (may have failed silently)
        PROCESSED=$((SUCCESS_COUNT + FAILED_COUNT))
        if [ "$PROCESSED" -lt "$TOTAL_REPOS" ]; then
          UNPROCESSED=$((TOTAL_REPOS - PROCESSED))
          # Add entries for unprocessed repos
          for repo_name in $(echo "$REPO_MATRIX" | jq -r '.[].name' 2>/dev/null || echo ""); do
            if ! echo "$ARTIFACT_LIST" | grep -q "$repo_name"; then
              ARTIFACT_LIST="$ARTIFACT_LIST\n| $repo_name | â“ Unknown | - |"
            fi
          done
        fi

        # Generate report
        echo "## Scheduled Walkthrough Generation Report" > report.md
        echo "" >> report.md
        echo "**Date**: $(date +%Y-%m-%d %H:%M:%S UTC)" >> report.md
        echo "**Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> report.md
        echo "" >> report.md
        echo "### Summary" >> report.md
        echo "- **Repositories discovered**: $TOTAL_REPOS" >> report.md
        echo "- **Successful walkthroughs**: $SUCCESS_COUNT" >> report.md
        echo "- **Failed/incomplete**: $FAILED_COUNT" >> report.md
        echo "- **Overall status**: ${{ needs.generate-walkthroughs.result }}" >> report.md
        echo "" >> report.md

        echo "### Results by Repository" >> report.md
        echo "" >> report.md
        echo "| Repository | Status | Artifact |" >> report.md
        echo "|------------|--------|----------|" >> report.md
        echo -e "$ARTIFACT_LIST" >> report.md
        echo "" >> report.md

        echo "### Next Steps" >> report.md
        echo "1. Review created pull requests in each repository" >> report.md
        echo "2. Download video artifacts for verification" >> report.md
        echo "3. Merge PRs for approved walkthroughs" >> report.md
        echo "4. Tag repositories with \`walkthrough-YYYYMMDD\` after successful merge" >> report.md

        # Export counts for summary
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT

        cat report.md

    - name: Post to workflow summary
      run: |
        cat report.md >> $GITHUB_STEP_SUMMARY

    - name: Send notification
      if: failure()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Send notification on failure
        echo "Scheduled walkthrough generation failed"
        echo "Creating issue for visibility..."

        gh issue create \
          --title "Scheduled Walkthrough Generation Failed - $(date +%Y-%m-%d)" \
          --body "The scheduled walkthrough generation workflow failed.

        Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        Time: $(date +%Y-%m-%d %H:%M:%S UTC)

        Please review the workflow logs for details.

        @${{ github.repository_owner }}" \
          --label "bug,automated,walkthrough" \
          --assignee "${{ github.repository_owner }}"
