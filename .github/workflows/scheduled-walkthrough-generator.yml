name: Scheduled Walkthrough Generator

# Generates Gource git history visualizations for organization repositories on a schedule
# Discovers repos, generates MP4 videos, and uploads as artifacts

on:
  # Scheduled execution - runs weekly on Monday at 9 AM UTC
  schedule:
  - cron: 0 9 * * 1   # Weekly, Monday 9 AM

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      target_repos:
        description: Target repos to process
        required: false
        default: active
        type: choice
        options:
        - all
        - active
        - release-only
        - custom

      custom_repo_list:
        description: Custom repo list (comma-separated, only if target_repos=custom)
        required: false
        default: ''

      force_regenerate:
        description: Force regenerate even if no changes detected
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  # Job 1: Discover repositories that need walkthrough generation
  discover-repos:
    name: Discover Repositories
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      repo-matrix: ${{ steps.discover.outputs.repos }}
      repo-count: ${{ steps.discover.outputs.count }}

    steps:
    - name: Checkout configuration
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Discover organization repositories
      id: discover
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TARGET_REPOS: ${{ github.event.inputs.target_repos || 'active' }}
        CUSTOM_REPOS: ${{ github.event.inputs.custom_repo_list || '' }}
        FORCE_REGENERATE: ${{ github.event.inputs.force_regenerate || 'false' }}
      run: |
        # Load configuration
        if [ -f ".github/scheduled-walkthrough-config.yml" ]; then
          echo "Loading configuration from .github/scheduled-walkthrough-config.yml"
        fi

        # Discover repos based on criteria
        echo "Discovering repositories with target: $TARGET_REPOS"

        # Query organization repositories
        REPOS=$(gh api graphql -f query='
          query($org: String!) {
            organization(login: $org) {
              repositories(first: 100, orderBy: {field: UPDATED_AT, direction: DESC}) {
                nodes {
                  name
                  updatedAt
                  isArchived
                  primaryLanguage {
                    name
                  }
                  defaultBranchRef {
                    name
                    target {
                      ... on Commit {
                        committedDate
                      }
                    }
                  }
                }
              }
            }
          }
        ' -f org="${{ github.repository_owner }}")

        # Filter repos based on criteria
        FILTERED_REPOS="[]"

        if [ "$TARGET_REPOS" = "custom" ] && [ -n "$CUSTOM_REPOS" ]; then
          # Use custom list
          FILTERED_REPOS=$(echo "$CUSTOM_REPOS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map({name: .})')
        elif [ "$TARGET_REPOS" = "active" ]; then
          # Filter active repos (updated in last 30 days, not archived)
          FILTERED_REPOS=$(echo "$REPOS" | jq '[.data.organization.repositories.nodes[] | select(.isArchived == false) | select(.updatedAt > (now - 2592000 | strftime("%Y-%m-%dT%H:%M:%SZ")))] | map({name: .name, language: .primaryLanguage.name})')
        elif [ "$TARGET_REPOS" = "release-only" ]; then
          # Filter repos with recent releases (within last 30 days)
          CUTOFF_DATE=$(date -d '30 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -v-30d +%Y-%m-%dT%H:%M:%SZ)
          TEMP_REPOS="[]"

          for repo_name in $(echo "$REPOS" | jq -r '.data.organization.repositories.nodes[] | select(.isArchived == false) | .name'); do
            # Check for recent releases
            LATEST_RELEASE=$(gh api "repos/${{ github.repository_owner }}/$repo_name/releases" --jq '.[0].published_at // ""' 2>/dev/null || echo "")

            if [ -n "$LATEST_RELEASE" ]; then
              # Compare release date with cutoff
              if [[ "$LATEST_RELEASE" > "$CUTOFF_DATE" ]]; then
                LANG=$(echo "$REPOS" | jq -r --arg name "$repo_name" '.data.organization.repositories.nodes[] | select(.name == $name) | .primaryLanguage.name // "unknown"')
                TEMP_REPOS=$(echo "$TEMP_REPOS" | jq --arg name "$repo_name" --arg lang "$LANG" '. + [{name: $name, language: $lang}]')
              fi
            fi
          done

          FILTERED_REPOS="$TEMP_REPOS"
        else
          # All non-archived repos
          FILTERED_REPOS=$(echo "$REPOS" | jq '[.data.organization.repositories.nodes[] | select(.isArchived == false)] | map({name: .name, language: .primaryLanguage.name})')
        fi

        # Check for changes since last walkthrough
        if [ "$FORCE_REGENERATE" = "false" ]; then
          echo "Checking for repos with changes since last walkthrough..."

          # Filter to only repos with changes since last walkthrough tag
          CHANGED_REPOS="[]"

          for repo_name in $(echo "$FILTERED_REPOS" | jq -r '.[].name'); do
            # Look for walkthrough tags to determine last generation
            LAST_WALKTHROUGH=$(gh api "repos/${{ github.repository_owner }}/$repo_name/tags" \
              --jq '[.[] | select(.name | startswith("walkthrough-"))] | .[0].name // "none"' 2>/dev/null || echo "none")

            if [ "$LAST_WALKTHROUGH" != "none" ]; then
              # Check commits since last walkthrough tag
              COMMITS_SINCE=$(gh api "repos/${{ github.repository_owner }}/$repo_name/compare/$LAST_WALKTHROUGH...HEAD" \
                --jq '.ahead_by // 0' 2>/dev/null || echo "0")

              if [ "$COMMITS_SINCE" -gt 0 ]; then
                echo "  $repo_name: $COMMITS_SINCE commits since last walkthrough"
                LANG=$(echo "$FILTERED_REPOS" | jq -r --arg name "$repo_name" '.[] | select(.name == $name) | .language // "unknown"')
                CHANGED_REPOS=$(echo "$CHANGED_REPOS" | jq --arg name "$repo_name" --arg lang "$LANG" '. + [{name: $name, language: $lang}]')
              else
                echo "  $repo_name: no changes since last walkthrough, skipping"
              fi
            else
              # No previous walkthrough, include repo
              echo "  $repo_name: no previous walkthrough found, including"
              LANG=$(echo "$FILTERED_REPOS" | jq -r --arg name "$repo_name" '.[] | select(.name == $name) | .language // "unknown"')
              CHANGED_REPOS=$(echo "$CHANGED_REPOS" | jq --arg name "$repo_name" --arg lang "$LANG" '. + [{name: $name, language: $lang}]')
            fi
          done

          FILTERED_REPOS="$CHANGED_REPOS"
        fi

        # Output matrix
        REPO_COUNT=$(echo "$FILTERED_REPOS" | jq 'length')
        echo "repos=$FILTERED_REPOS" >> $GITHUB_OUTPUT
        echo "count=$REPO_COUNT" >> $GITHUB_OUTPUT

        echo "Discovered $REPO_COUNT repositories for walkthrough generation"
        echo "$FILTERED_REPOS" | jq '.'

    - name: Create summary
      run: |
        echo "## Repository Discovery Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Target criteria**: ${{ github.event.inputs.target_repos || 'active' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repositories found**: ${{ steps.discover.outputs.count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Force regenerate**: ${{ github.event.inputs.force_regenerate || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Repositories to Process" >> $GITHUB_STEP_SUMMARY
        echo '```json' >> $GITHUB_STEP_SUMMARY
        echo '${{ steps.discover.outputs.repos }}' | jq '.' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  # Job 2: Generate Gource visualizations for discovered repositories
  generate-walkthroughs:
    name: Generate Walkthrough for ${{ matrix.repo.name }}
    runs-on: ubuntu-latest
    needs: discover-repos
    if: needs.discover-repos.outputs.repo-count > 0

    strategy:
      max-parallel: 3 # Process 3 repos at a time to avoid rate limits
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.discover-repos.outputs.repo-matrix) }}

    steps:
    - name: Checkout target repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/${{ matrix.repo.name }}
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main
        fetch-depth: 0

    - name: Generate Gource visualization
      continue-on-error: true
      uses: NBprojekt/gource-action@57256d303c5a9a5e72ed92ba13e3e83c5ec8b257  # ratchet:NBprojekt/gource-action@v1.3.0
      with:
        gource_title: ${{ matrix.repo.name }}
        gource_resolution: '1080p'
        gource_fps: '60'
        gource_seconds_per_day: '0.5'
        gource_auto_skip_seconds: '1'
        gource_background_color: '000000'
        avatars_auto_fetch: 'true'

    - name: Upload walkthrough artifact
      if: hashFiles('./gource/gource.mp4') != ''
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: walkthrough-${{ matrix.repo.name }}
        path: ./gource/gource.mp4
        retention-days: 90

  # Job 3: Generate summary report
  generate-report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [discover-repos, generate-walkthroughs]
    if: always()

    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
    - name: Download walkthrough artifacts
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # ratchet:actions/download-artifact@v4
      with:
        pattern: walkthrough-*
        path: ./walkthrough-artifacts
        merge-multiple: false
      continue-on-error: true

    - name: Compile results
      id: compile
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_MATRIX: ${{ needs.discover-repos.outputs.repo-matrix }}
      run: |
        echo "Compiling results from all Gource visualizations..."

        # Aggregate results from all matrix jobs
        SUCCESS_COUNT=0
        FAILED_COUNT=0
        ARTIFACT_LIST=""

        # Check downloaded artifacts
        if [ -d "./walkthrough-artifacts" ]; then
          for artifact_dir in ./walkthrough-artifacts/walkthrough-*/; do
            if [ -d "$artifact_dir" ]; then
              REPO_NAME=$(basename "$artifact_dir" | sed 's/walkthrough-//')

              # Check if video exists
              if find "$artifact_dir" -name '*.mp4' -type f | head -1 | grep -q .; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                ARTIFACT_LIST="$ARTIFACT_LIST\n| $REPO_NAME | Success | [Download](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |"
              else
                FAILED_COUNT=$((FAILED_COUNT + 1))
                ARTIFACT_LIST="$ARTIFACT_LIST\n| $REPO_NAME | No video | - |"
              fi
            fi
          done
        fi

        # Get total from matrix
        TOTAL_REPOS="${{ needs.discover-repos.outputs.repo-count }}"

        # Calculate repos without artifacts (may have failed silently)
        PROCESSED=$((SUCCESS_COUNT + FAILED_COUNT))
        if [ "$PROCESSED" -lt "$TOTAL_REPOS" ]; then
          # Add entries for unprocessed repos
          for repo_name in $(echo "$REPO_MATRIX" | jq -r '.[].name' 2>/dev/null || echo ""); do
            if ! echo "$ARTIFACT_LIST" | grep -q "$repo_name"; then
              ARTIFACT_LIST="$ARTIFACT_LIST\n| $repo_name | Unknown | - |"
            fi
          done
        fi

        # Generate report
        echo "## Scheduled Gource Visualization Report" > report.md
        echo "" >> report.md
        echo "**Date**: $(date +%Y-%m-%d %H:%M:%S UTC)" >> report.md
        echo "**Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> report.md
        echo "" >> report.md
        echo "### Summary" >> report.md
        echo "- **Repositories discovered**: $TOTAL_REPOS" >> report.md
        echo "- **Successful visualizations**: $SUCCESS_COUNT" >> report.md
        echo "- **Failed/incomplete**: $FAILED_COUNT" >> report.md
        echo "- **Overall status**: ${{ needs.generate-walkthroughs.result }}" >> report.md
        echo "" >> report.md

        echo "### Results by Repository" >> report.md
        echo "" >> report.md
        echo "| Repository | Status | Artifact |" >> report.md
        echo "|------------|--------|----------|" >> report.md
        echo -e "$ARTIFACT_LIST" >> report.md
        echo "" >> report.md

        echo "### Next Steps" >> report.md
        echo "1. Download Gource visualization artifacts from the workflow run" >> report.md
        echo "2. Review generated MP4 videos" >> report.md
        echo "3. Tag repositories with \`walkthrough-YYYYMMDD\` to track generation history" >> report.md

        # Export counts for summary
        echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT

        cat report.md

    - name: Post to workflow summary
      run: |
        cat report.md >> $GITHUB_STEP_SUMMARY

    - name: Send notification
      if: failure()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Send notification on failure
        echo "Scheduled Gource visualization generation failed"
        echo "Creating issue for visibility..."

        gh issue create \
          --title "Scheduled Gource Visualization Failed - $(date +%Y-%m-%d)" \
          --body "The scheduled Gource visualization workflow failed.

        Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        Time: $(date +%Y-%m-%d %H:%M:%S UTC)

        Please review the workflow logs for details.

        @${{ github.repository_owner }}" \
          --label "bug,automated,walkthrough" \
          --assignee "${{ github.repository_owner }}"
