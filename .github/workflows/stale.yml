name: Stale Issues and PRs

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: 0 0 * * *
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  stale:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Mark stale issues and PRs
        uses: actions/stale@28ca1036281a5e5922ead5184a1bbf96e5fc984e # v9.0.0
        with:
          # General configuration
          repo-token:
            ${{ secrets.GITHUB_TOKEN }}

            # Days before marking as stale
          days-before-stale: 60
          days-before-close:
            14

            # Stale issue configuration
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had recent activity.
            It will be closed in 14 days if no further activity occurs.

            If this issue is still relevant, please:
            - Add a comment to keep it open
            - Add new information or context
            - Remove the 'stale' label

            Thank you for your contributions!

          close-issue-message: |
            This issue has been automatically closed due to inactivity.

            If you believe this issue is still relevant, please feel free to reopen it
            or create a new issue with updated information.

          stale-issue-label:
            stale

            # Stale PR configuration
          stale-pr-message: |
            This pull request has been automatically marked as stale because it has not had recent activity.
            It will be closed in 14 days if no further activity occurs.

            If this PR is still relevant, please:
            - Rebase with the latest main branch
            - Address review comments
            - Add a comment explaining the current status
            - Remove the 'stale' label

            Thank you for your contributions!

          close-pr-message: |
            This pull request has been automatically closed due to inactivity.

            If you'd like to continue working on this, please feel free to reopen it
            or create a new pull request with updated changes.

          stale-pr-label:
            stale

            # Labels to exempt from going stale
          exempt-issue-labels: "security,priority: critical,priority: high,pinned,in-progress"
          exempt-pr-labels:
            "security,priority: critical,priority: high,pinned,in-progress,blocked"

            # Draft PRs
          exempt-draft-pr:
            true

            # Milestones
          exempt-all-milestones:
            false

            # Operations per run (to avoid rate limiting)
          operations-per-run:
            100

            # Remove stale label when updated
          remove-stale-when-updated:
            true

            # Ascending order (oldest first)
          ascending:
            true

            # Enable debug output
          debug-only:
            false

            # Exempt issues/PRs with assignees from being marked stale
          exempt-all-assignees:
            true

            # Close reason for stale issues
          close-issue-reason: not_planned

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ§¹ Stale Issue Management" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Stale management workflow completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Policy:**" >> $GITHUB_STEP_SUMMARY
          echo "- Issues/PRs marked stale after 60 days of inactivity" >> $GITHUB_STEP_SUMMARY
          echo "- Closed 14 days after being marked stale" >> $GITHUB_STEP_SUMMARY
          echo "- Exemptions: security, priority: critical, priority: high, pinned" >> $GITHUB_STEP_SUMMARY
