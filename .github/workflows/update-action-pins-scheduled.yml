name: Update Action Pins (Scheduled)

on:
  schedule:
    # Run weekly on Tuesday at 4 AM UTC (after Dependabot Monday runs)
    - cron: '0 4 * * 2'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes made)'
        required: false
        type: boolean
        default: false
      verbose:
        description: 'Verbose output'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update-pins:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # ratchet:actions/setup-python@v5
        with:
          python-version: ${{ vars.PYTHON_VERSION_DEFAULT || '3.12' }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run update-action-pins script
        id: update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd .github

          FLAGS=""
          if [ "${{ inputs.dry_run }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            # Always dry run on schedule first to check for updates
            FLAGS="--dry-run"
          fi
          if [ "${{ inputs.verbose }}" = "true" ]; then
            FLAGS="$FLAGS --verbose"
          fi

          python automation/scripts/utils/update-action-pins.py --recursive $FLAGS | tee update-output.txt

          # Check if updates are available
          if grep -q "action(s) updated" update-output.txt; then
            UPDATES=$(grep "action(s) updated" update-output.txt | tail -1)
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "update_summary=$UPDATES" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply updates (if not dry run)
        if: steps.update.outputs.has_updates == 'true' && inputs.dry_run != true && github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd .github
          python automation/scripts/utils/update-action-pins.py --recursive --verbose

      - name: Create Pull Request
        if: steps.update.outputs.has_updates == 'true' && inputs.dry_run != true
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f  # ratchet:peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(deps): update GitHub Action SHA pins

            Automated update of GitHub Action SHA pins to latest versions.
            See workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Co-Authored-By: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          branch: auto/update-action-pins
          delete-branch: true
          title: 'chore(deps): update GitHub Action SHA pins'
          body: |
            ## Summary
            Automated update of GitHub Action SHA pins to their latest versions.

            ${{ steps.update.outputs.update_summary }}

            ## Changes
            - Updated action references to latest SHA pins
            - Preserved ratchet version comments

            ## Verification
            - [ ] CI passes
            - [ ] No breaking changes in updated actions

            ---
            Generated by [Update Action Pins workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            dependencies
            automated
            chore

      - name: Summary
        run: |
          echo "## Action Pin Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.update.outputs.has_updates }}" = "true" ]; then
            echo "Updates available: ${{ steps.update.outputs.update_summary }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.dry_run }}" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> **Note:** This was a dry run. No changes were made." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "All action pins are up to date." >> $GITHUB_STEP_SUMMARY
          fi
