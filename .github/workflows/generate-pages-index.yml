name: Generate GitHub Pages Index

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'docs/_data/walkthroughs.yml'
      - 'docs/_data/app-deployments.yml'

permissions:
  contents: write

jobs:
  generate-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js for API queries
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Query GitHub API for all organization walkthroughs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Querying GitHub API for walkthrough metadata..."
          
          # Create data directory
          mkdir -p docs/_data
          
          # Initialize YAML file
          cat > docs/_data/walkthroughs.yml << 'YAML_HEADER'
          # Auto-generated walkthrough metadata
          # Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          walkthroughs:
          YAML_HEADER
          
          # Get all organization repositories
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${{ github.repository_owner }}/repos?per_page=100&sort=updated" \
            --jq '.[] | {name: .name, full_name: .full_name, description: .description, topics: .topics, html_url: .html_url, updated_at: .updated_at}' \
            > repos.json
          
          # Process each repository
          count=0
          while IFS= read -r repo_json; do
            repo_name=$(echo "$repo_json" | jq -r '.name')
            full_name=$(echo "$repo_json" | jq -r '.full_name')
            description=$(echo "$repo_json" | jq -r '.description // "No description available"')
            html_url=$(echo "$repo_json" | jq -r '.html_url')
            updated_at=$(echo "$repo_json" | jq -r '.updated_at')
            
            # Get topics as comma-separated string
            topics=$(echo "$repo_json" | jq -r '.topics | join(", ")')
            
            echo "Processing repository: $repo_name"
            
            # Check for walkthrough videos in artifacts
            video_url=""
            artifact_response=$(gh api \
              "/repos/$full_name/actions/artifacts?name=walkthrough-video&per_page=1" \
              2>/dev/null || echo '{"total_count":0}')
            
            artifact_count=$(echo "$artifact_response" | jq -r '.total_count // 0')
            
            if [ "$artifact_count" -gt 0 ]; then
              video_url=$(echo "$artifact_response" | jq -r '.artifacts[0].archive_download_url // ""')
              created_at=$(echo "$artifact_response" | jq -r '.artifacts[0].created_at // ""')
              
              # Add to YAML
              cat >> docs/_data/walkthroughs.yml << YAML_ENTRY
            - name: "$repo_name"
              description: "$description"
              repository: "$full_name"
              repo_url: "$html_url"
              video_url: "$video_url"
              created_at: "$created_at"
              updated_at: "$updated_at"
              tech_stack: "$topics"
              has_video: true
          YAML_ENTRY
              
              count=$((count + 1))
            else
              # Add repository without video
              cat >> docs/_data/walkthroughs.yml << YAML_ENTRY
            - name: "$repo_name"
              description: "$description"
              repository: "$full_name"
              repo_url: "$html_url"
              video_url: ""
              created_at: "$updated_at"
              updated_at: "$updated_at"
              tech_stack: "$topics"
              has_video: false
          YAML_ENTRY
            fi
          done < repos.json
          
          echo "Processed $count repositories with walkthrough videos"

      - name: Parse video metadata
        run: |
          echo "Parsing video metadata for gallery display..."
          
          # Ensure walkthroughs.yml exists
          if [ ! -f "docs/_data/walkthroughs.yml" ]; then
            echo "walkthroughs: []" > docs/_data/walkthroughs.yml
          fi
          
          echo "Video metadata parsing complete"

      - name: Generate index page
        run: |
          cat > docs/index.md << 'INDEX_PAGE'
          ---
          layout: default
          title: Home
          ---
          
          <div class="gallery">
            <h2>Application Walkthroughs & Tutorials</h2>
            <p>Explore our collection of application tutorials with live demos and video guides.</p>
            
            {% include walkthrough_gallery.html %}
          </div>
          INDEX_PAGE
          
          echo "Generated docs/index.md"

      - name: Create/update gallery page
        run: |
          mkdir -p docs/tutorials
          
          cat > docs/tutorials/index.md << 'GALLERY_PAGE'
          ---
          layout: default
          title: Video Tutorials
          ---
          
          <div class="gallery">
            <h2>Video Tutorials Gallery</h2>
            <p>Watch step-by-step tutorials for all our applications.</p>
            
            <div class="filters" style="margin: 2rem 0;">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="nodejs">Node.js</button>
              <button class="filter-btn" data-filter="python">Python</button>
              <button class="filter-btn" data-filter="react">React</button>
              <button class="filter-btn" data-filter="vue">Vue</button>
            </div>
            
            {% include walkthrough_gallery.html %}
          </div>
          
          <style>
            .filters {
              display: flex;
              gap: 1rem;
              flex-wrap: wrap;
            }
            
            .filter-btn {
              padding: 0.5rem 1.5rem;
              background: var(--surface);
              color: var(--text-primary);
              border: 1px solid var(--border-color);
              border-radius: 0.375rem;
              cursor: pointer;
              transition: all 0.2s;
            }
            
            .filter-btn:hover {
              background: var(--primary-color);
              color: white;
              border-color: var(--primary-color);
            }
            
            .filter-btn.active {
              background: var(--primary-color);
              color: white;
              border-color: var(--primary-color);
            }
          </style>
          
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const filterBtns = document.querySelectorAll('.filter-btn');
              const cards = document.querySelectorAll('.card');
              
              filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                  const filter = this.getAttribute('data-filter');
                  
                  filterBtns.forEach(b => b.classList.remove('active'));
                  this.classList.add('active');
                  
                  cards.forEach(card => {
                    const techStack = card.getAttribute('data-tech-stack') || '';
                    if (filter === 'all' || techStack.toLowerCase().includes(filter)) {
                      card.style.display = 'block';
                    } else {
                      card.style.display = 'none';
                    }
                  });
                });
              });
            });
          </script>
          GALLERY_PAGE
          
          echo "Generated docs/tutorials/index.md"

      - name: Auto-commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/_data/walkthroughs.yml docs/index.md docs/tutorials/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update walkthrough gallery index [skip ci]"
            git push
            echo "Changes committed and pushed"
          fi

      - name: Prevent duplicate commits
        run: |
          # Check last commit message
          last_commit=$(git log -1 --pretty=%B)
          if [[ "$last_commit" == *"Update walkthrough gallery index"* ]]; then
            echo "Last commit was an index update, skipping duplicate commit"
            exit 0
          fi
