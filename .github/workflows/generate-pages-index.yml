name: "Generate Pages Index"

on:
  # Run on schedule (every 6 hours)
  schedule:
    - cron: "30 */6 * * *"
  # Manual trigger
  workflow_dispatch:
  # Allow reuse from other repositories
  workflow_call:
  # Trigger when new repositories are created or updated
  repository_dispatch:
    types:
      - repository-created
      - repository-updated
      - deployment-updated

concurrency:
  group: "pages-index-generation"
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  generate-index:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: "Install yq"
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: "Query GitHub API for walkthroughs"
        id: query
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Querying GitHub API for organization walkthroughs..."

          ORG_NAME="${{ github.repository_owner }}"

          # Create data directory
          mkdir -p docs/_data

          # Initialize data files
          echo "# Walkthroughs Data" > docs/_data/walkthroughs.yml
          echo "# Auto-generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> docs/_data/walkthroughs.yml
          echo "" >> docs/_data/walkthroughs.yml

          echo "# Repositories Data" > docs/_data/repositories.yml
          echo "# Auto-generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> docs/_data/repositories.yml
          echo "" >> docs/_data/repositories.yml

          echo "# Live Demos Data" > docs/_data/live_demos.yml
          echo "# Auto-generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> docs/_data/live_demos.yml
          echo "" >> docs/_data/live_demos.yml

          echo "# App Deployments Registry" > docs/_data/app-deployments.yml
          echo "# Auto-generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> docs/_data/app-deployments.yml
          echo "# This file tracks all live app deployments across the organization" >> docs/_data/app-deployments.yml
          echo "" >> docs/_data/app-deployments.yml

          # Fetch all organization repositories
          echo "ðŸ“¦ Fetching repositories for $ORG_NAME..."

          gh api "orgs/$ORG_NAME/repos" \
            --paginate \
            --jq '.[] | select(.archived == false)' > /tmp/repos.json

          REPO_COUNT=$(jq length /tmp/repos.json 2>/dev/null || echo "0")
          echo "Found $REPO_COUNT active repositories"

          WALKTHROUGH_COUNT=0
          DEMO_COUNT=0
          DEPLOYMENT_COUNT=0

          # Process each repository (use process substitution to maintain variable scope)
          while IFS= read -r repo; do
            REPO_NAME=$(echo "$repo" | jq -r '.name')
            REPO_FULL_NAME=$(echo "$repo" | jq -r '.full_name')
            REPO_DESCRIPTION=$(echo "$repo" | jq -r '.description // "No description"')
            REPO_URL=$(echo "$repo" | jq -r '.html_url')
            REPO_CREATED=$(echo "$repo" | jq -r '.created_at')
            REPO_UPDATED=$(echo "$repo" | jq -r '.updated_at')
            REPO_LANGUAGE=$(echo "$repo" | jq -r '.language // "Unknown"')
            REPO_STARS=$(echo "$repo" | jq -r '.stargazers_count')

            echo "  â†’ Processing $REPO_FULL_NAME..."

            # Add to repositories data
            cat >> docs/_data/repositories.yml <<EOF
          - name: "$REPO_NAME"
            full_name: "$REPO_FULL_NAME"
            description: "$REPO_DESCRIPTION"
            url: "$REPO_URL"
            language: "$REPO_LANGUAGE"
            stars: $REPO_STARS
            created_at: "$REPO_CREATED"
            updated_at: "$REPO_UPDATED"

          EOF

            # Check for walkthrough videos
            # Look in common locations: /docs/walkthroughs, /walkthroughs, /.github/walkthroughs
            for path in "docs/walkthroughs" "walkthroughs" ".github/walkthroughs"; do
              WALKTHROUGH_CONTENT=$(gh api "repos/$REPO_FULL_NAME/contents/$path" 2>/dev/null || echo "[]")

              if [ "$WALKTHROUGH_CONTENT" != "[]" ]; then
                echo "    âœ“ Found walkthroughs in $path"

                # Process video files
                echo "$WALKTHROUGH_CONTENT" | jq -c '.[] | select(.name | endswith(".mp4") or endswith(".webm") or endswith(".mov"))' | while read -r video; do
                  if [ -z "$video" ]; then
                    continue
                  fi

                  VIDEO_NAME=$(echo "$video" | jq -r '.name')
                  VIDEO_URL=$(echo "$video" | jq -r '.download_url')
                  VIDEO_SIZE=$(echo "$video" | jq -r '.size')

                  # Clean video name for title
                  VIDEO_TITLE=$(echo "$VIDEO_NAME" | sed 's/\.[^.]*$//' | sed 's/[-_]/ /g' | sed 's/\b\(.\)/\u\1/g')

                  # Check for metadata file
                  METADATA_FILE="${VIDEO_NAME%.*}.json"
                  METADATA=$(gh api "repos/$REPO_FULL_NAME/contents/$path/$METADATA_FILE" 2>/dev/null || echo "{}")

                  if [ "$METADATA" != "{}" ]; then
                    VIDEO_DESCRIPTION=$(echo "$METADATA" | jq -r '.content' | base64 -d | jq -r '.description // ""')
                    VIDEO_TAGS=$(echo "$METADATA" | jq -r '.content' | base64 -d | jq -r '.tags // []' | jq -r 'join(", ")')
                  else
                    VIDEO_DESCRIPTION="$REPO_DESCRIPTION"
                    VIDEO_TAGS="walkthrough, demo"
                  fi

                  # Add to walkthroughs data
                  cat >> docs/_data/walkthroughs.yml <<EOF
          - title: "$VIDEO_TITLE"
            repository: "$REPO_FULL_NAME"
            description: "$VIDEO_DESCRIPTION"
            video_url: "$VIDEO_URL"
            thumbnail_url: ""
            video_size: $VIDEO_SIZE
            updated_at: "$REPO_UPDATED"
            repository_url: "$REPO_URL"
            tags:
              - walkthrough
              - demo
            language: "$REPO_LANGUAGE"

          EOF

                  WALKTHROUGH_COUNT=$((WALKTHROUGH_COUNT + 1))
                done
              fi
            done

            # Check for live demo badge in README
            README_CONTENT=$(gh api "repos/$REPO_FULL_NAME/readme" 2>/dev/null || echo "{}")

            if [ "$README_CONTENT" != "{}" ]; then
              README_TEXT=$(echo "$README_CONTENT" | jq -r '.content' | base64 -d)

              # Look for AgentSphere demo link
              if echo "$README_TEXT" | grep -q "agentsphere.dev"; then
                DEMO_URL=$(echo "$README_TEXT" | grep -oP 'https://[^\s)]+agentsphere\.dev[^\s)]*' | head -1)

                if [ -n "$DEMO_URL" ]; then
                  echo "    âœ“ Found live demo: $DEMO_URL"

                  # Add to live demos data
                  cat >> docs/_data/live_demos.yml <<EOF
          - repository: "$REPO_FULL_NAME"
            repository_url: "$REPO_URL"
            demo_url: "$DEMO_URL"
            status: "active"
            updated_at: "$REPO_UPDATED"

          EOF

                  DEMO_COUNT=$((DEMO_COUNT + 1))
                fi
              fi
            fi

            # Check for deployment configuration
            # If a repo has .github/app-deployment-config.yml, query its deployment status
            DEPLOY_CONFIG=$(gh api "repos/$REPO_FULL_NAME/contents/.github/app-deployment-config.yml" 2>/dev/null || echo "{}")
            
            if [ "$DEPLOY_CONFIG" != "{}" ]; then
              echo "    âœ“ Found deployment configuration"
              
              # Parse deployment config using yq
              CONFIG_CONTENT=$(echo "$DEPLOY_CONFIG" | jq -r '.content' | base64 -d)
              DEPLOY_ENABLED=$(echo "$CONFIG_CONTENT" | yq eval '.deployment.enabled // true' - 2>/dev/null || echo "true")
              DEPLOY_STRATEGY=$(echo "$CONFIG_CONTENT" | yq eval '.deployment.strategy // "auto"' - 2>/dev/null || echo "auto")
              
              if [ "$DEPLOY_ENABLED" = "true" ]; then
                # Query recent successful deployment runs
                DEPLOY_RUNS=$(gh api "repos/$REPO_FULL_NAME/actions/workflows/deploy-to-pages-live.yml/runs?per_page=1&status=success" 2>/dev/null || echo '{"workflow_runs": []}')
                LATEST_RUN=$(echo "$DEPLOY_RUNS" | jq -r '.workflow_runs[0]' 2>/dev/null || echo "{}")
                
                if [ "$LATEST_RUN" != "{}" ] && [ "$LATEST_RUN" != "null" ]; then
                  RUN_ID=$(echo "$LATEST_RUN" | jq -r '.id')
                  RUN_DATE=$(echo "$LATEST_RUN" | jq -r '.updated_at')
                  RUN_URL=$(echo "$LATEST_RUN" | jq -r '.html_url')
                  
                  # Construct deployment URL based on strategy
                  if [ "$DEPLOY_STRATEGY" = "pages-direct" ] || [ "$DEPLOY_STRATEGY" = "auto" ]; then
                    DEPLOY_URL="https://${ORG_NAME}.github.io/${REPO_NAME}"
                  elif [ "$DEPLOY_STRATEGY" = "codespaces" ]; then
                    DEPLOY_URL="https://github.com/${REPO_FULL_NAME}/codespaces"
                  else
                    DEPLOY_URL="$REPO_URL"
                  fi
                  
                  echo "    âœ“ Found deployment: $DEPLOY_URL"
                  
                  # Add to app-deployments data
                  cat >> docs/_data/app-deployments.yml <<EOF
          - repository: "$REPO_FULL_NAME"
            source_url: "$REPO_URL"
            app_type: "detected"
            deployment_strategy: "$DEPLOY_STRATEGY"
            live_url: "$DEPLOY_URL"
            status: "deployed"
            last_updated: "$RUN_DATE"
            workflow_run_url: "$RUN_URL"

          EOF
                  
                  DEPLOYMENT_COUNT=$((DEPLOYMENT_COUNT + 1))
                fi
              fi
            fi

          done < <(jq -c '.' /tmp/repos.json 2>/dev/null || echo '[]')

          # Output statistics
          echo "repository_count=$REPO_COUNT" >> $GITHUB_OUTPUT
          echo "walkthrough_count=$WALKTHROUGH_COUNT" >> $GITHUB_OUTPUT
          echo "demo_count=$DEMO_COUNT" >> $GITHUB_OUTPUT
          echo "deployment_count=$DEPLOYMENT_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… Index generation complete"
          echo "   Repositories: $REPO_COUNT"
          echo "   Walkthroughs: $WALKTHROUGH_COUNT"
          echo "   Live Demos: $DEMO_COUNT"
          echo "   Deployments: $DEPLOYMENT_COUNT"

      - name: "Generate statistics file"
        run: |
          cat > docs/_data/statistics.yml <<EOF
          # Statistics
          # Generated at $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          repositories: ${{ steps.query.outputs.repository_count }}
          walkthroughs: ${{ steps.query.outputs.walkthrough_count }}
          live_demos: ${{ steps.query.outputs.demo_count }}
          deployments: ${{ steps.query.outputs.deployment_count }}
          last_updated: "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          EOF

          echo "âœ… Statistics file created"

      - name: "Check for changes"
        id: changes
        run: |
          git add docs/_data/*.yml

          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Changes detected"
          fi

      - name: "Commit and push changes"
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "chore: update walkthrough gallery index

          - Repositories: ${{ steps.query.outputs.repository_count }}
          - Walkthroughs: ${{ steps.query.outputs.walkthrough_count }}
          - Live Demos: ${{ steps.query.outputs.demo_count }}

          Auto-generated by generate-pages-index workflow"

          git push

          echo "âœ… Changes committed and pushed"

      - name: "Trigger Pages build"
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Trigger build-pages-site workflow
          gh workflow run build-pages-site.yml \
            --ref ${{ github.ref_name }}

          echo "âœ… Pages build triggered"

      - name: "Generate summary"
        if: always()
        run: |
          echo "## Pages Index Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… **Status:** Index Updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status:** No Changes" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repositories Scanned:** ${{ steps.query.outputs.repository_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Walkthroughs Found:** ${{ steps.query.outputs.walkthrough_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Live Demos Found:** ${{ steps.query.outputs.demo_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "ðŸ“¦ Changes committed and pushed to repository." >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ GitHub Pages build triggered." >> $GITHUB_STEP_SUMMARY
          fi
