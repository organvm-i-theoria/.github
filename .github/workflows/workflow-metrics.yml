name: Workflow Metrics Dashboard
on:
  schedule:
  - cron: 0 9 * * *   # Daily at 9:00 AM UTC
  workflow_dispatch:
    inputs:
      days:
        description: Number of days to analyze
        required: false
        default: '7'

permissions:
  issues: read
  pull-requests: read
  contents: write

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    name: Collect Workflow Metrics
    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4

    - name: Calculate Metrics
      id: metrics
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # ratchet:actions/github-script@v7
      with:
        script: |
          const days = parseInt(context.payload.inputs?.days || '7');
          const since = new Date();
          since.setDate(since.getDate() - days);
          const sinceISO = since.toISOString();

          core.info(`Collecting metrics for last ${days} days (since ${sinceISO})`);

          // Fetch data
          const issues = await github.paginate(github.rest.issues.listForRepo, {
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            since: sinceISO,
            per_page: 100
          });

          const prs = await github.paginate(github.rest.pulls.list, {
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'all',
            per_page: 100
          });

          const recentPRs = prs.filter(pr => new Date(pr.created_at) >= since);

          // Calculate metrics
          const issuesCreated = issues.filter(i => !i.pull_request).length;
          const issuesClosed = issues.filter(i => !i.pull_request && i.state === 'closed').length;
          const prsCreated = recentPRs.length;
          const prsMerged = recentPRs.filter(pr => pr.merged_at).length;

          // Store as outputs
          core.setOutput('issues_created', issuesCreated);
          core.setOutput('issues_closed', issuesClosed);
          core.setOutput('prs_created', prsCreated);
          core.setOutput('prs_merged', prsMerged);
          core.setOutput('period_days', days);

          return { issuesCreated, issuesClosed, prsCreated, prsMerged, days };

    - name: Create Metrics Summary
      run: |
        cat << 'EOF' > docs/WORKFLOW_METRICS_REPORT.md
        # Workflow Metrics Dashboard

        **Period:** Last ${{ steps.metrics.outputs.period_days }} days
        **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ## Key Metrics

        | Metric | Value |
        |--------|-------|
        | Issues Created | ${{ steps.metrics.outputs.issues_created }} |
        | Issues Closed | ${{ steps.metrics.outputs.issues_closed }} |
        | PRs Created | ${{ steps.metrics.outputs.prs_created }} |
        | PRs Merged | ${{ steps.metrics.outputs.prs_merged }} |

        **Note:** Full metrics with KPIs will be available in future updates.

        ---

        _Generated by workflow-metrics.yml_
        EOF

    - name: Commit Metrics Report
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        if [ -f docs/WORKFLOW_METRICS_REPORT.md ]; then
          git add docs/WORKFLOW_METRICS_REPORT.md
          git diff --staged --quiet || git commit -m "chore: update workflow metrics report [skip ci]"
          git push || echo "Nothing to push"
        fi
