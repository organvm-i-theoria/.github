name: Auto-Enable Merge

# This workflow automatically enables auto-merge for pull requests that meet certain criteria
# This solves the "eternal" problem by automatically configuring PRs for merging

on:
  pull_request:
    types: [opened, labeled, ready_for_review]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-enable-merge:
    name: Auto-Enable Merge for Qualifying PRs
    runs-on: ubuntu-latest

    steps:
    - name: Check if auto-merge should be enabled
      id: should-enable
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea   # ratchet:actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;

          // Skip if already merged or closed
          if (pr.state !== 'open') {
            return { enable: false, reason: 'PR not open' };
          }

          // Skip if draft
          if (pr.draft) {
            return { enable: false, reason: 'PR is draft' };
          }

          // Skip if explicitly marked to skip
          if (pr.labels.some(l => l.name.includes('skip-auto-merge') || l.name === 'needs-review')) {
            return { enable: false, reason: 'Skip label present' };
          }

          // Enable for:
          // 1. PRs with auto-merge label
          // 2. PRs with [auto-merge] in title
          // 3. Dependabot PRs (minor/patch updates)
          // 4. Auto-generated PRs (renovate, etc.)
          // 5. Documentation-only PRs

          const hasAutoMergeLabel = pr.labels.some(l =>
            l.name === 'auto-merge' ||
            l.name === 'automerge' ||
            l.name === 'auto-created'
          );

          const titleIndicatesAutoMerge = /\[auto-?merge\]/i.test(pr.title);

          const isDependabot = pr.user.login === 'dependabot[bot]' &&
            !pr.title.toLowerCase().includes('major');

          const isAutoGenerated = pr.labels.some(l =>
            l.name === 'auto-created' ||
            l.name === 'dependencies'
          );

          const isDocsOnly = pr.labels.some(l => l.name === 'documentation') &&
            pr.changed_files < 10;

          const shouldEnable = hasAutoMergeLabel ||
                              titleIndicatesAutoMerge ||
                              isDependabot ||
                              isAutoGenerated ||
                              isDocsOnly;

          if (shouldEnable) {
            core.setOutput('enable', 'true');
            core.setOutput('pr-number', pr.number);
            core.setOutput('pr-url', pr.html_url);
            return { enable: true, reason: 'Meets auto-merge criteria' };
          }

          return { enable: false, reason: 'Does not meet criteria' };

    - name: Enable auto-merge
      if: steps.should-enable.outputs.enable == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_URL: ${{ steps.should-enable.outputs.pr-url }}
      run: |
        # Enable auto-merge using GitHub CLI
        echo "Enabling auto-merge for PR: $PR_URL"

        # Try to enable auto-merge (may fail if checks not complete yet)
        if gh pr merge --auto --squash "$PR_URL" 2>/dev/null; then
          echo "âœ… Auto-merge enabled successfully"

          # Add informative comment
          gh pr comment "$PR_URL" --body "ðŸ¤– **Auto-Merge Enabled**

          This PR has been configured for automatic merging. It will be merged automatically when:

          - âœ… All required status checks pass
          - âœ… Required approvals are obtained
          - âœ… No merge conflicts exist

          To disable auto-merge, add the \`needs-review\` label or \`[skip-auto-merge]\` to the title."
        else
          echo "â³ Auto-merge not ready yet (checks may not be complete)"

          gh pr comment "$PR_URL" --body "ðŸ¤– **Auto-Merge Queued**

          This PR will be evaluated for automatic merging once all checks are complete.

          **Current status:** Waiting for initial checks to run

          The auto-merge workflow will automatically enable merging when ready."
        fi

    - name: Check for approvals
      if: steps.should-enable.outputs.enable == 'true'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea   # ratchet:actions/github-script@v7
      with:
        script: |
          const prNumber = ${{ steps.should-enable.outputs.pr-number }};

          // Get PR details
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });

          // For dependabot/bot PRs, auto-approve if allowed
          if (pr.user.type === 'Bot') {
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: 'ðŸ¤– Auto-approved by automation (bot-generated PR)'
              });
              console.log('âœ… Auto-approved bot PR');
            } catch (error) {
              console.log('Cannot auto-approve:', error.message);
            }
          }

    - name: Add auto-merge label
      if: steps.should-enable.outputs.enable == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_URL: ${{ steps.should-enable.outputs.pr-url }}
      run: |
        # Ensure auto-merge label exists
        gh label create "auto-merge" \
          --description "PR will be automatically merged when ready" \
          --color "0E8A16" \
          --force 2>/dev/null || true

        # Add label to PR
        gh pr edit "$PR_URL" --add-label "auto-merge"

    - name: Summary
      if: always()
      run: |
        echo "### ðŸ¤– Auto-Merge Enabler Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.should-enable.outputs.enable }}" = "true" ]; then
          echo "âœ… **Auto-merge enabled for PR #${{ steps.should-enable.outputs.pr-number }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The PR will be automatically merged when all conditions are met:" >> $GITHUB_STEP_SUMMARY
          echo "- All required checks pass" >> $GITHUB_STEP_SUMMARY
          echo "- Required approvals obtained" >> $GITHUB_STEP_SUMMARY
          echo "- No merge conflicts" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **Auto-merge not enabled**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR does not meet the criteria for automatic merging." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable auto-merge, either:" >> $GITHUB_STEP_SUMMARY
          echo "- Add the \`auto-merge\` label" >> $GITHUB_STEP_SUMMARY
          echo "- Include \`[auto-merge]\` in the PR title" >> $GITHUB_STEP_SUMMARY
        fi
