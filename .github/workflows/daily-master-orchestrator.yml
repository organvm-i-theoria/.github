name: Daily Master Orchestrator

on:
  schedule:
    # Run once per day at 1 AM UTC - coordinates all daily operations
  - cron: 0 1 * * *
  workflow_dispatch:
    inputs:
      force_run:
        description: Force run even if already executed today
        required: false
        type: boolean
        default: false
      wait_time_minutes:
        description: Minutes to wait for tasks to complete before consolidation
        required: false
        type: number
        default: 30

concurrency:
  group: daily-master-orchestrator
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  checks: read

jobs:
  check-if-should-run:
    name: Check If Should Run Today
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}

    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5.3.0
      with:
        python-version: '3.12'
        cache: pip

    - name: Check Last Run
      id: check
      run: |
        FORCE_RUN="${{ github.event.inputs.force_run }}"
        TODAY=$(date -u +%Y-%m-%d)

        # Check if we already ran today
        if [ -f ".github/task_state.json" ]; then
          LAST_ORCHESTRATION=$(jq -r '.last_orchestration // "never"' .github/task_state.json)

          if [ "$LAST_ORCHESTRATION" = "$TODAY" ] && [ "$FORCE_RUN" != "true" ]; then
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Already ran today ($TODAY), skipping"
            exit 0
          fi
        fi

        echo "should-run=true" >> $GITHUB_OUTPUT
        echo "âœ… Should run orchestration for $TODAY"

  orchestrate-daily-tasks:
    name: Orchestrate Daily Tasks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-if-should-run
    if: needs.check-if-should-run.outputs.should-run == 'true'
    outputs:
      tasks-executed: ${{ steps.orchestrate.outputs.tasks-executed }}

    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5.3.0
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        pip install croniter

    - name: Execute Daily Orchestration
      id: orchestrate
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TODAY=$(date -u +%Y-%m-%d)
        echo "ðŸŽ¯ Orchestrating daily tasks for $TODAY"

        # Get tasks scheduled for today
        python3 .github/scripts/get_daily_tasks.py

        TASK_COUNT=$(jq 'length' /tmp/daily_tasks.json)
        echo "tasks-executed=$TASK_COUNT" >> $GITHUB_OUTPUT

        # Dispatch tasks with deduplication
        jq -c '.[]' /tmp/daily_tasks.json | while read -r task; do
          TASK_ID=$(echo "$task" | jq -r '.id')
          SUBSCRIPTION=$(echo "$task" | jq -r '.subscription')
          PROMPT=$(echo "$task" | jq -r '.prompt')

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Task: $TASK_ID"
          echo "Subscription: $SUBSCRIPTION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Check if task is duplicate using deduplication system
          TASK_DATA=$(echo "$task" | jq -c '{id, subscription, prompt}')
          DEDUPE_RESULT=$(python3 .github/scripts/task_deduplicator.py check "orchestrated_task" "$TASK_DATA" || echo '{"should_process":false,"reason":"script error"}')

          SHOULD_PROCESS=$(echo "$DEDUPE_RESULT" | jq -r '.should_process')
          REASON=$(echo "$DEDUPE_RESULT" | jq -r '.reason')

          if [ "$SHOULD_PROCESS" = "true" ]; then
            echo "âœ… Processing task: $REASON"

            # Get workflow file for subscription
            WORKFLOW_FILE=$(jq -r --arg name "$SUBSCRIPTION" \
              '.subscriptions[] | select(.name==$name) | .relevant_workflows[0] // empty' \
              .github/subscriptions.json)

            if [ -n "$WORKFLOW_FILE" ] && [ "$WORKFLOW_FILE" != "null" ]; then
              echo "Dispatching workflow: $WORKFLOW_FILE"
              gh workflow run "$WORKFLOW_FILE" --ref ${{ github.ref }} -f "prompt=$PROMPT" || echo "Failed to dispatch"
            else
              echo "âš ï¸  No workflow found for $SUBSCRIPTION"
            fi
          else
            echo "â­ï¸  Skipping task: $REASON"
          fi
        done

        # Update state
        if [ ! -f ".github/task_state.json" ]; then
          echo '{"processed_tasks":{},"active_prs":[],"last_orchestration":null}' > .github/task_state.json
        fi

        jq --arg date "$TODAY" '.last_orchestration = $date' .github/task_state.json > /tmp/task_state.json
        mv /tmp/task_state.json .github/task_state.json

    - name: Commit State Changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add .github/task_state.json
        git diff --staged --quiet || git commit -m "chore: update daily orchestration state [skip ci]"
        git push origin ${{ github.ref_name }} || echo "No changes to push"

  process-task-queue:
    name: Process Queued Tasks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [check-if-should-run, orchestrate-daily-tasks]
    if: always() && needs.check-if-should-run.outputs.should-run == 'true'

    steps:
    - name: Trigger Queue Processing
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ”„ Triggering task queue processing..."
        gh workflow run process_queue.yml --repo ${{ github.repository }}

  consolidate-prs:
    name: Consolidate All Open PRs
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [check-if-should-run, orchestrate-daily-tasks, process-task-queue]
    if: always() && needs.check-if-should-run.outputs.should-run == 'true'

    steps:
    - name: Wait for Task Completion
      run: |
        WAIT_MINUTES="${{ github.event.inputs.wait_time_minutes || 30 }}"
        WAIT_SECONDS=$((WAIT_MINUTES * 60))
        echo "â³ Waiting $WAIT_MINUTES minutes for tasks to complete and PRs to be created..."
        sleep $WAIT_SECONDS

    - name: Trigger PR Consolidation
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ”€ Triggering PR consolidation workflow..."
        gh workflow run daily-pr-consolidator.yml --repo ${{ github.repository }}

  cleanup:
    name: Cleanup Old Records
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [check-if-should-run, consolidate-prs]
    if: always() && needs.check-if-should-run.outputs.should-run == 'true'

    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5.3.0
      with:
        python-version: '3.12'
        cache: pip

    - name: Run Cleanup
      run: |
        echo "ðŸ§¹ Cleaning up old task records..."
        python3 .github/scripts/task_deduplicator.py cleanup 7

    - name: Commit Cleanup Changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add .github/task_state.json
        git diff --staged --quiet || git commit -m "chore: cleanup old task records [skip ci]"
        git push origin ${{ github.ref_name }} || echo "No changes to push"

  summary:
    name: Daily Orchestration Summary
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [check-if-should-run, orchestrate-daily-tasks, process-task-queue, consolidate-prs, cleanup]
    if: always()

    steps:
    - name: Generate Summary
      run: |
        echo "# ðŸŽ¯ Daily Master Orchestration Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Should Run:** ${{ needs.check-if-should-run.outputs.should-run }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.check-if-should-run.outputs.should-run }}" = "true" ]; then
          echo "## ðŸ“Š Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Tasks Executed: ${{ needs.orchestrate-daily-tasks.outputs.tasks-executed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Queue Processing: ${{ needs.process-task-queue.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- PR Consolidation: ${{ needs.consolidate-prs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Cleanup: ${{ needs.cleanup.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Daily Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Orchestrated daily tasks with deduplication" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Processed task queue" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Consolidated all open PRs into single PR" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… Cleaned up old records" >> $GITHUB_STEP_SUMMARY
        else
          echo "â­ï¸  Skipped - already ran today" >> $GITHUB_STEP_SUMMARY
        fi
