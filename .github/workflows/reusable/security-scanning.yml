name: Security Scanning (Reusable)

on:
  workflow_call:
    inputs:
      scan-type:
        description: "Type of scan (codeql, trivy, semgrep, secrets, all)"
        required: false
        type: string
        default: "all"
      languages:
        description: "Languages for CodeQL (comma-separated: python,javascript,go,etc)"
        required: false
        type: string
        default: "python,javascript,typescript,go"
      severity-threshold:
        description: "Minimum severity to report (CRITICAL, HIGH, MEDIUM, LOW)"
        required: false
        type: string
        default: "MEDIUM"
      fail-on-severity:
        description: "Fail build on this severity or higher"
        required: false
        type: string
        default: "HIGH"
      trivy-scan-type:
        description: "Trivy scan type (fs, image, config, repo)"
        required: false
        type: string
        default: "fs"
      working-directory:
        description: "Working directory for scans"
        required: false
        type: string
        default: "."
    outputs:
      codeql-sarif:
        description: "Path to CodeQL SARIF results"
        value: ${{ jobs.security-scan.outputs.codeql-sarif }}
      trivy-report:
        description: "Path to Trivy report"
        value: ${{ jobs.security-scan.outputs.trivy-report }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    outputs:
      codeql-sarif: ${{ steps.codeql.outputs.sarif-path }}
      trivy-report: ${{ steps.trivy.outputs.report-path }}

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      # CodeQL Analysis
      - name: Initialize CodeQL
        if: inputs.scan-type == 'codeql' || inputs.scan-type == 'all'
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ inputs.languages }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        if: inputs.scan-type == 'codeql' || inputs.scan-type == 'all'
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        if: inputs.scan-type == 'codeql' || inputs.scan-type == 'all'
        id: codeql
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ inputs.languages }}"
          output: codeql-results

      # Trivy Security Scan
      - name: Run Trivy vulnerability scanner
        if: inputs.scan-type == 'trivy' || inputs.scan-type == 'all'
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: ${{ inputs.trivy-scan-type }}
          scan-ref: ${{ inputs.working-directory }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: ${{ inputs.severity-threshold }}
          exit-code: ${{ inputs.fail-on-severity == 'CRITICAL' && '1' || '0' }}

      - name: Upload Trivy results to GitHub Security
        if: inputs.scan-type == 'trivy' || inputs.scan-type == 'all'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy"

      # Semgrep SAST Scan
      - name: Run Semgrep
        if: inputs.scan-type == 'semgrep' || inputs.scan-type == 'all'
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
          generateSarif: true

      - name: Upload Semgrep results
        if: inputs.scan-type == 'semgrep' || inputs.scan-type == 'all'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: "semgrep"

      # Secret Scanning
      - name: Run secret scan with detect-secrets
        if: inputs.scan-type == 'secrets' || inputs.scan-type == 'all'
        run: |
          pip install detect-secrets
          detect-secrets scan --all-files --baseline .secrets.baseline || true
          if [ -f .secrets.baseline ]; then
            echo "Secret scan complete. Review .secrets.baseline for any findings."
          fi

      - name: Upload security scan artifacts
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: security-scan-results
          path: |
            codeql-results/
            trivy-results.sarif
            semgrep.sarif
            .secrets.baseline
          retention-days: 30
