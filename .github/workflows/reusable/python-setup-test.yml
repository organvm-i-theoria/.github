name: Python Setup & Test (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version to use (falls back to vars.PYTHON_VERSION_DEFAULT, then 3.12)
        required: false
        type: string
        default: ''  # Empty triggers fallback logic
      requirements-file:
        description: Path to requirements file
        required: false
        type: string
        default: requirements.txt
      run-tests:
        description: Whether to run tests
        required: false
        type: boolean
        default: true
      test-command:
        description: Command to run tests
        required: false
        type: string
        default: pytest --cov=. --cov-report=xml
      install-dev-deps:
        description: Install development dependencies
        required: false
        type: boolean
        default: false
      cache-dependency-path:
        description: Path to cache dependencies
        required: false
        type: string
        default: '**/requirements*.txt'
      working-directory:
        description: Working directory for commands
        required: false
        type: string
        default: .
    outputs:
      coverage-report-path:
        description: Path to coverage report
        value: ${{ jobs.setup-test.outputs.coverage-path }}
      test-results-path:
        description: Path to test results
        value: ${{ jobs.setup-test.outputs.test-path }}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup-test:
    runs-on: ubuntu-latest
    outputs:
      coverage-path: ${{ steps.run-tests.outputs.coverage-path }}
      test-path: ${{ steps.run-tests.outputs.test-path }}

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Determine Python version
      id: python-version
      run: |
        # Priority: input > repository variable > default
        INPUT_VERSION="${{ inputs.python-version }}"
        REPO_VAR_VERSION="${{ vars.PYTHON_VERSION_DEFAULT }}"
        DEFAULT_VERSION="3.12"

        if [ -n "$INPUT_VERSION" ]; then
          VERSION="$INPUT_VERSION"
        elif [ -n "$REPO_VAR_VERSION" ]; then
          VERSION="$REPO_VAR_VERSION"
        else
          VERSION="$DEFAULT_VERSION"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Using Python version: $VERSION"

    - name: Set up Python ${{ steps.python-version.outputs.version }}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: ${{ steps.python-version.outputs.version }}
        cache: pip
        cache-dependency-path: ${{ inputs.cache-dependency-path }}

    - name: Install dependencies
      working-directory: ${{ inputs.working-directory }}
      run: |
        python -m pip install --upgrade pip
        if [ -f "${{ inputs.requirements-file }}" ]; then
          pip install -r ${{ inputs.requirements-file }}
        fi

    - name: Install development dependencies
      if: inputs.install-dev-deps
      working-directory: ${{ inputs.working-directory }}
      run: |
        if [ -f "requirements-dev.txt" ]; then
          pip install -r requirements-dev.txt
        fi
        if [ -f "requirements.test.txt" ]; then
          pip install -r requirements.test.txt
        fi

    - name: Run tests
      if: inputs.run-tests
      id: run-tests
      working-directory: ${{ inputs.working-directory }}
      run: |
        ${{ inputs.test-command }}
        echo "coverage-path=coverage.xml" >> $GITHUB_OUTPUT
        echo "test-path=pytest-results.xml" >> $GITHUB_OUTPUT

    - name: Upload coverage reports
      if: inputs.run-tests && hashFiles('coverage.xml') != ''
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: coverage-report-${{ inputs.python-version }}
        path: coverage.xml
        retention-days: 30

    - name: Upload test results
      if: inputs.run-tests && (success() || failure())
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: test-results-${{ inputs.python-version }}
        path: |
          pytest-results.xml
          .pytest_cache
        retention-days: 7
