name: CI Pipeline (Reusable)

on:
  workflow_call:
    inputs:
      # Language Configuration
      language:
        description: Primary language (python, node, both)
        required: false
        type: string
        default: both
      python-versions:
        description: 'Python versions to test (JSON array, e.g., ["3.11", "3.12"])'
        required: false
        type: string
        default: '["3.12"]'
      node-versions:
        description: 'Node.js versions to test (JSON array, e.g., ["20", "22"])'
        required: false
        type: string
        default: '["20"]'

      # Dependency Configuration
      python-requirements-file:
        description: Path to Python requirements file
        required: false
        type: string
        default: requirements.txt
      python-dev-requirements-file:
        description: Path to Python dev requirements file
        required: false
        type: string
        default: requirements-dev.txt
      package-manager:
        description: Node.js package manager (npm, yarn, pnpm)
        required: false
        type: string
        default: npm

      # Linting & Formatting
      enable-linting:
        description: Enable linting step
        required: false
        type: boolean
        default: true
      python-lint-command:
        description: Python linting command
        required: false
        type: string
        default: ruff check . && ruff format --check .
      node-lint-command:
        description: Node.js linting command
        required: false
        type: string
        default: npm run lint

      # Type Checking
      enable-type-checking:
        description: Enable type checking step
        required: false
        type: boolean
        default: true
      python-typecheck-command:
        description: Python type checking command
        required: false
        type: string
        default: mypy src/
      node-typecheck-command:
        description: Node.js type checking command
        required: false
        type: string
        default: npm run typecheck

      # Testing
      enable-tests:
        description: Enable test step
        required: false
        type: boolean
        default: true
      python-test-command:
        description: Python test command
        required: false
        type: string
        default: pytest --cov=. --cov-report=xml --cov-report=html -v
      node-test-command:
        description: Node.js test command
        required: false
        type: string
        default: npm test -- --coverage
      coverage-threshold:
        description: Minimum coverage percentage required
        required: false
        type: number
        default: 0

      # Build
      enable-build:
        description: Enable build step
        required: false
        type: boolean
        default: false
      python-build-command:
        description: Python build command
        required: false
        type: string
        default: python -m build
      node-build-command:
        description: Node.js build command
        required: false
        type: string
        default: npm run build

      # Artifacts
      upload-artifacts:
        description: Upload build artifacts
        required: false
        type: boolean
        default: true
      artifact-retention-days:
        description: Days to retain artifacts
        required: false
        type: number
        default: 7

      # General
      working-directory:
        description: Working directory for commands
        required: false
        type: string
        default: .
      fail-fast:
        description: Fail fast on first error in matrix
        required: false
        type: boolean
        default: false

    outputs:
      python-coverage-report:
        description: Path to Python coverage report
        value: ${{ jobs.python-ci.outputs.coverage-path }}
      node-coverage-report:
        description: Path to Node.js coverage report
        value: ${{ jobs.node-ci.outputs.coverage-path }}
      build-artifact-id:
        description: ID of uploaded build artifact
        value: ${{ jobs.upload-artifacts.outputs.artifact-id }}

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Python CI Pipeline
  python-ci:
    if: inputs.language == 'python' || inputs.language == 'both'
    runs-on: ubuntu-latest
    outputs:
      coverage-path: ${{ steps.test.outputs.coverage-path }}

    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: Determine Python version
      id: python-version
      run: |
        MATRIX_VERSION="${{ matrix.python-version }}"
        REPO_VAR_VERSION="${{ vars.PYTHON_VERSION_DEFAULT }}"
        DEFAULT_VERSION="3.12"

        if [ -n "$MATRIX_VERSION" ]; then
          VERSION="$MATRIX_VERSION"
        elif [ -n "$REPO_VAR_VERSION" ]; then
          VERSION="$REPO_VAR_VERSION"
        else
          VERSION="$DEFAULT_VERSION"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Using Python version: $VERSION"

    - name: Set up Python ${{ steps.python-version.outputs.version }}
      uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # ratchet:actions/setup-python@v5
      with:
        python-version: ${{ steps.python-version.outputs.version }}
        cache: pip
        cache-dependency-path: |
          ${{ inputs.working-directory }}/${{ inputs.python-requirements-file }}
          ${{ inputs.working-directory }}/${{ inputs.python-dev-requirements-file }}

    - name: Install dependencies
      working-directory: ${{ inputs.working-directory }}
      run: |
        python -m pip install --upgrade pip wheel setuptools
        if [ -f "${{ inputs.python-requirements-file }}" ]; then
          pip install -r ${{ inputs.python-requirements-file }}
        fi
        if [ -f "${{ inputs.python-dev-requirements-file }}" ]; then
          pip install -r ${{ inputs.python-dev-requirements-file }}
        fi
        # Install package in editable mode if pyproject.toml exists
        if [ -f "pyproject.toml" ]; then
          pip install -e ".[dev]" 2>/dev/null || pip install -e . 2>/dev/null || true
        fi

    - name: Run linting
      if: inputs.enable-linting
      working-directory: ${{ inputs.working-directory }}
      run: ${{ inputs.python-lint-command }}

    - name: Run type checking
      if: inputs.enable-type-checking
      working-directory: ${{ inputs.working-directory }}
      run: ${{ inputs.python-typecheck-command }}
      continue-on-error: true

    - name: Run tests with coverage
      if: inputs.enable-tests
      id: test
      working-directory: ${{ inputs.working-directory }}
      run: |
        ${{ inputs.python-test-command }}
        echo "coverage-path=coverage.xml" >> $GITHUB_OUTPUT

    - name: Check coverage threshold
      if: inputs.enable-tests && inputs.coverage-threshold > 0
      working-directory: ${{ inputs.working-directory }}
      run: |
        if [ -f "coverage.xml" ]; then
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); print(float(tree.getroot().get('line-rate', 0)) * 100)")
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < ${{ inputs.coverage-threshold }}" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below threshold ${{ inputs.coverage-threshold }}%"
            exit 1
          fi
        fi

    - name: Build package
      if: inputs.enable-build
      working-directory: ${{ inputs.working-directory }}
      run: ${{ inputs.python-build-command }}

    - name: Upload coverage report
      if: inputs.enable-tests && inputs.upload-artifacts
      uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # ratchet:actions/upload-artifact@v4.5.0
      with:
        name: python-coverage-${{ matrix.python-version }}
        path: |
          ${{ inputs.working-directory }}/coverage.xml
          ${{ inputs.working-directory }}/htmlcov/
        retention-days: ${{ inputs.artifact-retention-days }}
        if-no-files-found: ignore

    - name: Upload build artifacts
      if: inputs.enable-build && inputs.upload-artifacts
      uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # ratchet:actions/upload-artifact@v4.5.0
      with:
        name: python-dist-${{ matrix.python-version }}
        path: ${{ inputs.working-directory }}/dist/
        retention-days: ${{ inputs.artifact-retention-days }}
        if-no-files-found: ignore

  # Node.js CI Pipeline
  node-ci:
    if: inputs.language == 'node' || inputs.language == 'both'
    runs-on: ubuntu-latest
    outputs:
      coverage-path: ${{ steps.test.outputs.coverage-path }}

    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix:
        node-version: ${{ fromJson(inputs.node-versions) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4.2.2
      with:
        fetch-depth: 0

    - name: Determine Node.js version
      id: node-version
      run: |
        MATRIX_VERSION="${{ matrix.node-version }}"
        REPO_VAR_VERSION="${{ vars.NODE_VERSION_DEFAULT }}"
        DEFAULT_VERSION="20"

        if [ -n "$MATRIX_VERSION" ]; then
          VERSION="$MATRIX_VERSION"
        elif [ -n "$REPO_VAR_VERSION" ]; then
          VERSION="$REPO_VAR_VERSION"
        else
          VERSION="$DEFAULT_VERSION"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Using Node.js version: $VERSION"

    - name: Setup Node.js ${{ steps.node-version.outputs.version }}
      uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # ratchet:actions/setup-node@v4
      with:
        node-version: ${{ steps.node-version.outputs.version }}
        cache: ${{ inputs.package-manager }}
        cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

    - name: Install dependencies
      working-directory: ${{ inputs.working-directory }}
      run: |
        case "${{ inputs.package-manager }}" in
          npm)
            npm ci
            ;;
          yarn)
            yarn install --frozen-lockfile
            ;;
          pnpm)
            corepack enable
            pnpm install --frozen-lockfile
            ;;
          *)
            echo "Unknown package manager: ${{ inputs.package-manager }}"
            exit 1
            ;;
        esac

    - name: Run linting
      if: inputs.enable-linting
      working-directory: ${{ inputs.working-directory }}
      run: ${{ inputs.node-lint-command }}
      continue-on-error: false

    - name: Run type checking
      if: inputs.enable-type-checking
      working-directory: ${{ inputs.working-directory }}
      run: ${{ inputs.node-typecheck-command }}
      continue-on-error: true

    - name: Run tests with coverage
      if: inputs.enable-tests
      id: test
      working-directory: ${{ inputs.working-directory }}
      run: |
        ${{ inputs.node-test-command }}
        echo "coverage-path=coverage/lcov.info" >> $GITHUB_OUTPUT

    - name: Build project
      if: inputs.enable-build
      working-directory: ${{ inputs.working-directory }}
      run: ${{ inputs.node-build-command }}

    - name: Upload coverage report
      if: inputs.enable-tests && inputs.upload-artifacts
      uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # ratchet:actions/upload-artifact@v4.5.0
      with:
        name: node-coverage-${{ matrix.node-version }}
        path: ${{ inputs.working-directory }}/coverage/
        retention-days: ${{ inputs.artifact-retention-days }}
        if-no-files-found: ignore

    - name: Upload build artifacts
      if: inputs.enable-build && inputs.upload-artifacts
      uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # ratchet:actions/upload-artifact@v4.5.0
      with:
        name: node-dist-${{ matrix.node-version }}
        path: ${{ inputs.working-directory }}/dist/
        retention-days: ${{ inputs.artifact-retention-days }}
        if-no-files-found: ignore

  # Aggregate artifacts from matrix builds
  upload-artifacts:
    needs: [python-ci, node-ci]
    if: |
      always() &&
      inputs.upload-artifacts &&
      (needs.python-ci.result == 'success' || needs.node-ci.result == 'success')
    runs-on: ubuntu-latest
    outputs:
      artifact-id: ${{ steps.merge.outputs.artifact-id }}

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # ratchet:actions/download-artifact@v4.1.8
      with:
        path: all-artifacts/

    - name: Merge artifacts
      id: merge
      uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b  # ratchet:actions/upload-artifact@v4.5.0
      with:
        name: ci-pipeline-artifacts
        path: all-artifacts/
        retention-days: ${{ inputs.artifact-retention-days }}
        if-no-files-found: ignore
