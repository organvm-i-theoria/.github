name: Process Task Queue

on:
  # DISABLED: Preventing notification spam after cleanup
  # schedule:
  #   - cron: 0 * * * * # Runs every hour
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # ratchet:actions/setup-python@v5.3.0
        with:
          python-version: 3.x
          cache: pip

      - name: Process queue
        run: |
          tasks_json=$(python scripts/quota_manager.py get_tasks)
          if [ -z "$tasks_json" ] || [ "$tasks_json" == "[]" ]; then
            echo "No tasks in the queue."
            exit 0
          fi

          echo "$tasks_json" | jq -c '.[]' | while read -r task; do
            subscription_name=$(echo "$task" | jq -r '.subscription')
            usage=$(python scripts/quota_manager.py get_usage "$subscription_name")
            quota=$(jq -r --arg name "$subscription_name" '.subscriptions[] | select(.name==$name) | .quota' .github/subscriptions.json)

            if (( $(echo "$usage < $quota" | bc -l) )); then
              echo "Processing task for subscription: $subscription_name"

              workflow_file=$(jq -r --arg name "$subscription_name" '.subscriptions[] | select(.name==$name) | .relevant_workflows[0]' .github/subscriptions.json)

              if [ -n "$workflow_file" ] && [ "$workflow_file" != "null" ]; then
                inputs=""
                if [ "$subscription_name" == "Jules_Agent" ]; then
                  issue_number=$(echo "$task" | jq -r '.issue_number')
                  pr_url=$(echo "$task" | jq -r '.pr_url')
                  if [ -n "$issue_number" ] && [ "$issue_number" != "null" ]; then
                    if [[ "$issue_number" =~ ^[0-9]+$ ]]; then
                      inputs=" -f issue_number=$issue_number"
                    else
                      echo "Invalid issue_number: $issue_number"
                    fi
                  elif [ -n "$pr_url" ] && [ "$pr_url" != "null" ]; then
                    pr_number=$(basename "$pr_url")
                    if [[ "$pr_number" =~ ^[0-9]+$ ]]; then
                      inputs=" -f pr_number=$pr_number"
                    else
                      echo "Invalid pr_number: $pr_number"
                    fi
                  fi
                fi
                gh workflow run "$workflow_file" --ref ${{ github.ref }}$inputs

                python scripts/quota_manager.py remove_task "$task"
              else
                echo "No relevant workflow found for subscription: $subscription_name"
              fi
            else
              echo "Quota limit reached for $subscription_name. Task will be processed later."
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit state changes
        if: always()
        run: |
          ./scripts/commit_changes.sh "chore: process task queue and update state"
