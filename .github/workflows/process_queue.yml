name: Process Task Queue

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Process queue
        run: |
          tasks_json=$(python scripts/token_manager.py get_tasks)
          if [ -z "$tasks_json" ] || [ "$tasks_json" == "[]" ]; then
            echo "No tasks in the queue."
            exit 0
          fi

          echo "$tasks_json" | jq -c '.[]' | while read -r task; do
            token_count=$(python scripts/token_manager.py get)
            if [ "$token_count" -lt 100 ]; then
              issue_number=$(echo "$task" | jq -r '.issue_number')
              pr_url=$(echo "$task" | jq -r '.pr_url')

              if [ -n "$issue_number" ] && [ "$issue_number" != "null" ]; then
                echo "Processing task for issue #$issue_number"
                gh workflow run claude.yml --ref ${{ github.ref }} -f "issue_number=$issue_number"
              elif [ -n "$pr_url" ] && [ "$pr_url" != "null" ]; then
                pr_number=$(basename "$pr_url")
                echo "Processing task for PR #$pr_number"
                gh workflow run claude.yml --ref ${{ github.ref }} -f "pr_number=$pr_number"
              fi

              python scripts/token_manager.py increment
              python scripts/token_manager.py remove_task "$task"
            else
              echo "Token limit reached. Remaining tasks will be processed in the next run."
              break
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
