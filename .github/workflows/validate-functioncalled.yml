name: Validate FUNCTIONcalled Metadata

on:
  pull_request:
    paths:
    - .github/workflows/**/*.meta.json
    - .github/standards/**/*.schema.json
    - .github/tools/functioncalled/**
  push:
    branches:
    - main
    paths:
    - .github/workflows/**/*.meta.json
  workflow_dispatch:
    inputs:
      build_registry:
        description: Build and commit updated registry
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-metadata:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: ${{ vars.PYTHON_VERSION_DEFAULT || '3.12' }}
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema

    - name: Find metadata files
      id: find-meta
      run: |
        # Find all metadata files
        META_FILES=$(find .github/workflows -name "*.meta.json" 2>/dev/null || true)

        if [ -z "$META_FILES" ]; then
          echo "No metadata sidecar files found"
          echo "has_metadata=false" >> $GITHUB_OUTPUT
        else
          echo "Found metadata files:"
          echo "$META_FILES"
          echo "has_metadata=true" >> $GITHUB_OUTPUT
          echo "$META_FILES" > /tmp/meta-files.txt
        fi

    - name: Validate metadata sidecars
      if: steps.find-meta.outputs.has_metadata == 'true'
      run: |
        # Run the validator
        python .github/tools/functioncalled/validate_workflow_meta.py \
          --schema .github/standards/FUNCTIONcalled_Workflow_Sidecar.schema.json \
          --scan-dir .github/workflows/

    - name: Check for orphan workflows (informational)
      run: |
        echo "## Workflow Metadata Coverage" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        TOTAL_WORKFLOWS=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
        WITH_META=$(find .github/workflows -name "*.meta.json" | wc -l)
        ORPHANS=$((TOTAL_WORKFLOWS - WITH_META))

        echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Total Workflows | $TOTAL_WORKFLOWS |" >> $GITHUB_STEP_SUMMARY
        echo "| With Metadata | $WITH_META |" >> $GITHUB_STEP_SUMMARY
        echo "| Without Metadata | $ORPHANS |" >> $GITHUB_STEP_SUMMARY

        COVERAGE=$((WITH_META * 100 / TOTAL_WORKFLOWS))
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY

  build-registry:
    needs: validate-metadata
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.build_registry)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: ${{ vars.PYTHON_VERSION_DEFAULT || '3.12' }}

    - name: Build workflow registry
      run: |
        python .github/tools/functioncalled/workflow-registry-builder.py \
          --root .github/workflows \
          --out .github/registry/workflow-registry.json \
          --include-orphans

    - name: Check for registry changes
      id: check-changes
      run: |
        if git diff --quiet .github/registry/workflow-registry.json 2>/dev/null; then
          echo "No registry changes"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Registry has changes"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit registry update
      if: steps.check-changes.outputs.has_changes == 'true' && github.event_name == 'push'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add .github/registry/workflow-registry.json
        git commit -m "chore: update workflow registry

        Auto-generated by validate-functioncalled workflow.

        Co-Authored-By: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

        git push

    - name: Upload registry artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # ratchet:actions/upload-artifact@v4
      with:
        name: workflow-registry
        path: .github/registry/workflow-registry.json
        retention-days: 30

    - name: Registry summary
      run: |
        echo "## Workflow Registry" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```json' >> $GITHUB_STEP_SUMMARY
        cat .github/registry/workflow-registry.json | jq '.statistics' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  enforce-new-workflows:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout PR
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # ratchet:actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check new workflows have metadata
      run: |
        # Get list of new workflow files in this PR
        NEW_WORKFLOWS=$(git diff --name-only --diff-filter=A origin/${{ github.base_ref }}...HEAD | \
          grep -E '\.github/workflows/.*\.(yml|yaml)$' | \
          grep -v '\.meta\.json$' || true)

        if [ -z "$NEW_WORKFLOWS" ]; then
          echo "No new workflows in this PR"
          exit 0
        fi

        echo "New workflows found:"
        echo "$NEW_WORKFLOWS"

        # Check if each new workflow has a metadata sidecar
        MISSING_META=""
        for workflow in $NEW_WORKFLOWS; do
          META_FILE="${workflow}.meta.json"
          if [ ! -f "$META_FILE" ]; then
            MISSING_META="$MISSING_META$workflow\n"
          fi
        done

        if [ -n "$MISSING_META" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ⚠️ New Workflows Missing Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following new workflows should have metadata sidecars:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo -e "$MISSING_META" | while read -r wf; do
            if [ -n "$wf" ]; then
              echo "- \`$wf\`" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [FUNCTIONcalled documentation](../VERSION_MANAGEMENT.md) for creating metadata sidecars." >> $GITHUB_STEP_SUMMARY

          # Warning only - don't fail the build
          echo "::warning::New workflows are missing metadata sidecars. Consider adding .meta.json files."
        fi
