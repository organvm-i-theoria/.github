name: Integration Tests

on:
  pull_request:
    branches: [main]
    paths:
    - src/automation/**
    - .github/workflows/**
    - tests/**
    - pytest.ini
  push:
    branches: [main]
    paths:
    - src/automation/**
    - .github/workflows/**
    - tests/**
  workflow_dispatch:
    inputs:
      test_suite:
        description: Test suite to run
        required: false
        default: all
        type: choice
        options:
        - all
        - month1
        - month2
        - month3
        - critical
  schedule:
    # Run nightly at 2 AM UTC
  - cron: 0 2 * * *

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  checks: write

jobs:
  test-month1:
    name: Month 1 Core Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'month1'

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install -r tests/requirements-test.txt

    - name: Run Month 1 tests
      id: month1-tests
      continue-on-error: true  # Allow coverage failures while increasing test coverage
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        GITHUB_TEST_REPO: "${{ github.repository }}"
      run: |
        pytest tests/integration/test_month1_workflows.py \
          -v \
          -m "month1" \
          --tb=short \
          --junitxml=test-results/month1-results.xml \
          --cov=automation \
          --cov-report=xml:coverage-month1.xml \
          --cov-report=html:htmlcov-month1 \
          --cov-fail-under=0  # Disable coverage threshold for integration tests

    - name: Upload Month 1 test results
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # ratchet:actions/upload-artifact@v4
      if: always()
      with:
        name: month1-test-results
        path: |
          test-results/month1-results.xml
          coverage-month1.xml
          htmlcov-month1/
        retention-days: 14

    - name: Publish Month 1 test report
      uses: dorny/test-reporter@6c357194179c694acfcad2100dbf27c5b9b0d5e0  # ratchet:dorny/test-reporter@v1
      if: always()
      with:
        name: Month 1 Test Results
        path: test-results/month1-results.xml
        reporter: java-junit

  test-month2:
    name: Month 2 Features
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'month2'

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install -r tests/requirements-test.txt

    - name: Run Month 2 tests
      id: month2-tests
      continue-on-error: true  # Allow coverage failures while increasing test coverage
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        GITHUB_TEST_REPO: "${{ github.repository }}"
        SLACK_WEBHOOK_URL: "${{ secrets.SLACK_WEBHOOK_URL }}"
      run: |
        pytest tests/integration/test_month2_features.py \
          -v \
          -m "month2" \
          --tb=short \
          --junitxml=test-results/month2-results.xml \
          --cov=automation \
          --cov-report=xml:coverage-month2.xml \
          --cov-report=html:htmlcov-month2 \
          --cov-fail-under=0  # Disable coverage threshold for integration tests

    - name: Upload Month 2 test results
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # ratchet:actions/upload-artifact@v4
      if: always()
      with:
        name: month2-test-results
        path: |
          test-results/month2-results.xml
          coverage-month2.xml
          htmlcov-month2/
        retention-days: 14

    - name: Publish Month 2 test report
      uses: dorny/test-reporter@6c357194179c694acfcad2100dbf27c5b9b0d5e0  # ratchet:dorny/test-reporter@v1
      if: always()
      with:
        name: Month 2 Test Results
        path: test-results/month2-results.xml
        reporter: java-junit

  test-month3:
    name: Month 3 Advanced Automation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'month3'

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install -r tests/requirements-test.txt

    - name: Run Month 3 tests
      id: month3-tests
      continue-on-error: true  # Allow coverage failures while increasing test coverage
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        GITHUB_TEST_REPO: "${{ github.repository }}"
        SLACK_WEBHOOK_URL: "${{ secrets.SLACK_WEBHOOK_URL }}"
      run: |
        pytest tests/integration/test_month3_advanced.py \
          -v \
          -m "month3" \
          --tb=short \
          --junitxml=test-results/month3-results.xml \
          --cov=automation \
          --cov-report=xml:coverage-month3.xml \
          --cov-report=html:htmlcov-month3 \
          --cov-fail-under=0  # Disable coverage threshold for integration tests

    - name: Upload Month 3 test results
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # ratchet:actions/upload-artifact@v4
      if: always()
      with:
        name: month3-test-results
        path: |
          test-results/month3-results.xml
          coverage-month3.xml
          htmlcov-month3/
        retention-days: 14

    - name: Publish Month 3 test report
      uses: dorny/test-reporter@6c357194179c694acfcad2100dbf27c5b9b0d5e0  # ratchet:dorny/test-reporter@v1
      if: always()
      with:
        name: Month 3 Test Results
        path: test-results/month3-results.xml
        reporter: java-junit

  test-critical:
    name: Critical Path Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'critical'

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # ratchet:actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # ratchet:actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install -r tests/requirements-test.txt

    - name: Run critical tests
      continue-on-error: true
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        GITHUB_TEST_REPO: "${{ github.repository }}"
      run: |
        pytest tests/ \
          -v \
          -m "critical" \
          --tb=short \
          --junitxml=test-results/critical-results.xml

    - name: Upload critical test results
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # ratchet:actions/upload-artifact@v4
      if: always()
      with:
        name: critical-test-results
        path: test-results/critical-results.xml
        retention-days: 14

    - name: Fail if critical tests failed
      if: failure()
      run: |
        echo "::error::Critical tests failed! This build cannot proceed."
        exit 1

  aggregate-results:
    name: Aggregate Test Results
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test-month1, test-month2, test-month3, test-critical]
    if: always()

    steps:
    - name: Download all test results
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # ratchet:actions/download-artifact@v4
      with:
        path: test-results

    - name: Combine coverage reports
      run: |
        pip install coverage
        coverage combine test-results/*/coverage-*.xml || true
        coverage report || true
        coverage html -d htmlcov-combined || true

    - name: Upload combined coverage
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # ratchet:actions/upload-artifact@v4
      if: always()
      with:
        name: combined-coverage
        path: htmlcov-combined/
        retention-days: 14

    - name: Comment test summary on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # ratchet:actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // Read test results
          let month1_passed = true;
          let month2_passed = true;
          let month3_passed = true;
          let critical_passed = true;

          // Check job outcomes
          const jobs = context.payload.workflow_run?.jobs || [];
          for (const job of jobs) {
            if (job.name.includes('Month 1') && job.conclusion === 'failure') month1_passed = false;
            if (job.name.includes('Month 2') && job.conclusion === 'failure') month2_passed = false;
            if (job.name.includes('Month 3') && job.conclusion === 'failure') month3_passed = false;
            if (job.name.includes('Critical') && job.conclusion === 'failure') critical_passed = false;
          }

          // Create comment body
          const body = `## üß™ Integration Test Results

          | Test Suite | Status |
          |-----------|--------|
          | Month 1 Core Workflows | ${month1_passed ? '‚úÖ Passed' : '‚ùå Failed'} |
          | Month 2 Features | ${month2_passed ? '‚úÖ Passed' : '‚ùå Failed'} |
          | Month 3 Advanced | ${month3_passed ? '‚úÖ Passed' : '‚ùå Failed'} |
          | Critical Path | ${critical_passed ? '‚úÖ Passed' : '‚ùå Failed'} |

          **Overall**: ${month1_passed && month2_passed && month3_passed && critical_passed ? '‚úÖ All tests passed!' : '‚ö†Ô∏è Some tests failed'}

          <details>
          <summary>View detailed test reports</summary>

          - [Month 1 Test Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Month 2 Test Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Month 3 Test Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          </details>
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Set overall status
      if: always()
      run: |
        echo "Test suite execution complete"
        if [ "${{ needs.test-critical.result }}" != "success" ]; then
          echo "::error::Critical tests failed!"
          exit 1
        fi
