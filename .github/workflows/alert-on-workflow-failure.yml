name: Alert on Workflow Failure

on:
  workflow_run:
    workflows: [generate-walkthrough, agentsphere-deployment, build-pages-site, generate-pages-index, deploy-to-pages-live, docker-build-push, collect-deployment-metadata]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

permissions:
  contents: read
  discussions: write

jobs:
  notify-failure:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
    - name: Send failure alert
      run: |
        echo "WORKFLOW FAILED: ${{ github.event.workflow_run.name }}"
        echo "Repo: ${{ github.event.workflow_run.repository.full_name }}"
        echo "Run: https://github.com/${{ github.event.workflow_run.repository.full_name }}/actions/runs/${{ github.event.workflow_run.id }}"

    - name: Post to GitHub Discussion
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea   # ratchet:actions/github-script@v7.0.1
      with:
        script: |
          github.rest.discussions.createDiscussionComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            discussion_number: 1,
            body: 'ðŸš¨ Workflow Failure Alert\n\nWorkflow: ${{ github.event.workflow_run.name }}\nRepo: ${{ github.event.workflow_run.head_repository.full_name }}\nRun: https://github.com/${{ github.event.workflow_run.repository.full_name }}/actions/runs/${{ github.event.workflow_run.id }}'
          })
