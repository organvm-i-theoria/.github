## 2024-05-23 - [Optimizing SSRF Checks with Caching]
**Learning:** In a high-volume crawler, repeated IP validation for the same hostname can be a CPU bottleneck. Caching the safety check (`_is_hostname_safe`) is effective, BUT it is critical that the underlying DNS resolution (`_resolve_hostname`) is ALSO cached and that both methods use the same cache or the same data source. If `_resolve_hostname` is not cached or if the cache is bypassed, a race condition (DNS Rebinding) could occur where the IP checked is different from the IP used.
**Action:** When caching security checks that depend on external state (like DNS), ensure the state itself is also cached or pinned for the duration of the operation to prevent TOCTOU vulnerabilities. In this case, `_resolve_hostname` was already cached, making the optimization safe.