<!-- Live App Embed Component -->
<!-- Handles different deployment strategies and provides fallbacks -->

{% assign live_url = include.live_url %}
{% assign deployment_strategy = include.deployment_strategy %}
{% assign app_name = include.app_name %}

<div class="live-app-embed" style="position: relative; width: 100%; height: 100%; min-height: 600px;">
  {% if deployment_strategy == 'pages_direct' %}
    <!-- Strategy A: Direct GitHub Pages embed -->
    <div class="iframe-container" style="position: relative; width: 100%; height: 100%; min-height: 600px;">
      <div class="loading-overlay" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: var(--surface); z-index: 10;">
        <div>
          <div class="spinner" style="margin: 0 auto 1rem;"></div>
          <p style="color: var(--text-secondary);">Loading application...</p>
        </div>
      </div>
      
      <iframe 
        id="app-frame"
        src="{{ live_url }}"
        style="width: 100%; height: 100%; border: none; min-height: 600px;"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
        loading="lazy"
        onload="hideLoadingOverlay()"
        onerror="showErrorState('pages_direct')"
      ></iframe>
    </div>
    
  {% elsif deployment_strategy == 'docker' %}
    <!-- Strategy B: Docker container embed -->
    <div class="docker-embed" style="padding: 2rem; text-align: center;">
      <div style="max-width: 600px; margin: 0 auto;">
        <svg style="width: 80px; height: 80px; margin: 0 auto 2rem; fill: #2496ed;" viewBox="0 0 24 24">
          <path d="M13.983 11.078h2.119a.186.186 0 00.186-.185V9.006a.186.186 0 00-.186-.186h-2.119a.185.185 0 00-.185.185v1.888c0 .102.083.185.185.185m-2.954-5.43h2.118a.186.186 0 00.186-.186V3.574a.186.186 0 00-.186-.185h-2.118a.185.185 0 00-.185.185v1.888c0 .102.082.185.185.185m0 2.716h2.118a.187.187 0 00.186-.186V6.29a.186.186 0 00-.186-.185h-2.118a.185.185 0 00-.185.185v1.887c0 .102.082.185.185.186m-2.93 0h2.12a.186.186 0 00.184-.186V6.29a.185.185 0 00-.185-.185H8.1a.185.185 0 00-.185.185v1.887c0 .102.083.185.185.186m-2.964 0h2.119a.186.186 0 00.185-.186V6.29a.185.185 0 00-.185-.185H5.136a.186.186 0 00-.186.185v1.887c0 .102.084.185.186.186m5.893 2.715h2.118a.186.186 0 00.186-.185V9.006a.186.186 0 00-.186-.186h-2.118a.185.185 0 00-.185.185v1.888c0 .102.082.185.185.185m-2.93 0h2.12a.185.185 0 00.184-.185V9.006a.185.185 0 00-.184-.186h-2.12a.185.185 0 00-.184.185v1.888c0 .102.083.185.185.185m-2.964 0h2.119a.185.185 0 00.185-.185V9.006a.185.185 0 00-.184-.186h-2.12a.186.186 0 00-.186.186v1.887c0 .102.084.185.186.185m-2.92 0h2.12a.185.185 0 00.184-.185V9.006a.185.185 0 00-.184-.186h-2.12a.185.185 0 00-.184.185v1.888c0 .102.082.185.185.185M23.763 9.89c-.065-.051-.672-.51-1.954-.51-.338 0-.676.03-1.01.09-.037-1.974-1.99-2.977-2.1-3.019l-.424-.193-.27.395c-.335.49-.568 1.08-.656 1.692-.11.752.024 1.462.395 2.05-.272.137-.979.402-1.785.406H.848l-.084.591c-.112.938-.065 3.856 1.753 6.102 1.448 1.799 3.592 2.717 6.375 2.717 6.16 0 10.716-2.84 12.875-8.016.807.037 2.567 0 3.456-1.714.025-.049.093-.172.307-.527l.081-.103-.296-.19z"/>
        </svg>
        
        <h3 style="margin-bottom: 1rem;">Docker Container Available</h3>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
          This application runs in a Docker container. Run it locally with:
        </p>
        
        <div style="background: #1e293b; color: #e2e8f0; padding: 1.5rem; border-radius: 0.5rem; text-align: left; font-family: monospace; font-size: 0.875rem; margin-bottom: 2rem;">
          <div style="margin-bottom: 1rem;">
            <span style="color: #94a3b8;"># Pull the image</span><br>
            docker pull {{ include.docker_image }}
          </div>
          <div>
            <span style="color: #94a3b8;"># Run the container</span><br>
            docker run -d -p {{ include.port }}:{{ include.port }} {{ include.docker_image }}
          </div>
        </div>
        
        <button onclick="copyDockerCommand()" class="btn">
          üìã Copy Docker Command
        </button>
      </div>
    </div>
    
  {% elsif deployment_strategy == 'codespaces' %}
    <!-- Strategy C: GitHub Codespaces -->
    <div class="codespaces-embed" style="padding: 2rem; text-align: center;">
      <div style="max-width: 600px; margin: 0 auto;">
        <svg style="width: 80px; height: 80px; margin: 0 auto 2rem;" fill="currentColor" viewBox="0 0 24 24">
          <path d="M3 3h18a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m0 2v14h18V5H3m2 2h14v2H5V7m0 4h8v2H5v-2m0 4h10v2H5v-2z"/>
        </svg>
        
        <h3 style="margin-bottom: 1rem;">Open in GitHub Codespaces</h3>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
          This application uses GitHub Codespaces for a complete development environment.
          Click below to launch it in your browser.
        </p>
        
        <a href="{{ include.codespaces_url }}" class="btn" target="_blank" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #24292f;">
          <svg style="width: 20px; height: 20px; fill: currentColor;" viewBox="0 0 16 16">
            <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13Z"/>
          </svg>
          Open in Codespaces
        </a>
        
        <p style="margin-top: 2rem; color: var(--text-secondary); font-size: 0.875rem;">
          You'll need a GitHub account with Codespaces access
        </p>
      </div>
    </div>
    
  {% elsif deployment_strategy == 'none' %}
    <!-- Strategy D: CLI/Library - No live demo -->
    <div class="no-demo" style="padding: 2rem; text-align: center;">
      <div style="max-width: 600px; margin: 0 auto;">
        <div style="font-size: 5rem; margin-bottom: 1rem;">üì¶</div>
        
        <h3 style="margin-bottom: 1rem;">CLI Tool or Library</h3>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">
          This application is a command-line tool or library and doesn't have a web interface.
          Check the source code and documentation to learn how to use it.
        </p>
        
        {% if include.source_url %}
        <a href="{{ include.source_url }}" class="btn" target="_blank">
          View Documentation
        </a>
        {% endif %}
      </div>
    </div>
    
  {% else %}
    <!-- Fallback: Try AgentSphere demo if available -->
    <div class="fallback-embed">
      {% if include.agentsphere_url %}
        <div class="iframe-container" style="position: relative; width: 100%; height: 100%; min-height: 600px;">
          <div class="loading-overlay" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: var(--surface); z-index: 10;">
            <div>
              <div class="spinner" style="margin: 0 auto 1rem;"></div>
              <p style="color: var(--text-secondary);">Loading AgentSphere demo...</p>
            </div>
          </div>
          
          <iframe 
            src="{{ include.agentsphere_url }}"
            style="width: 100%; height: 100%; border: none; min-height: 600px;"
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
            loading="lazy"
            onload="hideLoadingOverlay()"
            onerror="showErrorState('agentsphere')"
          ></iframe>
        </div>
      {% else %}
        <div style="padding: 3rem; text-align: center;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
          <h3 style="margin-bottom: 1rem;">No Live Demo Available</h3>
          <p style="color: var(--text-secondary);">
            A live demo is not currently available for this application.
          </p>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

<!-- Error State Template (hidden by default) -->
<div id="error-state" style="display: none; padding: 3rem; text-align: center;">
  <div style="font-size: 4rem; margin-bottom: 1rem;">‚ùå</div>
  <h3 style="margin-bottom: 1rem;">Failed to Load Application</h3>
  <p style="color: var(--text-secondary); margin-bottom: 2rem;">
    The application could not be loaded. This might be due to:
  </p>
  <ul style="text-align: left; max-width: 500px; margin: 0 auto 2rem; color: var(--text-secondary);">
    <li>The application is currently offline</li>
    <li>Network connectivity issues</li>
    <li>The deployment is being updated</li>
  </ul>
  <button onclick="location.reload()" class="btn">
    üîÑ Try Again
  </button>
</div>

<style>
  .live-app-embed iframe {
    display: block;
  }
  
  /* Auto-height iframe adjustment */
  .iframe-container iframe {
    height: auto;
    min-height: 600px;
  }
  
  /* Responsive iframe */
  @media (max-width: 768px) {
    .live-app-embed,
    .iframe-container,
    .iframe-container iframe {
      min-height: 400px !important;
    }
  }
</style>

<script>
  function hideLoadingOverlay() {
    const overlay = document.querySelector('.loading-overlay');
    if (overlay) {
      overlay.style.opacity = '0';
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300);
    }
  }
  
  function showErrorState(source) {
    console.error('Failed to load app from:', source);
    const container = document.querySelector('.live-app-embed');
    const errorState = document.getElementById('error-state');
    
    if (container && errorState) {
      container.innerHTML = errorState.innerHTML;
      errorState.style.display = 'block';
    }
  }
  
  // Iframe communication for auto-height
  window.addEventListener('message', function(e) {
    if (e.data.type === 'resize') {
      const iframe = document.getElementById('app-frame');
      if (iframe && e.data.height) {
        iframe.style.height = e.data.height + 'px';
      }
    }
  });
  
  // Timeout for loading
  setTimeout(() => {
    const overlay = document.querySelector('.loading-overlay');
    if (overlay && overlay.style.display !== 'none') {
      console.warn('Loading timeout - showing error state');
      showErrorState('timeout');
    }
  }, 30000); // 30 second timeout
</script>
