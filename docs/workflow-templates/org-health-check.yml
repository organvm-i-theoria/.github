name: Organization Health Check

# This workflow template can be used in any repository to enable
# organization-wide workflow dispatching
#
# The org-wide-workflow-dispatch.yml in the .github repository can
# trigger this workflow across all repositories that have it.

on:
  # Enable manual triggering from UI
  workflow_dispatch:
    inputs:
      check_type:
        description: Type of health check to run
        required: false
        type: choice
        options:
        - full
        - quick
        - security
        default: quick

      notify_on_completion:
        description: Send notifications on completion
        required: false
        type: boolean
        default: false

      severity_threshold:
        description: Minimum severity level to report
        required: false
        type: choice
        options:
        - critical
        - high
        - medium
        - low
        default: medium

  # Optional: Enable other triggers as needed
  schedule:
    # Run weekly on Monday at 2 AM UTC
  - cron: 0 2 * * 1

  push:
    branches:
    - main
    paths:
    - .github/workflows/org-health-check.yml

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  health-check:
    name: Repository Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683   # v4.2.2
      with:
        fetch-depth: 0   # Full history for comprehensive checks

    - name: Display workflow inputs
      run: |
        echo "## ðŸ” Health Check Configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Check Type:** ${{ github.event.inputs.check_type || 'scheduled' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Severity Threshold:** ${{ github.event.inputs.severity_threshold || 'medium' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

    - name: Check for README
      id: check-readme
      run: |
        if [ -f "README.md" ]; then
          echo "status=âœ…" >> $GITHUB_OUTPUT
          echo "message=README.md exists" >> $GITHUB_OUTPUT
        else
          echo "status=âŒ" >> $GITHUB_OUTPUT
          echo "message=README.md is missing" >> $GITHUB_OUTPUT
          echo "severity=high" >> $GITHUB_OUTPUT
        fi

    - name: Check for LICENSE
      id: check-license
      run: |
        if [ -f "LICENSE" ] || [ -f "LICENSE.md" ] || [ -f "LICENSE.txt" ]; then
          echo "status=âœ…" >> $GITHUB_OUTPUT
          echo "message=License file exists" >> $GITHUB_OUTPUT
        else
          echo "status=âš ï¸" >> $GITHUB_OUTPUT
          echo "message=License file is missing" >> $GITHUB_OUTPUT
          echo "severity=medium" >> $GITHUB_OUTPUT
        fi

    - name: Check for CONTRIBUTING guidelines
      id: check-contributing
      run: |
        if [ -f "CONTRIBUTING.md" ] || [ -f ".github/CONTRIBUTING.md" ]; then
          echo "status=âœ…" >> $GITHUB_OUTPUT
          echo "message=Contributing guidelines exist" >> $GITHUB_OUTPUT
        else
          echo "status=â„¹ï¸" >> $GITHUB_OUTPUT
          echo "message=Contributing guidelines not found" >> $GITHUB_OUTPUT
          echo "severity=low" >> $GITHUB_OUTPUT
        fi

    - name: Check for CI/CD workflows
      id: check-workflows
      run: |
        if [ -d ".github/workflows" ] && [ "$(ls -A .github/workflows)" ]; then
          WORKFLOW_COUNT=$(ls -1 .github/workflows/*.yml 2>/dev/null | wc -l)
          echo "status=âœ…" >> $GITHUB_OUTPUT
          echo "message=Found ${WORKFLOW_COUNT} workflow(s)" >> $GITHUB_OUTPUT
          echo "count=${WORKFLOW_COUNT}" >> $GITHUB_OUTPUT
        else
          echo "status=âš ï¸" >> $GITHUB_OUTPUT
          echo "message=No CI/CD workflows found" >> $GITHUB_OUTPUT
          echo "severity=medium" >> $GITHUB_OUTPUT
          echo "count=0" >> $GITHUB_OUTPUT
        fi

    - name: Check for security policy
      id: check-security
      run: |
        if [ -f "SECURITY.md" ] || [ -f ".github/SECURITY.md" ]; then
          echo "status=âœ…" >> $GITHUB_OUTPUT
          echo "message=Security policy exists" >> $GITHUB_OUTPUT
        else
          echo "status=âš ï¸" >> $GITHUB_OUTPUT
          echo "message=Security policy not found" >> $GITHUB_OUTPUT
          echo "severity=medium" >> $GITHUB_OUTPUT
        fi

    - name: Check for code of conduct
      id: check-coc
      run: |
        if [ -f "CODE_OF_CONDUCT.md" ] || [ -f ".github/CODE_OF_CONDUCT.md" ]; then
          echo "status=âœ…" >> $GITHUB_OUTPUT
          echo "message=Code of Conduct exists" >> $GITHUB_OUTPUT
        else
          echo "status=â„¹ï¸" >> $GITHUB_OUTPUT
          echo "message=Code of Conduct not found" >> $GITHUB_OUTPUT
          echo "severity=low" >> $GITHUB_OUTPUT
        fi

    - name: Check for dependabot configuration
      id: check-dependabot
      run: |
        if [ -f ".github/dependabot.yml" ]; then
          echo "status=âœ…" >> $GITHUB_OUTPUT
          echo "message=Dependabot configured" >> $GITHUB_OUTPUT
        else
          echo "status=â„¹ï¸" >> $GITHUB_OUTPUT
          echo "message=Dependabot not configured" >> $GITHUB_OUTPUT
          echo "severity=low" >> $GITHUB_OUTPUT
        fi

    - name: Check branch protection
      id: check-branch-protection
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        RESPONSE=$(gh api \
          /repos/${{ github.repository }}/branches/${{ github.event.repository.default_branch }}/protection \
          2>&1 || echo "not-protected")

        if echo "$RESPONSE" | grep -q "not-protected\|404"; then
          echo "status=âš ï¸" >> $GITHUB_OUTPUT
          echo "message=Default branch is not protected" >> $GITHUB_OUTPUT
          echo "severity=high" >> $GITHUB_OUTPUT
        else
          echo "status=âœ…" >> $GITHUB_OUTPUT
          echo "message=Default branch is protected" >> $GITHUB_OUTPUT
        fi

    - name: Generate health report
      run: |
        cat << 'EOF' >> $GITHUB_STEP_SUMMARY
        ## ðŸ“Š Repository Health Report

        **Repository:** ${{ github.repository }}
        **Check Type:** ${{ github.event.inputs.check_type || 'scheduled' }}
        **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

        ### Results

        | Check | Status | Details |
        |-------|--------|---------|
        | README | ${{ steps.check-readme.outputs.status }} | ${{ steps.check-readme.outputs.message }} |
        | License | ${{ steps.check-license.outputs.status }} | ${{ steps.check-license.outputs.message }} |
        | Contributing | ${{ steps.check-contributing.outputs.status }} | ${{ steps.check-contributing.outputs.message }} |
        | CI/CD Workflows | ${{ steps.check-workflows.outputs.status }} | ${{ steps.check-workflows.outputs.message }} |
        | Security Policy | ${{ steps.check-security.outputs.status }} | ${{ steps.check-security.outputs.message }} |
        | Code of Conduct | ${{ steps.check-coc.outputs.status }} | ${{ steps.check-coc.outputs.message }} |
        | Dependabot | ${{ steps.check-dependabot.outputs.status }} | ${{ steps.check-dependabot.outputs.message }} |
        | Branch Protection | ${{ steps.check-branch-protection.outputs.status }} | ${{ steps.check-branch-protection.outputs.message }} |

        ### Legend

        - âœ… Passed
        - âš ï¸ Warning
        - âŒ Failed
        - â„¹ï¸ Informational
        EOF

    - name: Create issue for critical findings
      if: |
        always() &&
        github.event.inputs.notify_on_completion == 'true' &&
        (steps.check-readme.outputs.severity == 'critical' ||
         steps.check-branch-protection.outputs.severity == 'high')
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea   # v7.0.1
      with:
        script: |
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'health-check',
            per_page: 1
          });

          const findings = [];

          if ('${{ steps.check-readme.outputs.severity }}' === 'critical') {
            findings.push('- âŒ **README.md is missing** (Critical)');
          }

          if ('${{ steps.check-branch-protection.outputs.severity }}' === 'high') {
            findings.push('- âš ï¸ **Default branch is not protected** (High)');
          }

          if (findings.length === 0) {
            console.log('No critical findings to report');
            return;
          }

          const body = `## ðŸš¨ Repository Health Check Findings

          This issue was automatically created by the organization health check workflow.

          **Generated:** ${new Date().toISOString()}

          ### Critical Issues

          ${findings.join('\n')}

          ### Recommended Actions

          1. Review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details
          2. Address critical and high-severity findings
          3. Re-run the health check to verify fixes

          ---

          *This issue will be automatically closed when all critical issues are resolved.*
          `;

          if (issues.data.length > 0) {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: `### Updated Findings (${new Date().toISOString().split('T')[0]})\n\n${body}`
            });
            console.log(`Updated existing issue #${issues.data[0].number}`);
          } else {
            // Create new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Repository Health Check: Critical Issues Found',
              body: body,
              labels: ['health-check', 'automated', 'priority: high']
            });
            console.log(`Created new issue #${issue.data.number}`);
          }

    - name: Export health metrics
      id: export-metrics
      run: |
        mkdir -p health-reports

        cat << EOF > health-reports/health-check-$(date +%Y%m%d-%H%M%S).json
        {
          "repository": ${{ github.repository }},
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "check_type": ${{ github.event.inputs.check_type || 'scheduled' }},
          "checks": {
            "readme": {
              "status": ${{ steps.check-readme.outputs.status }},
              "severity": ${{ steps.check-readme.outputs.severity || 'none' }}
            },
            "license": {
              "status": ${{ steps.check-license.outputs.status }},
              "severity": ${{ steps.check-license.outputs.severity || 'none' }}
            },
            "contributing": {
              "status": ${{ steps.check-contributing.outputs.status }},
              "severity": ${{ steps.check-contributing.outputs.severity || 'none' }}
            },
            "workflows": {
              "status": ${{ steps.check-workflows.outputs.status }},
              "count": ${{ steps.check-workflows.outputs.count || 0 }},
              "severity": ${{ steps.check-workflows.outputs.severity || 'none' }}
            },
            "security": {
              "status": ${{ steps.check-security.outputs.status }},
              "severity": ${{ steps.check-security.outputs.severity || 'none' }}
            },
            "code_of_conduct": {
              "status": ${{ steps.check-coc.outputs.status }},
              "severity": ${{ steps.check-coc.outputs.severity || 'none' }}
            },
            "dependabot": {
              "status": ${{ steps.check-dependabot.outputs.status }},
              "severity": ${{ steps.check-dependabot.outputs.severity || 'none' }}
            },
            "branch_protection": {
              "status": ${{ steps.check-branch-protection.outputs.status }},
              "severity": ${{ steps.check-branch-protection.outputs.severity || 'none' }}
            }
          }
        }
        EOF

    - name: Upload health report
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882   # v4.5.0
      with:
        name: health-report-${{ github.run_number }}
        path: health-reports/
        retention-days: 30
